# Milestone v1.0: MVP - 印刷施工单任务即时分派系统

**Status:** ✅ SHIPPED 2026-02-02
**Phases:** 1-10
**Total Plans:** 32

## Overview

Transform the printing work order system from reactive task generation (on process start) to proactive task generation (on work order creation). The journey begins with core draft task management and approval workflows, builds intelligent dispatch with priority configuration, delivers role-based task management interfaces, enhances with real-time notifications, and concludes with performance hardening and production readiness.

**Core Value:** 创建即分派，审核即开工 - 施工单一经创建即可预览所有任务，审核通过后任务立即可用

## Phases

### Phase 1: Draft Task Foundation

**Goal**: Enable immediate task generation when work orders are created, with draft-to-formal conversion on approval

**Depends on**: Nothing (first phase)

**Requirements**: TASK-01, TASK-02, TASK-05, TASK-06, PERF-01, CONS-03, CONS-04

**Success Criteria**:
1. User creates a work order and immediately sees all generated tasks in draft status
2. Draft tasks display visual indicators distinguishing them from formal tasks
3. User approves a work order and all draft tasks automatically convert to formal status
4. User rejects a work order and all draft tasks are automatically deleted
5. Batch task creation completes in under 2 seconds for 100-task work orders

**Plans**: 3 plans

**Status**: ✓ Complete (2026-01-30)

Plans:

- [x] 01-01-PLAN.md — Add draft status field and update task model with draft constraints (Wave 1)
- [x] 01-02-PLAN.md — Implement draft task generation service with bulk_create optimization (Wave 1)
- [x] 01-03-PLAN.md — Build approval workflow with draft-to-formal conversion and cascade deletion (Wave 2)

**Details:**

Phase 1 established the foundation for the entire task dispatch system:

1. **Draft Status Model**: Added `status='draft'` to WorkOrderTask model, distinguished from 'pending' formal tasks
2. **Draft Task Generation**: DraftTaskGenerationService creates tasks immediately on work order creation using bulk_create with batch_size=100 for performance
3. **Approval Workflow**: WorkOrderApprovalLog integration triggers draft-to-formal conversion with proper transaction handling
4. **Cascade Deletion**: Orphan checks verify no draft tasks remain after rejection

### Phase 2: Task Data Consistency

**Goal**: Maintain synchronization between work order processes and generated tasks throughout edits

**Depends on**: Phase 1

**Requirements**: TASK-03, TASK-04, CONS-02

**Success Criteria**:
1. User modifies work order processes and receives prompt to update existing tasks
2. System adds new tasks for added processes and removes tasks for deleted processes
3. User can bulk edit draft tasks (quantity, priority, notes) in a single operation
4. User can bulk delete unwanted draft tasks before work order approval
5. Process changes never leave orphaned or duplicate tasks

**Plans**: 3 plans

**Status**: ✓ Complete (2026-01-31)

Plans:

- [x] 02-01-PLAN.md — Build differential update algorithm to sync tasks with process changes (Wave 1)
- [x] 02-02-PLAN.md — Implement bulk edit and bulk delete operations for draft tasks (Wave 1)
- [x] 02-03-PLAN.md — Add frontend sync integration (API methods, prompt dialog, workflow) (Wave 2)

**Details:**

Phase 2 ensures tasks stay synchronized when work orders change:

1. **Differential Sync Algorithm**: TaskSyncService uses set operations for O(1) difference calculation, preview-confirm pattern prevents accidental data loss
2. **Bulk Operations**: DraftTaskBulkSerializer supports batch validation and bulk_update with batch_size=100
3. **Frontend Integration**: Automatic sync check after process changes with two-step prompting (confirm dialog + preview)

### Phase 3: Dispatch Configuration

**Goal**: Provide configurable priority-based department assignment rules

**Depends on**: Phase 1

**Requirements**: DISP-01, DISP-02, DISP-06, CFG-01, CFG-02, CFG-03, CFG-04

**Success Criteria**:
1. Administrator accesses configuration page showing all process-department mappings
2. Administrator sets priority order for departments assigned to each process
3. System automatically dispatches tasks to highest-priority department when work order is approved
4. Administrator enables/disables dispatch rules for specific processes
5. Configuration preview shows which department will receive tasks for each process

**Plans**: 3 plans

**Status**: ✓ Complete (2026-01-31)

Plans:

- [x] 03-01-PLAN.md — Build dispatch preview service and dual-column configuration UI with drag-and-drop (Wave 1)
- [x] 03-02-PLAN.md — Implement auto-dispatch service with priority-based selection and global toggle (Wave 2)
- [x] 03-03-PLAN.md — Add workload balancing strategy (least-tasks department selection) (Wave 3)

**Details:**

Phase 3 delivers the configuration interface and auto-dispatch logic:

1. **Dispatch Preview**: Dual-column UI with ProcessList and DepartmentPriorityPanel, preview shows effects before applying
2. **Auto-Dispatch Service**: Global toggle controls dispatch, priority-based selection iterates through ordered departments
3. **Load Balancing**: LoadBalancingService calculates department load, selects least-loaded department among equal-priority options

### Phase 4: Task Assignment Core

**Goal**: Enable manual supervisor assignment and operator self-claiming with concurrency control

**Depends on**: Phase 3

**Requirements**: DISP-03, DISP-04, DISP-05, CONS-01

**Success Criteria**:
1. Department supervisor assigns task to specific operator from their department
2. Operator claims unassigned task and becomes the assigned operator
3. System prevents two operators from simultaneously claiming the same task
4. Task can only be assigned to one operator at a time
5. Assignment fails gracefully with clear error message if operator already has maximum tasks

**Plans**: 3 plans

**Status**: ✓ Complete (2026-01-31)

Plans:

- [x] 04-01-PLAN.md — Implement supervisor assignment API with permission validation (Wave 1)
- [x] 04-02-PLAN.md — Build operator self-claiming API with optimistic locking (select_for_update) (Wave 2)
- [x] 04-03-PLAN.md — Add concurrency conflict detection and user-friendly error handling (Wave 3)

**Details:**

Phase 4 implements the core assignment mechanisms:

1. **Supervisor Assignment**: TaskAssignmentService.validate_operator_task_capacity enforces 10-task limit, permission hierarchy (superuser > creator > supervisor)
2. **Operator Self-Claiming**: select_for_update prevents race conditions, idempotent operation returns already_claimed=True when claiming own task
3. **Concurrency Control**: TaskConflictError with 409 HTTP status, error response enrichment with current_owner and retry suggestion

### Phase 5: Universal Task Visibility

**Goal**: Provide comprehensive task listing with filtering, search, and batch operations

**Depends on**: Phase 4

**Requirements**: VIS-01, VIS-02, VIS-03, VIS-04, VIS-05, PAGE-01, PAGE-02, PAGE-03, PAGE-04, PAGE-05, AUTH-01, PERF-03, PERF-05

**Success Criteria**:
1. User accesses task management page and sees all tasks they're permitted to view
2. User filters tasks by department, status, assignee, and priority
3. User searches tasks by task number, work order number, or content description
4. User performs bulk operations (assign, delete, status change) on selected tasks
5. Task list renders smoothly with 100+ tasks using virtual scrolling

**Plans**: 6 plans

**Status**: ✓ Complete (2026-01-31)

Plans:

- [x] 05-01-PLAN.md — Build task list API with filtering, search, and permission-based querysets (Wave 1)
- [x] 05-02-PLAN.md — Create TaskList.vue component with virtual scrolling and bulk selection (Wave 2)
- [x] 05-03-PLAN.md — Implement batch operation APIs (bulk assign, bulk delete, bulk status update) (Wave 2)
- [x] 05-04-PLAN.md — Add task export functionality with filtered data (Wave 3)
- [x] 05-05-PLAN.md — Priority filter integration (Wave 3)
- [x] 05-06-PLAN.md — Virtual scroll performance optimization (Wave 3)

**Details:**

Phase 5 delivers the universal task visibility interface:

1. **Enhanced Task List API**: Added related field serialization, department_name/operator_name computed fields, is_draft computed field
2. **Virtual Scrolling**: Element UI virtual scroll component for smooth 100+ task rendering
3. **Batch Operations**: batchAssign, batchComplete, batchCancel, batchDelete API methods with partial success/failure

### Phase 6: Work Order Task Integration

**Goal**: Embed task management directly into work order creation and editing pages

**Depends on**: Phase 1

**Requirements**: WO-01, WO-02, WO-03, WO-04, WO-05, AUTH-04

**Success Criteria**:
1. User creates work order and sees all generated tasks in dedicated task section
2. User edits draft tasks directly from work order page without leaving
3. Work order page shows real-time task count and assignment status
4. User manually adds extra tasks beyond auto-generated ones
5. Makers and sales staff can edit draft tasks, other roles cannot

**Plans**: 3 plans

**Status**: ✓ Complete (2026-01-31)

Plans:

- [x] 06-01-PLAN.md — Integrate task display section into work order create/edit forms
- [x] 06-02-PLAN.md — Add inline task editing controls for draft tasks
- [x] 06-03-PLAN.md — Implement task statistics display and manual task addition

**Details:**

Phase 6 integrates task management into the core work order workflow:

1. **TaskSection.vue**: Props-based component (workOrderId, tasks, editable, loading) integrated after materials section
2. **Role-based Permissions**: Only makers/sales staff with workorder.change_workorder can edit draft tasks
3. **Statistics Display**: Progress percentage, assignment status with color-coded tags

### Phase 7: Role-Based Task Centers

**Goal**: Deliver specialized interfaces for supervisors and operators

**Depends on**: Phase 5

**Requirements**: SUP-01, SUP-02, SUP-03, SUP-04, SUP-05, OP-01, OP-02, OP-03, OP-04, OP-05, AUTH-02, AUTH-03

**Success Criteria**:
1. Department supervisor views dashboard showing all department tasks and operator workloads
2. Supervisor drags and drops tasks to assign them to operators
3. Supervisor sees workload statistics for each operator (task count, completion rate)
4. Operator views personalized task center showing assigned and claimable tasks
5. Operator updates task progress and completion quantities directly

**Plans**: 4 plans

**Status**: ✓ Complete (2026-01-31)

Plans:

- [x] 07-01-PLAN.md — Build supervisor dashboard with department task view and workload statistics (Wave 1)
- [x] 07-02-PLAN.md — Implement drag-and-drop task assignment interface (Wave 2)
- [x] 07-03-PLAN.md — Create operator task center with assigned and claimable task pools (Wave 1)
- [x] 07-04-PLAN.md — Add operator task progress update and completion tracking (Wave 2)

**Details:**

Phase 7 delivers specialized interfaces for different user roles:

1. **SupervisorDashboard.vue**: Department workload API returns summary + operator breakdown, circular progress SVG component
2. **TaskDragDropList.vue**: vuedraggable for drag-drop assignment, priority-colored task borders, confirmation dialogs
3. **OperatorCenter.vue**: Two-pool layout (My Tasks | Claimable Tasks), role-based access control
4. **OperatorTaskUpdateDialog.vue**: Increment mode (partial updates) + complete mode, version-based concurrency control

### Phase 8: Real-time Notifications

**Goal**: Deliver instant task event notifications via WebSocket

**Depends on**: Phase 7

**Requirements**: NOTIF-01, NOTIF-02, NOTIF-03, NOTIF-04

**Success Criteria**:
1. Operator receives browser notification when task is assigned to them
2. Supervisor receives notification when operator completes task
3. Notifications appear in real-time without page refresh
4. User accesses notification history showing all past task events (30-day retention)

**Plans**: 7 plans

**Status**: ✓ Complete (2026-02-01)

Plans:

- [x] 08-01A-PLAN.md — Install Channels packages and configure Django settings (Wave 1)
- [x] 08-01B-PLAN.md — Create ASGI application with WebSocket routing (Wave 1)
- [x] 08-02A-PLAN.md — Implement Notification model and WebSocket consumer (Wave 2)
- [x] 08-02B-PLAN.md — Build notification broadcasting service and signal handlers (Wave 2)
- [x] 08-03A-PLAN.md — Create notification API, WebSocket composable, and Vuex store (Wave 2)
- [x] 08-03B-PLAN.md — Build NotificationCenter component and integrate into Layout (Wave 3)
- [x] 08-04-PLAN.md — Implement 30-day notification retention with admin cleanup (Wave 3)

**Details:**

Phase 8 adds real-time notification capabilities:

1. **Channels Infrastructure**: Django Channels + Redis backend, ASGI application with WebSocket routing
2. **Notification Model**: is_sent tracking, data JSONField for payloads, 30-day retention query filter
3. **WebSocket Consumer**: AuthMiddlewareStack for user authentication, heartbeat every 30s, exponential backoff reconnection
4. **Frontend Integration**: BroadcastChannel for cross-tab sync, localStorage persistence, notification sound support

### Phase 9: Performance Optimization

**Goal**: Optimize database queries, caching, and frontend rendering for production scale

**Depends on**: Phase 5

**Requirements**: PERF-02, PERF-04

**Success Criteria**:
1. Task list queries complete in under 500ms with 10,000+ tasks in database
2. Task statistics load in under 200ms using Redis cache
3. Database composite indexes eliminate full table scans on filtered queries
4. Frontend renders 100-task lists without frame drops (60 FPS maintained)
5. Query optimization reduces database load by 70% compared to unoptimized baseline

**Plans**: 3 plans

**Status**: ✓ Complete (2026-02-02)

Plans:

- [x] 09-01-PLAN.md — Add composite database indexes on frequently filtered columns (Wave 1)
- [x] 09-02-PLAN.md — Implement Redis caching for task statistics and dashboard data (Wave 2)
- [x] 09-03-PLAN.md — Optimize ORM queries with select_related and prefetch_related (Wave 2)

**Details:**

Phase 9 ensures the system is production-ready at scale:

1. **Composite Indexes**: 4 indexes added (task_dept_status_type_idx, task_operator_status_idx, task_status_created_idx, task_process_status_type_idx)
2. **Redis Caching**: Cache key patterns with 5-minute TTL, signal-based invalidation, graceful fallback for non-Redis backends
3. **ORM Optimization**: annotate() for group statistics, aggregate() for summary counts, select_related for ForeignKey fields

### Phase 10: Production Hardening

**Goal**: Ensure system is tested, documented, and ready for production deployment

**Depends on**: Phase 9

**Requirements**: None (quality gate)

**Success Criteria**:
1. All critical user workflows have integration tests passing
2. API documentation is complete and accurate for all task endpoints
3. User manual documents all features with step-by-step guides (Chinese)
4. Production deployment checklist is completed (backups, monitoring, error logging)
5. System successfully handles load testing with 100 concurrent users

**Plans**: 3 plans

**Status**: ✓ Complete (2026-02-02)

Plans:

- [x] 10-01-PLAN.md — Write integration tests for core task workflows (Wave 1)
- [x] 10-02-PLAN.md — Create API documentation and user manual (Wave 2)
- [x] 10-03-PLAN.md — Perform load testing and deployment preparation (Wave 2)

**Details:**

Phase 10 is the quality gate ensuring production readiness:

1. **Integration Tests**: Core workflow tests for task generation, approval, assignment, and notification flows
2. **Documentation**: API documentation and Chinese user manual with step-by-step guides
3. **Load Testing**: Verification of system performance under concurrent user load

---

## Milestone Summary

### Key Decisions

- **Draft Status Pattern**: Tasks created as 'draft' status, visible but not actionable until approval
- **Preview-Confirm Pattern**: Two-step sync (preview → confirm) prevents accidental data loss
- **Service Layer Architecture**: Clear separation between API views and business logic
- **Load Balancing Strategy**: Priority first, load as tiebreaker for fair department distribution
- **WebSocket Notifications**: Real-time task events with 30-day history retention
- **Virtual Scrolling**: Element UI virtual scroll for smooth 100+ task rendering

### Issues Resolved

- Phase ordering optimized (Phase 5 before Phase 7 for role-based interfaces)
- Concurrency conflicts handled with 409 HTTP status and user-friendly error messages
- ORM N+1 queries eliminated with select_related/prefetch_related optimization
- Redis cache invalidation properly triggers on task save/delete signals

### Technical Debt Incurred

- AUTH-01 (Permission system integration): Partial implementation, may need additional work for v1.1
- VIS requirements: Implementation complete but requirements status labels not updated
- NOTIF requirements: Implementation complete but ROADMAP.md status label not updated

---

_For current project status, see .planning/ROADMAP.md_

---

## Usage Guidelines

**When to use this archive:**

- Reference for v1.0 feature set and implementation details
- Historical record of decisions and technical approaches
- Traceability for requirement-to-implementation mapping

**Archive location:**

- `.planning/milestones/v1.0-ROADMAP.md`

**After archiving:**

- ROADMAP.md collapsed to one-line entry
- PROJECT.md updated with v1.0 Validated section
- Git tag v1.0 created
- Continue to next milestone (v1.1)
