# 印刷施工单任务即时分派系统

## What This Is

增强现有印刷施工单管理系统，实现施工单创建时即时生成并分派任务的功能。系统在创建施工单时立即为所有工序生成任务（草稿状态），审核通过后转为正式任务，并按优先级规则自动分派到相应部门，支持部门主管分配和操作员自领两种模式。

## Core Value

**创建即分派，审核即开工**

施工单一经创建即可预览所有任务，审核通过后任务立即可用，消除任务生成等待时间，提升生产响应速度。

## Requirements

## Requirements

### Validated

✅ **即时任务生成** — v1.0
- 施工单创建时立即为所有工序生成草稿任务
- 草稿任务可以预览、编辑、删除
- 施工单审核通过后自动转为正式任务
- 施工单审核拒绝后自动删除草稿任务

✅ **任务同步机制** — v1.0
- 工序变更时提示同步更新任务
- 草稿任务支持批量编辑和删除
- 防止孤立或重复任务

✅ **智能分派系统** — v1.0
- 部门优先级配置界面
- 自动按优先级分派到部门
- 负载平衡策略（最少任务部门优先）

✅ **任务分配机制** — v1.0
- 主管可以分配任务给操作员
- 操作员可以自领任务
- 乐观锁防止并发冲突
- 操作员任务上限控制

✅ **任务可见性** — v1.0
- 全局任务列表（按权限过滤）
- 虚拟滚动支持大量任务
- 批量操作支持
- 任务搜索和筛选

✅ **施工单集成** — v1.0
- 施工单页面显示关联任务
- 支持草稿任务编辑
- 任务统计和手动添加

✅ **角色专属界面** — v1.0
- 主管看板：任务视图、工作负载统计、拖拽分配
- 操作员中心：个人任务池、可认领任务池、进度更新

✅ **实时通知** — v1.0
- WebSocket 实时推送
- 任务分配/完成通知
- 30天通知历史

✅ **性能优化** — v1.0
- 数据库组合索引
- Redis 缓存
- ORM 查询优化

### Active

#### v2.0 高级功能

- [ ] **ADV-01**: 技能匹配分配（根据操作员技能自动匹配）
- [ ] **ADV-02**: 任务拆分支持（将一个任务拆分给多个操作员）
- [ ] **ADV-03**: 任务依赖管理（任务之间的前置依赖）
- [ ] **ADV-04**: 自动任务重新分配（超时未领取自动重新分配）
- [ ] **ADV-05**: 移动端支持（PWA 实现移动任务认领）

#### v2.0 分析报表

- [ ] **ANAL-01**: 任务完成时间统计和分析
- [ ] **ANAL-02**: 操作员绩效分析
- [ ] **ANAL-03**: 部门工作负载分析
- [ ] **ANAL-04**: 任务瓶颈分析

### Out of Scope

- **任务拆分** — 当前不支持将一个任务拆分给多个操作员（模型有parent_task字段但未实现UI）
- **任务调度优化** — 不考虑操作员当前工作负载、技能匹配等复杂调度逻辑
- **移动端支持** — 仅提供Web界面，暂不考虑移动端适配
- **任务重新分派** — 已开始的任务不允许更换操作员（取消并重新创建除外）
- **历史数据迁移** — 不处理现有施工单的任务生成（仅对新创建的施工单生效）

## Context

**v1.0 已交付系统**：
- Vue.js 2.7 + Element UI 前端
- Django 4.2 + DRF 后端
- 任务即时生成（施工单创建时）
- 草稿→正式状态转换
- 部门优先级自动分派
- 主管分配 + 操作员自领
- 角色专属界面（主管看板、操作员中心）
- WebSocket 实时通知
- 性能优化（索引 + 缓存）

**v1.1 待办**：
- AUTH-01 权限系统完善
- Requirements 状态标签更新

## Constraints

- **技术栈**：Vue 2.7、Django 4.2、DRF 3.14
- **数据库**：SQLite（开发）/ PostgreSQL（生产）
- **通知**：Django Channels + Redis
- **权限**：基于 Django 用户组

## Key Decisions

| Decision | Rationale | Outcome |
|----------|-----------|---------|
| 草稿状态模式 | 区分创建阶段和正式阶段，避免草稿任务被误操作 | ✅ 已实现 |
| 审核联动 | 利用现有审核流程，无需额外操作 | ✅ 已实现 |
| 全局可见 | 方便跨部门协作和任务认领 | ✅ 已实现 |
| 双向分配 | 灵活性：主管合理分配，操作员主动认领 | ✅ 已实现 |
| 优先级配置 | 配置化便于业务调整 | ✅ 已实现 |
| 负载平衡 | 公平分配，避免部门负载不均 | ✅ 已实现 |
| WebSocket 通知 | 实时推送，30天历史 | ✅ 已实现 |
| 虚拟滚动 | 前端大量任务渲染性能 | ✅ 已实现 |
| 乐观锁 | 防止并发任务认领冲突 | ✅ 已实现 |
| Redis 缓存 | 任务统计数据性能 | ✅ 已实现 |

---
*Last updated: 2026-02-02 after v1.0 milestone completion*
