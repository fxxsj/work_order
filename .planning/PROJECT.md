# 印刷施工单任务即时分派系统

## What This Is

增强现有印刷施工单管理系统，实现施工单创建时即时生成并分派任务的功能。系统在创建施工单时立即为所有工序生成任务（草稿状态），审核通过后转为正式任务，并按优先级规则自动分派到相应部门，支持部门主管分配和操作员自领两种模式。

## Core Value

**创建即分派，审核即开工**

施工单一经创建即可预览所有任务，审核通过后任务立即可用，消除任务生成等待时间，提升生产响应速度。

## Requirements

### Validated

✓ **施工单管理** — 现有
- 创建、编辑、审核施工单
- 工序管理和关联
- 图稿、刀模、烫金版、压凸版关联
- 产品和物料管理

✓ **任务模型** — 现有
- WorkOrderTask 模型支持部门分派（assigned_department）和操作员分派（assigned_operator）
- 任务类型区分（制版、开料、印刷、烫金、压凸、模切、包装、通用）
- 任务状态管理（pending, in_progress, completed, cancelled）

✓ **自动分派逻辑** — 现有
- `_auto_assign_task()` 方法支持自动分派
- 工序与部门关联关系（Department.processes）
- 优先级规则支持

### Active

- [ ] **即时任务生成**：创建施工单时立即为所有工序生成任务（当前是工序开始时才生成）
- [ ] **草稿状态管理**：任务以草稿状态创建，可预览和编辑
- [ ] **审核状态联动**：施工单审核通过后，草稿任务自动转为正式任务
- [ ] **任务完全可编辑**：草稿任务可以添加、删除、修改
- [ ] **工序修改提示**：修改施工单工序时提示是否更新已有任务
- [ ] **部门优先级配置**：提供界面配置每个工序的部门优先级
- [ ] **全局任务可见**：所有部门可以看到所有任务
- [ ] **任务认领机制**：操作员可以将未分配的任务分配给自己
- [ ] **主管分配机制**：部门主管可以将任务分配给部门内操作员
- [ ] **施工单详情页集成**：在施工单创建/编辑页面显示和编辑任务
- [ ] **任务管理页面**：独立页面管理所有任务的分配和认领
- [ ] **部门主管界面**：部门主管专用的任务分配界面
- [ ] **操作员任务中心**：操作员查看已分配和可认领任务的页面

### Out of Scope

- **任务拆分** — 当前不支持将一个任务拆分给多个操作员（模型有parent_task字段但未实现UI）
- **任务调度优化** — 不考虑操作员当前工作负载、技能匹配等复杂调度逻辑
- **移动端支持** — 仅提供Web界面，暂不考虑移动端适配
- **任务重新分派** — 已开始的任务不允许更换操作员（取消并重新创建除外）
- **历史数据迁移** — 不处理现有施工单的任务生成（仅对新创建的施工单生效）

## Context

**现有系统**：
- Vue.js 2.7 + Element UI 前端
- Django REST Framework 后端
- 施工单审核流程已实现（approval_status: pending/approved/rejected）
- 任务模型完整，但生成时机在工序开始时（`WorkOrderProcess.generate_tasks()`）

**技术债务**：
- `generate_tasks()` 方法在工序开始时调用，用户希望在施工单创建时就调用
- 缺少任务草稿状态的概念（当前任务创建就是pending状态）
- 缺少部门优先级配置界面
- 缺少任务管理和分配的专用界面

**业务背景**：
- 印刷行业有21个标准工序（CTP制版、开料、印刷、烫金、压凸、模切、包装等）
- 每个工序可能对应多个部门（如模切工序可能有车间A和外协厂B）
- 部门需要预先看到任务以便安排人力和设备
- 操作员可以主动认领任务，也可以由主管分配

## Constraints

- **技术栈**：必须使用现有技术栈（Vue 2.7、Django 4.2、DRF 3.14）
- **向后兼容**：不能破坏现有施工单和任务的数据和功能
- **数据库**：当前使用SQLite，生产环境可能使用PostgreSQL
- **权限系统**：基于Django用户组和权限，需要适配现有权限体系
- **部署**：前端构建后部署到Web服务器，后端使用Gunicorn

## Key Decisions

| Decision | Rationale | Outcome |
|----------|-----------|---------|
| 草稿状态 | 区分创建阶段和正式阶段，避免草稿任务被误操作 | 待实现 |
| 审核联动 | 利用现有审核流程，无需额外操作 | 待实现 |
| 全局可见 | 方便跨部门协作和任务认领，透明化工作分配 | 待实现 |
| 双向分配 | 灵活性：主管可以合理分配，操作员可以主动认领 | 待实现 |
| 优先级配置 | 配置化而非硬编码，便于业务调整 | 待实现 |

---
*Last updated: 2026-01-30 after initialization*
