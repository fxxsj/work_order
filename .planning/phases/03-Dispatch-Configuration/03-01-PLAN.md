---
phase: 03-Dispatch-Configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/workorder/services/dispatch_service.py
  - backend/workorder/views/system.py
  - backend/workorder/serializers/system.py
  - frontend/src/api/modules/task-assignment-rule.js
  - frontend/src/views/task/AssignmentRule.vue
autonomous: false

must_haves:
  truths:
    - "Administrator accesses configuration page showing all process-department mappings"
    - "Configuration page has dual-column layout with process list and priority panel"
    - "Drag-and-drop reordering updates department priority in real-time"
    - "Preview table shows which department will receive tasks for each process"
    - "Preview updates after every configuration change (drag, toggle, add, delete)"
  artifacts:
    - path: "backend/workorder/services/dispatch_service.py"
      provides: "DispatchPreviewService with generate_preview() and simulate_dispatch()"
      min_lines: 80
    - path: "backend/workorder/views/system.py"
      provides: "TaskAssignmentRuleViewSet.preview() action"
      exports: ["preview"]
    - path: "frontend/src/views/task/AssignmentRule.vue"
      provides: "Dual-column layout with drag-and-drop priority sorting"
      min_lines: 500
    - path: "frontend/src/components/dispatch/DispatchPreviewTable.vue"
      provides: "Reusable preview table component"
      min_lines: 100
  key_links:
    - from: "frontend/src/views/task/AssignmentRule.vue"
      to: "/api/task-assignment-rules/preview/"
      via: "taskAssignmentRuleAPI.preview()"
      pattern: "preview|generatePreview"
    - from: "backend/workorder/views/system.py"
      to: "backend/workorder/services/dispatch_service.py"
      via: "DispatchPreviewService.generate_preview()"
      pattern: "DispatchPreviewService"
---

<objective>
Build dispatch preview service and enhance configuration UI with dual-column layout and drag-and-drop priority sorting.

Purpose: Provide administrators with a visual interface to configure and preview task dispatch rules, showing exactly which department will receive tasks for each process based on current priority settings.

Output: Working dispatch preview API endpoint, enhanced AssignmentRule.vue with dual-column layout, drag-and-drop department reordering, and real-time preview table.
</objective>

<execution_context>
@/home/chenjiaxing/.claude/get-shit-done/workflows/execute-plan.md
@/home/chenjiaxing/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-Dispatch-Configuration/03-RESEARCH.md

# Prior phase context
@.planning/phases/01-draft-task-foundation/01-03-SUMMARY.md
@.planning/phases/02-Task-Data-Consistency/02-01-SUMMARY.md

# Existing code to extend
@/home/chenjiaxing/文档/work_order/backend/workorder/models/system.py
@/home/chenjiaxing/文档/work_order/backend/workorder/views/system.py
@/home/chenjiaxing/文档/work_order/frontend/src/views/task/AssignmentRule.vue
@/home/chenjiaxing/文档/work_order/frontend/src/api/modules/task-assignment-rule.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DispatchPreviewService in backend</name>
  <files>backend/workorder/services/dispatch_service.py</files>
  <action>
    Create a new service file `backend/workorder/services/dispatch_service.py` with the following:

    1. **DispatchPreviewService class** with two static methods:
       - `generate_preview()`: Returns list of dicts with process info and target department for all active processes
         - Query Process.objects.filter(is_active=True)
         - For each process, get highest priority active TaskAssignmentRule
         - Calculate current department load (pending + in_progress task count)
         - Return list with: process_id, process_name, process_code, target_department_id, target_department_name, current_load, priority, is_active

       - `simulate_dispatch(process_id)`: Simulate dispatch for a specific process
         - Get process by id
         - Get all active rules for process, ordered by priority
         - Return target department with load info and selection strategy

    2. **Load calculation**:
       - Count only tasks with status in ['pending', 'in_progress']
       - Use WorkOrderTask.objects.filter(assigned_department=dept, status__in=['pending', 'in_progress']).count()

    3. **Select related optimization**:
       - Use .select_related('process', 'department') on TaskAssignmentRule queries

    4. **Add service to __init__.py**:
       - Export DispatchPreviewService from backend/workorder/services/__init__.py

    Reference existing service patterns in task_generation.py and task_sync_service.py.
  </action>
  <verify>
    grep -n "DispatchPreviewService" backend/workorder/services/__init__.py
    python manage.py shell -c "from workorder.services.dispatch_service import DispatchPreviewService; print(DispatchPreviewService.generate_preview())"
  </verify>
  <done>
    DispatchPreviewService is importable from workorder.services, generate_preview() returns list of process dispatch info with target departments and load counts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add preview API endpoint to TaskAssignmentRuleViewSet</name>
  <files>backend/workorder/views/system.py</files>
  <action>
    Add a `@action` method to TaskAssignmentRuleViewSet in `backend/workorder/views/system.py`:

    1. **Import DispatchPreviewService**:
       ```python
       from ..services.dispatch_service import DispatchPreviewService
       ```

    2. **Add preview action**:
       - Decorator: `@action(detail=False, methods=['get'])`
       - Method name: `preview(self, request)`
       - Call: `preview_data = DispatchPreviewService.generate_preview()`
       - Return: `Response({'preview': preview_data, 'generated_at': timezone.now().isoformat()})`

    3. **Response structure**:
       ```python
       {
           'preview': [
               {
                   'process_id': int,
                   'process_name': str,
                   'process_code': str,
                   'target_department_id': int,
                   'target_department_name': str,
                   'current_load': int,
                   'priority': int,
                   'is_active': bool
               },
               ...
           ],
           'generated_at': ISO datetime string
       }
       ```

    4. **Add timezone import** if not already present:
       ```python
       from django.utils import timezone
       ```
  </action>
  <verify>
    curl -X GET http://localhost:8000/api/task-assignment-rules/preview/ -H "Authorization: Bearer TOKEN"
  </verify>
  <done>
    GET /api/task-assignment-rules/preview/ returns JSON with preview list and generated_at timestamp.
  </done>
</task>

<task type="auto">
  <name>Task 3: Extend taskAssignmentRuleAPI with preview method</name>
  <files>frontend/src/api/modules/task-assignment-rule.js</files>
  <action>
    Extend the TaskAssignmentRuleAPI class in `frontend/src/api/modules/task-assignment-rule.js`:

    1. **Add preview() method**:
       ```javascript
       preview(params = {}) {
         return this.request({
           url: `${this.baseURL}preview/`,
           method: 'get',
           params
         })
       }
       ```

    2. **Keep existing BaseAPI inheritance**:
       - The class already extends BaseAPI and inherits getList, getDetail, create, update, delete
       - Only add the custom preview method

    Follow the existing BaseAPI pattern used in other API modules.
  </action>
  <verify>
    grep -n "preview" frontend/src/api/modules/task-assignment-rule.js
  </verify>
  <done>
    taskAssignmentRuleAPI.preview() is defined and calls /task-assignment-rules/preview/ endpoint.
  </done>
</task>

<task type="checkpoint:human-verify">
  <what-built>Backend dispatch preview service and API endpoint (Tasks 1-3)</what-built>
  <how-to-verify>
    1. Start backend server: `cd backend && python manage.py runserver`
    2. Open browser or use curl to access: `http://localhost:8000/api/task-assignment-rules/preview/`
    3. Verify response contains:
       - "preview" array with process info
       - "generated_at" timestamp
       - Each item has: process_name, target_department_name, current_load, priority
    4. Create some test TaskAssignmentRule records if needed via Django admin
    5. Verify current_load shows actual task counts for departments
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

<task type="auto">
  <name>Task 4: Create DispatchPreviewTable component</name>
  <files>frontend/src/components/dispatch/DispatchPreviewTable.vue</files>
  <action>
    Create a new component `frontend/src/components/dispatch/DispatchPreviewTable.vue`:

    1. **Props**:
       - `previewData`: Array of dispatch preview objects
       - `loading`: Boolean for loading state
       - `globalDispatchEnabled`: Boolean (optional, for warning banner)

    2. **Template structure**:
       - Warning banner if globalDispatchEnabled is false (el-alert type="warning")
       - el-table with columns:
         * Process name (process_name)
         * Process code (process_code)
         * Target department (target_department_name) with el-tag
         * Current load (current_load) with el-progress bar
         * Priority (priority) with el-tag color-coded

    3. **Style**:
       - Use scoped styles
       - Progress bar color coding based on load (green < 10, yellow < 20, red >= 20)
       - Clean table borders

    4. **Methods**:
       - `calculateLoadPercentage(load)`: Returns percentage for progress bar (capped at 100)
       - `getLoadColor(load)`: Returns color string based on load value
       - `getPriorityTagType(priority)`: Returns tag type based on priority (danger >= 80, warning >= 50, success >= 20, info)

    Follow Element UI component patterns used in existing components.
  </action>
  <verify>
    ls -la frontend/src/components/dispatch/DispatchPreviewTable.vue
    grep -c "el-table" frontend/src/components/dispatch/DispatchPreviewTable.vue
  </verify>
  <done>
    DispatchPreviewTable.vue component exists, displays preview data in table format with progress bars and color-coded tags.
  </done>
</task>

<task type="auto">
  <name>Task 5: Create ProcessList component for left column</name>
  <files>frontend/src/components/dispatch/ProcessList.vue</files>
  <action>
    Create a new component `frontend/src/components/dispatch/ProcessList.vue`:

    1. **Props**:
       - `processes`: Array of process objects with id, name, code
       - `selectedProcess`: Object or null (currently selected process)
       - `loading`: Boolean

    2. **Template**:
       - el-card with title "工序列表"
       - Virtual list or simple v-for for process items
       - Each item shows:
         * Process name (bold)
         * Process code (smaller, gray)
         * Selected highlight (different background color)
         * Hover state

    3. **Events**:
       - `@select(process)`: Emits when user clicks a process

    4. **Style**:
       - Compact list items with padding
       - Selected state with blue border or background
       - Hover effect for interactivity
       - Max height with overflow for scrollable list

    Keep component simple and focused on selection only.
  </action>
  <verify>
    ls -la frontend/src/components/dispatch/ProcessList.vue
    grep -c "@select" frontend/src/components/dispatch/ProcessList.vue
  </verify>
  <done>
    ProcessList.vue component exists, displays selectable process list with visual feedback for selected state.
  </done>
</task>

<task type="auto">
  <name>Task 6: Create DepartmentPriorityPanel component with drag-and-drop</name>
  <files>frontend/src/components/dispatch/DepartmentPriorityPanel.vue</files>
  <action>
    Create a new component `frontend/src/components/dispatch/DepartmentPriorityPanel.vue`:

    1. **Props**:
       - `process`: Object (selected process)
       - `departments`: Array of assignment rule objects
       - `allDepartments`: Array of all available departments
       - `loading`: Boolean

    2. **Data**:
       - `departmentList`: Local copy of departments for drag-and-drop
       - `dialogVisible`: For add/edit department
       - `form`: Form data for add/edit
       - `strategies`: Operator selection strategy options

    3. **Template**:
       - el-card with title showing process name
       - "Add Department" button
       - draggable list (using native HTML5 drag-drop API to avoid external dependency):
         * Each department card shows:
           - Priority badge (circle number)
           - Drag handle icon
           - Department name and code
           - Current task load
           - Active/inactive switch
           - Edit/delete buttons
       - Dialog for adding department to process

    4. **Events**:
       - `@update-priority`: Emits after drag reorder with new priority values
       - `@toggle-active`: Emits when department active state toggled
       - `@add-department`: Emits when adding new department to process
       - `@remove-department`: Emits when removing department from process

    5. **Methods**:
       - `handleDragEnd(event)`: Recalculates priorities based on new order
       - `toggleActive(dept)`: Toggles is_active and emits event
       - `showAddDialog()`: Opens dialog to add department
       - `showEditDialog(rule)`: Opens dialog to edit rule
       - `handleDelete(rule)`: Emits delete event

    6. **Priority calculation**:
       - After drag, map departments with new priorities: `100 - index`
       - Higher priority for lower index (top of list)

    Use native HTML5 drag-and-drop API (draggable="true", @dragstart, @dragover, @drop) to avoid adding vuedraggable dependency.
  </action>
  <verify>
    ls -la frontend/src/components/dispatch/DepartmentPriorityPanel.vue
    grep -c "draggable" frontend/src/components/dispatch/DepartmentPriorityPanel.vue
  </verify>
  <done>
    DepartmentPriorityPanel.vue component exists, supports drag-and-drop reordering, shows department priority badges and current load.
  </done>
</task>

<task type="auto">
  <name>Task 7: Enhance AssignmentRule.vue with dual-column layout</name>
  <files>frontend/src/views/task/AssignmentRule.vue</files>
  <action>
    Completely refactor `frontend/src/views/task/AssignmentRule.vue`:

    1. **Keep existing imports** for mixins and APIs

    2. **New layout structure**:
       - Keep search bar and filters at top
       - Add global dispatch toggle (el-switch) in header section
       - Replace table with dual-column layout:
         * Left column (8 spans): ProcessList component
         * Right column (16 spans): DepartmentPriorityPanel component
       - Add DispatchPreviewTable at bottom for full preview

    3. **New data properties**:
       - `globalDispatchEnabled`: Boolean (default: false, stored in localStorage)
       - `selectedProcess`: Object or null
       - `processList`: Array of all processes
       - `departmentRules`: Array for selected process
       - `previewData`: Array of dispatch preview
       - `previewLoading`: Boolean

    4. **New methods**:
       - `handleProcessSelect(process)`: Sets selected process, loads department rules
       - `loadDepartmentPriorities(processId)`: Fetches rules for selected process
       - `generatePreview()`: Calls API to get dispatch preview
       - `handleGlobalToggle(value)`: Updates global dispatch enabled state
       - `handlePriorityUpdate(rules)`: Called after drag reorder, bulk updates priorities
       - `handleToggleActive(rule)`: Updates is_active for a rule
       - `handleAddDepartment(departmentId)`: Adds new department to process
       - `handleRemoveDepartment(ruleId)`: Removes department from process

    5. **Lifecycle**:
       - In mounted(): load process list, generate initial preview
       - Call loadData() to populate existing rules

    6. **Priority update logic**:
       - After drag, call bulk update API for each changed rule
       - Use Promise.all for parallel updates
       - Regenerate preview after successful update

    7. **Preview refresh**:
       - Call generatePreview() after any configuration change
       - Debounce preview refresh if needed (300ms)

    8. **Persistence**:
       - Save globalDispatchEnabled to localStorage key 'dispatch_global_enabled'
       - Load from localStorage in mounted()

    9. **Style**:
       - Use el-row and el-col for responsive layout
       - Fixed height for process list (400px) with overflow
       - Card styling for each column
       - Consistent spacing and borders

    Preserve the existing listPageMixin integration for backward compatibility with basic list view.
  </action>
  <verify>
    grep -c "ProcessList\|DepartmentPriorityPanel\|DispatchPreviewTable" frontend/src/views/task/AssignmentRule.vue
  </verify>
  <done>
    AssignmentRule.vue has dual-column layout, imports all three new components, process selection loads department priorities, preview displays at bottom.
  </done>
</task>

<task type="checkpoint:human-verify">
  <what-built>Complete dispatch configuration UI (Tasks 4-7)</what-built>
  <how-to-verify>
    1. Start frontend server: `cd frontend && npm run serve`
    2. Navigate to AssignmentRule page in browser
    3. Verify the following:
       - Page shows dual-column layout (process list left, departments right)
       - Process list displays all processes with codes
       - Clicking a process loads its department priority list in right panel
       - Right panel shows departments with priority badges (1, 2, 3...)
       - Dragging a department item updates its priority badge
       - Toggle switch enables/disables department rules
       - Preview table at bottom shows all processes with target departments
       - Preview updates after drag-and-drop reordering
       - Global toggle switch at top controls dispatch enablement
       - Add department button opens dialog to add new department
       - Delete button removes department from process
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete, verify:

1. **Backend API verification**:
   - GET /api/task-assignment-rules/preview/ returns valid preview data
   - Preview includes all active processes with target departments
   - current_load reflects actual pending+in_progress task counts

2. **Frontend component verification**:
   - ProcessList component displays selectable processes
   - DepartmentPriorityPanel supports drag-and-drop reordering
   - DispatchPreviewTable displays preview with progress bars
   - AssignmentRule.vue integrates all three components

3. **Integration verification**:
   - Selecting process loads its department rules
   - Drag-and-drop updates priorities in real-time
   - Preview refreshes after configuration changes
   - Global toggle persists across page reloads
</verification>

<success_criteria>
Phase 3 Plan 1 is successful when:

1. Administrator can access configuration page and see all process-department mappings in dual-column layout
2. Drag-and-drop reordering of departments updates priority values with visual feedback
3. Preview table accurately shows which department will receive tasks for each process
4. Preview updates in real-time after any configuration change (drag, toggle, add, delete)
5. Global dispatch toggle state persists across browser sessions
</success_criteria>

<output>
After completion, create `.planning/phases/03-Dispatch-Configuration/03-01-SUMMARY.md`
</output>
