# Phase 3: Dispatch Configuration - Context

**Gathered:** 2026-01-31
**Status:** Ready for planning

<domain>
## Phase Boundary

构建基于优先级的部门分派配置系统。管理员可以配置每个工序的部门优先级顺序，系统在施工单审核通过后自动将任务分派到最高优先级部门。支持启用/禁用分派规则、预览分派结果，以及负载均衡策略（选择任务最少的部门）。

关键能力：
- 配置界面：工序-部门映射的优先级设置
- 自动分派：审核时根据配置自动分派任务到部门
- 规则控制：全局启用/禁用分派规则
- 分派预览：查看配置效果和目标部门
- 负载均衡：在同级部门间选择任务最少的

**不包含**：手动任务分配（Phase 4）、操作员认领（Phase 4）
</domain>

<decisions>
## Implementation Decisions

### 配置界面布局

- **双栏布局**：左侧工序列表，右侧部门优先级设置面板
- **拖拽排序**：右侧部门列表使用拖拽（Drag & Drop）调整优先级顺序
- **数字徽章**：部门卡片上显示数字徽章（1、2、3...）表示优先级
- **完整部门信息**：部门优先级列表显示全部信息：
  - 部门名称
  - 当前任务数量（进行中 + 待分配）
  - 部门主管/负责人姓名
  - 历史任务统计（该部门处理该工序的任务数）

### 优先级与负载均衡交互

- **混合模式**（Claude's Discretion）：默认按优先级分派，在同等优先级的多个部门间使用负载均衡
  - 示例：工序A的优先级配置为[部门1(1级), 部门2(1级), 部门3(2级)]
    - 部门1和部门2都是1级优先级，在两者之间选择任务数较少的
    - 如果部门1和2都不可用，才选择部门3
- **负载计算**（Claude's Discretion）：仅统计待分配状态的任务，不考虑进行中的任务
- **部门不可用处理**（Claude's Discretion）：自动跳过不可用部门，选择下一个优先级或负载最低的部门
- **策略更新时机**（Claude's Discretion）：配置更改后立即生效，影响后续任务分派

### 规则控制粒度

- **全局级别控制**：一个全局开关控制所有工序的分派是否启用
- **默认状态**（Claude's Discretion）：分派规则默认禁用，管理员手动启用后才开始工作
- **禁用行为**（Claude's Discretion）：仅影响新任务，已分派的任务继续执行不受影响
- **状态提示**（Claude's Discretion）：配置页面顶部横幅 + 颜色图标组合，清晰显示启用/禁用状态

### 分派预览方式

- **实时预览**（Claude's Discretion）：配置更改时实时更新预览，立即显示效果
- **预览内容**：显示每个工序将被分派到的目标部门
- **表格展示**：以表格形式呈现预览信息
  - 列：工序名称 | 目标部门 | 当前负载
- **交互操作**：
  - 点击目标部门可跳转到该部门详情页
  - 在预览中可以直接调整某个工序的配置

### Claude's Discretion

以下区域由Claude在规划/实现时灵活决定：

**优先级与负载均衡交互**：
- 混合模式的具体实现逻辑
- 负载计算时是否考虑进行中任务
- 不可用部门的处理和降级策略
- 配置更改的生效时机和方式

**规则控制粒度**：
- 分派规则的默认启用状态
- 禁用规则对已有任务的影响范围
- 状态提示的具体UI实现

**分派预览方式**：
- 预览触发的具体时机和条件
- 预览更新的性能优化（如防抖）
- 表格展示的具体样式和交互细节

</decisions>

<specifics>
## Specific Ideas

- 配置界面应该直观易用，管理员能够快速理解工序-部门的映射关系
- 拖拽排序提供自然的交互体验，数字徽章提供清晰的视觉反馈
- 部门信息完整显示，帮助管理员做出合理的优先级决策
- 实时预览让管理员立即看到配置效果，无需切换视图
- 混合模式（优先级 + 负载均衡）提供灵活的分派策略

</specifics>

<deferred>
## Deferred Ideas

None — discussion stayed within phase scope

</deferred>

---

*Phase: 03-Dispatch-Configuration*
*Context gathered: 2026-01-31*
