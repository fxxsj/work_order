---
phase: 01-draft-task-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - backend/workorder/views/work_orders.py
  - backend/workorder/models/core.py
  - backend/workorder/serializers/core.py
autonomous: true

must_haves:
  truths:
    - "Approving a work order converts all draft tasks to 'pending' status"
    - "Rejecting a work order deletes all draft tasks"
    - "Draft-to-formal conversion happens atomically in a transaction"
    - "Task deletion on rejection is cascaded (no orphaned tasks)"
    - "Notification sent to creator on draft task conversion"
  artifacts:
    - path: "backend/workorder/models/core.py"
      provides: "WorkOrder.convert_draft_tasks() and WorkOrder.delete_draft_tasks() methods"
      contains: "def convert_draft_tasks(self):"
    - path: "backend/workorder/views/work_orders.py"
      provides: "Approval workflow with draft task handling"
      contains: "convert_draft_tasks"
    - path: "backend/workorder/serializers/core.py"
      provides: "Task status update in approve action"
      contains: "status='pending'"
  key_links:
    - from: "backend/workorder/views/work_orders.py:approve"
      to: "backend/workorder/models/core.py:WorkOrder.convert_draft_tasks"
      via: "method call on approval_status='approved'"
      pattern: "work_order.convert_draft_tasks\\(\\)"
    - from: "backend/workorder/views/work_orders.py:approve"
      to: "backend/workorder/models/core.py:WorkOrder.delete_draft_tasks"
      via: "method call on approval_status='rejected'"
      pattern: "work_order.delete_draft_tasks\\(\\)"
---

<objective>
Build approval workflow with draft-to-formal conversion and cascade deletion

Purpose: When work order is approved, convert draft tasks to formal tasks; when rejected, delete draft tasks entirely

Output: Approval workflow with automatic draft task conversion/deletion
</objective>

<execution_context>
@/home/chenjiaxing/.claude/get-shit-done/workflows/execute-plan.md
@/home/chenjiaxing/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-draft-task-foundation/01-01-PLAN.md
@.planning/phases/01-draft-task-foundation/01-02-PLAN.md
@backend/workorder/views/work_orders.py
@backend/workorder/models/core.py
@backend/workorder/serializers/core.py
</context>

<tasks>

<task type="auto">
  <name>Add convert_draft_tasks method to WorkOrder</name>
  <files>backend/workorder/models/core.py</files>
  <action>
    Add convert_draft_tasks method to WorkOrder class:
    1. Add method after the validate_before_approval method (around line 236)
    2. Method should:
       - Use transaction.atomic() for atomic operation
       - Query all draft tasks: WorkOrderTask.objects.filter(work_order_process__work_order=self, status='draft')
       - Update status from 'draft' to 'pending' using bulk_update (more efficient than individual saves)
       - Set updated_at timestamp
       - Log the conversion (create TaskLog entries for converted tasks)
       - Return count of converted tasks

    The method signature:
    ```python
    def convert_draft_tasks(self):
        \"\"\"Convert all draft tasks to formal tasks (pending status)

        Called when work order is approved. Draft tasks become
        operational tasks that can be assigned and executed.

        Returns:
            int: Number of tasks converted
        \"\"\"
    ```

    Implementation should use bulk_update for performance with large task counts.
  </action>
  <verify>grep -n "def convert_draft_tasks" backend/workorder/models/core.py</verify>
  <done>WorkOrder has convert_draft_tasks method that converts draft to pending using bulk_update</done>
</task>

<task type="auto">
  <name>Add delete_draft_tasks method to WorkOrder</name>
  <files>backend/workorder/models/core.py</files>
  <action>
    Add delete_draft_tasks method to WorkOrder class:
    1. Add method after convert_draft_tasks
    2. Method should:
       - Use transaction.atomic() for atomic operation
       - Query all draft tasks: WorkOrderTask.objects.filter(work_order_process__work_order=self, status='draft')
       - Delete using queryset.delete() (cascades properly)
       - Log the deletion (optional, for audit trail)
       - Return count of deleted tasks

    The method signature:
    ```python
    def delete_draft_tasks(self):
        \"\"\"Delete all draft tasks for this work order

        Called when work order is rejected. Draft tasks are not needed
        and should be removed to keep database clean.

        Returns:
            int: Number of tasks deleted
        \"\"\"
    ```

    This uses Django's cascade deletion - related TaskLog entries will also be deleted.
  </action>
  <verify>grep -n "def delete_draft_tasks" backend/workorder/models/core.py</verify>
  <done>WorkOrder has delete_draft_tasks method that removes all draft tasks</done>
</task>

<task type="auto">
  <name>Integrate draft task handling into approve action</name>
  <files>backend/workorder/views/work_orders.py</files>
  <action>
    Update the approve action in WorkOrderViewSet (around line 238):
    1. Find the existing approve method
    2. After work_order.save() on approval (around line 319):
       - If approval_status == 'approved': call work_order.convert_draft_tasks()
       - If approval_status == 'rejected': call work_order.delete_draft_tasks()
    3. Add the converted/deleted task count to response
    4. Update notification content to include task conversion/deletion info

    The integration should be:
    ```python
    # After work_order.save()
    if approval_status == 'approved':
        converted_count = work_order.convert_draft_tasks()
        # Include in response
    elif approval_status == 'rejected':
        deleted_count = work_order.delete_draft_tasks()
        # Include in response
    ```

    Ensure transaction rollback if any part fails.
  </action>
  <verify>grep -A10 "approval_status == 'approved'" backend/workorder/views/work_orders.py | grep -c "convert_draft_tasks"</verify>
  <done>Approve action calls convert_draft_tasks on approval and delete_draft_tasks on rejection</done>
</task>

<task type="auto">
  <name>Add draft task constraint to model</name>
  <files>backend/workorder/models/core.py</files>
  <action>
    Add model-level constraint to prevent draft task status changes to other statuses without going through proper workflow:
    1. Override save() method in WorkOrderTask if not already overridden for status validation
    2. Add validation: if status is changing from 'draft' to something else, verify work order is approved
    3. This ensures draft tasks can only become formal through the approval workflow

    Alternative: Add a clean() method that validates:
    - If status == 'draft', no assigned_operator or assigned_department should be set
    - Draft tasks cannot be directly edited to 'in_progress' or 'completed'

    Location: Add to WorkOrderTask class (around line 1073)

    This prevents accidental status transitions that bypass the approval workflow.
  </action>
  <verify>grep -n "def clean\|def save.*status" backend/workorder/models/core.py | grep -A2 "WorkOrderTask"</verify>
  <done>WorkOrderTask has validation preventing draft task status changes outside approval workflow</done>
</task>

</tasks>

<verification>
After completion, verify:
1. Create work order -> verify draft tasks exist
2. Approve work order -> verify draft tasks converted to pending
3. Reject work order -> verify draft tasks deleted
4. Try to edit draft task directly to 'in_progress' -> should fail validation
5. Test transaction rollback: if conversion fails midway, no partial updates
</verification>

<success_criteria>
- Approving work order converts all draft tasks to pending status
- Rejecting work order deletes all draft tasks
- Draft task conversion/deletion is atomic (transaction-wrapped)
- Cannot bypass approval workflow by editing draft task status directly
</success_criteria>

<output>
After completion, create `.planning/phases/01-draft-task-foundation/01-03-SUMMARY.md`
</output>
