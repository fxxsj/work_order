---
phase: 01-draft-task-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/workorder/constants/status.py
  - backend/workorder/models/core.py
  - backend/workorder/serializers/core.py
autonomous: true

must_haves:
  truths:
    - "User can see 'draft' status option for tasks in database and API"
    - "Draft tasks are excluded from operational task queries by default"
    - "Task status choices include 'draft' with proper display label"
    - "Existing non-draft tasks continue to work without migration issues"
  artifacts:
    - path: "backend/workorder/constants/status.py"
      provides: "TaskStatus constant with DRAFT status"
      contains: "DRAFT = 'draft'"
    - path: "backend/workorder/models/core.py"
      provides: "WorkOrderTask model with draft status support"
      contains: "STATUS_CHOICES with draft option"
    - path: "backend/workorder/serializers/core.py"
      provides: "Task serialization with draft status display"
      exports: ["WorkOrderTaskSerializer"]
  key_links:
    - from: "backend/workorder/constants/status.py"
      to: "backend/workorder/models/core.py"
      via: "import TaskStatus"
      pattern: "from ..constants.status import TaskStatus"
    - from: "backend/workorder/serializers/core.py"
      to: "backend/workorder/constants/status.py"
      via: "reference for display labels"
      pattern: "TaskStatus.CHOICES"
---

<objective>
Add draft status field to WorkOrderTask model with proper constraints and serialization support

Purpose: Enable tasks to exist in a "draft" state that is distinct from operational tasks, allowing pre-approval task generation while preventing draft tasks from appearing in operational workflows

Output: Updated task model, constants, and serializers with draft status support
</objective>

<execution_context>
@/home/chenjiaxing/.claude/get-shit-done/workflows/execute-plan.md
@/home/chenjiaxing/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/workorder/constants/status.py
@backend/workorder/models/core.py
@backend/workorder/serializers/core.py
</context>

<tasks>

<task type="auto">
  <name>Add DRAFT constant to TaskStatus</name>
  <files>backend/workorder/constants/status.py</files>
  <action>
    Add DRAFT status constant to TaskStatus class:
    1. Add DRAFT = 'draft' class attribute
    2. Add ('draft', '草稿') to CHOICES list at the beginning (before 'pending')
    3. Add get_status_display method logic if not already present

    The draft status should be the first option in CHOICES to indicate it's the initial state for newly generated tasks.

    Important: Keep existing status constants (PENDING, IN_PROGRESS, etc.) unchanged to maintain compatibility.
  </action>
  <verify>grep -n "DRAFT.*draft" backend/workorder/constants/status.py</verify>
  <done>TaskStatus class has DRAFT constant with 'draft' value and Chinese label '草稿' in CHOICES</done>
</task>

<task type="auto">
  <name>Update WorkOrderTask STATUS_CHOICES with draft</name>
  <files>backend/workorder/models/core.py</files>
  <action>
    Update WorkOrderTask model STATUS_CHOICES to include draft status:
    1. Add ('draft', '草稿') option at the beginning of STATUS_CHOICES list
    2. Keep the status field default value as 'pending' (NOT 'draft' - draft is only explicitly set during generation)
    3. Ensure the model's Meta indexes include status field (already exists, verify)

    The STATUS_CHOICES in WorkOrderTask should mirror TaskStatus.CHOICES but maintain the model's explicit definition for backwards compatibility.

    Location: WorkOrderTask class around line 1127-1130 in models/core.py
  </action>
  <verify>grep -A5 "STATUS_CHOICES.*=" backend/workorder/models/core.py | grep "draft"</verify>
  <done>WorkOrderTask STATUS_CHOICES includes draft option as first choice</done>
</task>

<task type="auto">
  <name>Add draft filtering to base queryset</name>
  <files>backend/workorder/models/core.py</files>
  <action>
    Add a custom manager method to WorkOrderTask for excluding draft tasks from operational queries:
    1. Add a new method 'operational()' to the TaskOptimizedManager class
    2. This method should filter out tasks with status='draft'
    3. Return queryset with status__in=['pending', 'in_progress', 'completed', 'cancelled']

    Find TaskOptimizedManager class in services/query_optimizer.py and add the operational() method there.

    This ensures that views wanting only "real" tasks can easily exclude drafts.
  </action>
  <verify>grep -n "def operational" backend/workorder/services/query_optimizer.py</verify>
  <done>TaskOptimizedManager has operational() method that excludes draft tasks</done>
</task>

<task type="auto">
  <name>Update serializer for draft status display</name>
  <files>backend/workorder/serializers/core.py</files>
  <action>
    Update WorkOrderTaskSerializer to properly handle draft status:
    1. Verify status_display field exists (should use get_status_display)
    2. Add a is_draft computed field that returns True if status == 'draft'
    3. Ensure draft tasks are included in list and detail responses

    The serializer should make it easy for frontend to identify draft tasks visually.
  </action>
  <verify>grep -n "is_draft\|status_display" backend/workorder/serializers/core.py</verify>
  <done>WorkOrderTaskSerializer has is_draft field and proper status_display for draft status</done>
</task>

</tasks>

<verification>
After completion, verify:
1. Python shell test: from workorder.constants.status import TaskStatus; assert hasattr(TaskStatus, 'DRAFT')
2. Python shell test: from workorder.models.core import WorkOrderTask; assert 'draft' in [c[0] for c in WorkOrderTask.STATUS_CHOICES]
3. Python shell test: from workorder.services.query_optimizer import TaskOptimizedManager; assert callable(getattr(TaskOptimizedManager, 'operational', None))
4. Run: python manage.py check --deploy (verify no model/serializer issues)
</verification>

<success_criteria>
- DRAFT status constant added to TaskStatus class
- WorkOrderTask STATUS_CHOICES includes draft option
- TaskOptimizedManager has operational() method to exclude drafts
- WorkOrderTaskSerializer can serialize draft status properly
- No breaking changes to existing non-draft tasks
</success_criteria>

<output>
After completion, create `.planning/phases/01-draft-task-foundation/01-01-SUMMARY.md`
</output>
