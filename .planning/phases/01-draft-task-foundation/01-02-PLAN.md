---
phase: 01-draft-task-foundation
plan: 02
type: execute
wave: 1
depends_on: ["01-01"]
files_modified:
  - backend/workorder/services/task_generation.py
  - backend/workorder/models/core.py
  - backend/workorder/serializers/core.py
  - backend/workorder/views/work_orders.py
  - backend/workorder/urls.py
autonomous: true

must_haves:
  truths:
    - "Creating a work order immediately generates draft tasks for all processes"
    - "100 tasks can be generated in under 2 seconds (PERF-01 requirement)"
    - "Each draft task links to its work order process and contains proper metadata"
    - "API returns generated draft tasks in work order detail response"
    - "Draft tasks can be edited via PATCH/PUT endpoint before approval"
    - "Draft tasks can be deleted via DELETE endpoint before approval"
  artifacts:
    - path: "backend/workorder/services/task_generation.py"
      provides: "DraftTaskGenerationService class"
      exports: ["DraftTaskGenerationService.generate_draft_tasks", "DraftTaskGenerationService.bulk_create_tasks"]
    - path: "backend/workorder/models/core.py"
      provides: "WorkOrderProcess.generate_draft_tasks method"
      contains: "def generate_draft_tasks(self):"
    - path: "backend/workorder/serializers/core.py"
      provides: "Draft task count in work order response"
      contains: "draft_task_count"
  key_links:
    - from: "backend/workorder/models/core.py:WorkOrder"
      to: "backend/workorder/services/task_generation.py:DraftTaskGenerationService"
      via: "post_save signal or create method override"
      pattern: "generate_draft_tasks.*work_order"
    - from: "backend/workorder/serializers/core.py"
      to: "backend/workorder/models/core.py:WorkOrderTask"
      via: "filter draft tasks for count"
      pattern: "filter\\(status='draft'\\).count\\(\\)"
    - from: "backend/workorder/views/work_orders.py"
      to: "backend/workorder/serializers/core.py:DraftTaskSerializer"
      via: "use DraftTaskSerializer for update operations"
      pattern: "DraftTaskSerializer"
    - from: "backend/workorder/views/work_orders.py"
      to: "backend/workorder/models/core.py:WorkOrderTask"
      via: "permission check for draft task modification"
      pattern: "can_edit_draft_task|status.*==.*'draft'"
---

<objective>
Implement draft task generation service with bulk_create optimization

Purpose: Automatically generate draft tasks when a work order is created, using bulk operations to ensure performance meets the 2-second requirement for 100 tasks

Output: DraftTaskGenerationService with bulk_create optimization, integrated into work order creation flow
</objective>

<execution_context>
@/home/chenjiaxing/.claude/get-shit-done/workflows/execute-plan.md
@/home/chenjiaxing/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-draft-task-foundation/01-01-PLAN.md
@backend/workorder/models/core.py
@backend/workorder/services/business_logic.py
@backend/workorder/process_codes.py
</context>

<tasks>

<task type="auto">
  <name>Create DraftTaskGenerationService class</name>
  <files>backend/workorder/services/task_generation.py</files>
  <action>
    Create new file backend/workorder/services/task_generation.py with DraftTaskGenerationService class:

    The service should:
    1. Import WorkOrderTask, WorkOrderProcess, and Process model references
    2. Implement generate_draft_tasks(work_order) method that:
       - Takes a WorkOrder instance as parameter
       - Iterates through work_order.order_processes.all()
       - For each process, determines task types based on process code (using process_codes.ProcessCodes)
       - Uses bulk_create to insert all tasks in a single query
       - Sets status='draft' for all generated tasks
    3. Implement build_task_objects(work_order_process) method that:
       - Returns a list of WorkOrderTask instances (not saved)
       - Follows existing task generation logic from WorkOrderProcess.generate_tasks()
       - Sets status='draft' instead of 'pending'
       - Does NOT assign operators/departments (draft tasks are unassigned)

    Task generation rules (migrate from existing WorkOrderProcess.generate_tasks logic):
    - CTP (制版): one task per artwork, die, foiling_plate, embossing_plate
    - CUT (开料): one task per material with need_cutting=True
    - PRT (印刷): one task per artwork
    - FOIL_G (烫金): one task per foiling_plate
    - EMB (压凸): one task per embossing_plate
    - DIE (模切): one task per die
    - PACK (包装): one task per product
    - Other: one general task per process

    Use bulk_create with batch_size=100 for optimal performance.
  </action>
  <verify>test -f backend/workorder/services/task_generation.py && grep -c "class DraftTaskGenerationService" backend/workorder/services/task_generation.py</verify>
  <done>DraftTaskGenerationService class created with generate_draft_tasks and build_task_objects methods</done>
</task>

<task type="auto">
  <name>Add generate_draft_tasks method to WorkOrderProcess</name>
  <files>backend/workorder/models/core.py</files>
  <action>
    Add generate_draft_tasks method to WorkOrderProcess class:
    1. Import DraftTaskGenerationService at top of models/core.py
    2. Add instance method generate_draft_tasks(self) to WorkOrderProcess class
    3. Method should call DraftTaskGenerationService.build_task_objects(self) and bulk_create
    4. Return the list of created task objects

    Location: Add after the existing generate_tasks method (around line 930)

    The method should:
    - Check if tasks already exist for this process (avoid duplicates)
    - Use DraftTaskGenerationService to build task objects
    - Use WorkOrderTask.objects.bulk_create() to insert
    - Return created tasks for potential further processing
  </action>
  <verify>grep -n "def generate_draft_tasks" backend/workorder/models/core.py</verify>
  <done>WorkOrderProcess has generate_draft_tasks method that creates draft tasks using bulk_create</done>
</task>

<task type="auto">
  <name>Integrate draft task generation into work order creation</name>
  <files>backend/workorder/models/core.py</files>
  <action>
    Add automatic draft task generation when work order processes are created:
    1. Override WorkOrderProcess.save() method or use post_save signal
    2. After a process is created, automatically call generate_draft_tasks()
    3. Ensure this only happens on creation, not updates (check if self.pk is None in pre_save or use created in post_save)

    Alternative: Modify _create_work_order_processes in WorkOrderCreateUpdateSerializer to call generate_draft_tasks() after each WorkOrderProcess creation.

    Preferred approach: Update the serializer's _create_work_order_processes method in backend/workorder/serializers/core.py (around line 952) to call generate_draft_tasks() on each created process.

    This ensures draft tasks are generated immediately when work order is created with processes.
  </action>
  <verify>grep -A5 "get_or_create.*WorkOrderProcess" backend/workorder/serializers/core.py | grep -c "generate_draft_tasks"</verify>
  <done>Work order creation flow automatically generates draft tasks for all processes</done>
</task>

<task type="auto">
  <name>Add draft_task_count to work order serializers</name>
  <files>backend/workorder/serializers/core.py</files>
  <action>
    Add draft task count to WorkOrderListSerializer and WorkOrderDetailSerializer:
    1. Add SerializerMethodField for draft_task_count
    2. Implement get_draft_task_count method that:
       - Filters WorkOrderTask.objects.filter(work_order_process__work_order=instance.id, status='draft')
       - Returns the count
    3. Add total_task_count method for comparison

    This helps the frontend display task counts and show draft vs formal task distinction.
  </action>
  <verify>grep -n "draft_task_count" backend/workorder/serializers/core.py</verify>
  <done>WorkOrder serializers include draft_task_count field for API responses</done>
</task>

<task type="auto">
  <name>Add draft task edit and delete API endpoints</name>
  <files>backend/workorder/views/work_orders.py backend/workorder/urls.py backend/workorder/serializers/core.py</files>
  <action>
    Add API endpoints for editing and deleting draft tasks (TASK-02 requirement):

    1. In backend/workorder/serializers/core.py:
       - Create DraftTaskSerializer that inherits from WorkOrderTaskSerializer
       - Override validation to allow editing only when status='draft'
       - Allow editing fields: name, description, estimated_hours
       - Add validate method that checks status is 'draft' before allowing updates

    2. In backend/workorder/views/work_orders.py:
       - Add DraftTaskViewSet with:
         * get_queryset: filter only draft tasks (status='draft')
         * perform_update: validate task still has draft status before save
         * perform_destroy: validate task still has draft status before delete
         * permission_classes: allow draft task modification by work order creator
       - Add custom action: @action(detail=False, methods=['patch']) for bulk updates

    3. In backend/workorder/urls.py:
       - Register router for draft tasks: r'draft-tasks' endpoint
       - Routes: GET/PUT/PATCH /api/draft-tasks/{id}/, DELETE /api/draft-tasks/{id}/

    The endpoints should:
    - Only allow operations on tasks with status='draft'
    - Reject edit/delete if work order is already approved
    - Return 403 if trying to edit/delete non-draft task
    - Allow bulk PATCH for updating multiple draft tasks at once
  </action>
  <verify>grep -n "DraftTaskViewSet\|DraftTaskSerializer" backend/workorder/views/work_orders.py backend/workorder/serializers/core.py && grep -n "draft-tasks" backend/workorder/urls.py</verify>
  <done>API endpoints exist for editing (PATCH/PUT) and deleting draft tasks (DELETE)</done>
</task>

</tasks>

<verification>
After completion, verify:
1. Create a test work order with 5 processes via API
2. Verify draft tasks are created: WorkOrderTask.objects.filter(work_order_process__work_order=wo, status='draft').count() == expected_count
3. Performance test: Generate work order with 20 products (should create ~100 tasks), measure time < 2 seconds
4. API test: GET /api/workorders/{id}/ returns draft_task_count in response
</verification>

<success_criteria>
- DraftTaskGenerationService created with bulk_create optimization
- Work order creation immediately generates draft tasks for all processes
- 100 tasks generated in under 2 seconds
- draft_task_count included in work order API responses
</success_criteria>

<output>
After completion, create `.planning/phases/01-draft-task-foundation/01-02-SUMMARY.md`
</output>
