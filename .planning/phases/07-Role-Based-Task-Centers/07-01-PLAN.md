---
phase: 07-Role-Based-Task-Centers
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/workorder/views/work_order_tasks/task_stats.py
  - frontend/src/api/modules/workorder-task.js
  - frontend/src/views/task/SupervisorDashboard.vue
  - frontend/src/router/index.js
autonomous: true

must_haves:
  truths:
    - "Department supervisor can view all tasks in their department"
    - "Supervisor sees workload statistics for each operator (task count, completion rate)"
    - "Dashboard displays pending, in-progress, and completed task counts per operator"
    - "Tasks are grouped by operator with visual workload indicators"
    - "Supervisor can filter by status, priority, and date range"
  artifacts:
    - path: "backend/workorder/views/work_order_tasks/task_stats.py"
      provides: "Department workload statistics API endpoint"
      exports: ["department_workload"]
    - path: "frontend/src/views/task/SupervisorDashboard.vue"
      provides: "Supervisor dashboard component with operator workload cards"
      min_lines: 150
    - path: "frontend/src/api/modules/workorder-task.js"
      provides: "API method for fetching department workload stats"
      exports: ["getDepartmentWorkload"]
  key_links:
    - from: "frontend/src/views/task/SupervisorDashboard.vue"
      to: "/workorder-tasks/department_workload/"
      via: "workOrderTaskAPI.getDepartmentWorkload()"
      pattern: "getDepartmentWorkload.*department_id"
---

<objective>
Build supervisor dashboard with department task view and operator workload statistics

Purpose: Supervisors need a centralized view of all department tasks and operator workloads to make informed assignment decisions. The dashboard provides visibility into who is overloaded, who is available, and overall department progress.

Output: A new SupervisorDashboard page displaying department workload statistics, operator task counts, and a unified task table filtered by department.
</objective>

<execution_context>
@/home/chenjiaxing/.claude/get-shit-done/workflows/execute-plan.md
@/home/chenjiaxing/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Reference existing task infrastructure
@backend/workorder/views/work_order_tasks/task_stats.py
@backend/workorder/serializers/core.py
@frontend/src/views/task/TaskList.vue
@frontend/src/api/modules/workorder-task.js
</context>

<tasks>

<task type="auto">
  <name>Create department workload statistics API endpoint</name>
  <files>backend/workorder/views/work_order_tasks/task_stats.py</files>
  <action>
    Add a new action method `department_workload` to TaskStatsMixin:

    ```
    @action(detail=False, methods=['get'])
    def department_workload(self, request):
        '''Department workload statistics for supervisor dashboard

        GET /workorder-tasks/department_workload/?department_id=123

        Returns:
        - Department summary (total tasks, completion rate)
        - Operator workloads (task count per operator by status)
        - Task distribution by priority
        - Recent task activity
        '''
    ```

    Implementation requirements:
    - Accept `department_id` query parameter (use user's department if not provided)
    - Filter tasks by assigned_department
    - Aggregate by assigned_operator for workload stats
    - Calculate completion rate: completed_tasks / total_tasks * 100
    - Include counts: pending, in_progress, completed, cancelled per operator
    - Add task count by priority (urgent, high, normal, low)
    - Return response structure:
      ```python
      {
          'department_id': int,
          'department_name': str,
          'summary': {
              'total_tasks': int,
              'pending_tasks': int,
              'in_progress_tasks': int,
              'completed_tasks': int,
              'completion_rate': float
          },
          'operators': [
              {
                  'operator_id': int,
                  'operator_name': str,
                  'pending_count': int,
                  'in_progress_count': int,
                  'completed_count': int,
                  'total_count': int,
                  'completion_rate': float
              }
          ],
          'priority_distribution': {
              'urgent': int,
              'high': int,
              'normal': int,
              'low': int
          }
      }
      ```

    Permission check: Only supervisors (users with `change_workorder` perm) can access. Use existing permission pattern from task_main.py.

    Use select_related/prefetch_related for query optimization:
    - select_related: assigned_department, assigned_operator
    - No N+1 queries when iterating operators
  </action>
  <verify>
    Run GET request to /workorder-tasks/department_workload/?department_id=1
    Verify response contains summary, operators array, priority_distribution
    Verify completion_rate is calculated correctly
  </verify>
  <done>
    API endpoint returns department workload statistics with operator-level breakdown
  </done>
</task>

<task type="auto">
  <name>Add frontend API method for department workload</name>
  <files>frontend/src/api/modules/workorder-task.js</files>
  <action>
    Add `getDepartmentWorkload(params)` method to WorkOrderTaskAPI class:

    ```javascript
    // 获取部门工作负载统计（主管看板）
    getDepartmentWorkload(params) {
      return this.request({
        url: `${this.baseUrl}department_workload/`,
        method: 'get',
        params  // { department_id, start_date, end_date }
      })
    }
    ```

    Place after `getCollaborationStats` method (around line 106).
    Follow existing API method pattern in the file.
  </action>
  <verify>
    Check that method exists in workorderTaskAPI export
    Verify method signature matches backend endpoint
  </verify>
  <done>
    Frontend API can call getDepartmentWorkload({ department_id: 1 })
  </done>
</task>

<task type="auto">
  <name>Create SupervisorDashboard Vue component</name>
  <files>frontend/src/views/task/SupervisorDashboard.vue</files>
  <action>
    Create new SupervisorDashboard.vue component with:

    Template structure:
    1. Page header with department selector (if supervisor has multiple departments)
    2. Summary cards row: Total Tasks, Pending, In Progress, Completion Rate
    3. Operator Workload section: Grid of cards, one per operator
       - Each card shows: operator name, avatar, pending/in-progress/completed counts
       - Visual progress bar for completion rate
       - Click to filter task list by that operator
    4. Task list table (reused from TaskList with department filter)
    5. Priority distribution chart (simple bar chart using Element UI progress bars)

    Component structure:
    ```javascript
    import { workOrderTaskAPI, departmentAPI } from '@/api/modules'
    import ErrorHandler from '@/utils/errorHandler'

    export default {
      name: 'SupervisorDashboard',
      data() {
        return {
          loading: false,
          departmentList: [],
          selectedDepartment: null,
          workloadData: null,
          summary: {}
        }
      },
      computed: {
        isSupervisor() {
          return this.$store.getters['auth/hasPermission']('workorder.change_workorder')
        }
      },
      methods: {
        async loadDepartmentList() { /* fetch user's departments */ },
        async loadWorkloadData() { /* call getDepartmentWorkload */ },
        handleOperatorClick(operatorId) { /* navigate to task list filtered by operator */ }
      }
    }
    ```

    Use Element UI components:
    - el-select for department selector
    - el-card for summary cards and operator cards
    - el-row/el-col for responsive grid layout
    - el-progress for completion rate visualization
    - el-tag for status indicators

    Styling:
    - Use grid layout (gutter=20) for operator cards
    - Color code: pending (warning), in_progress (primary), completed (success)
    - Show "暂无数据" when no operators
  </action>
  <verify>
    Component renders without console errors
    Department selector populates with user's departments
    Workload data displays operator cards with correct counts
    Clicking operator navigates to /tasks?assigned_operator=X
  </verify>
  <done>
    SupervisorDashboard page displays department workload with operator-level statistics
  </done>
</task>

<task type="auto">
  <name>Add supervisor dashboard route to router</name>
  <files>frontend/src/router/index.js</files>
  <action>
    Add new route after TaskBoard route (around line 177):

    ```javascript
    {
      path: 'tasks/supervisor',
      name: 'SupervisorDashboard',
      component: () => import(/* webpackChunkName: "task-supervisor" */ '@/views/task/SupervisorDashboard.vue'),
      meta: { title: '主管看板', requiresAuth: true }
    },
    ```

    Ensure it's placed within the Layout children array.
    Use webpackChunkName: "task-supervisor" for code splitting.
  </action>
  <verify>
    Route is accessible at /tasks/supervisor
    Page title shows as "主管看板 - 印刷施工单跟踪系统"
  </verify>
  <done>
    Supervisor dashboard accessible via /tasks/supervisor route
  </done>
</task>

</tasks>

<verification>
1. Access /tasks/supervisor as a supervisor user
2. Verify department selector shows user's departments
3. Verify summary cards display accurate task counts
4. Verify operator cards show individual workload statistics
5. Verify clicking an operator card filters the task list
6. Verify completion rate is calculated correctly
7. Test with different departments (if supervisor has multiple)
</verification>

<success_criteria>
- Supervisor can view all tasks in their department on a single dashboard
- Operator workload statistics are displayed (task count, completion rate per operator)
- Visual indicators show which operators are overloaded vs available
- Dashboard filters by department, status, and priority
- API completes in under 500ms for departments with up to 1000 tasks
</success_criteria>

<output>
After completion, create `.planning/phases/07-Role-Based-Task-Centers/07-01-SUMMARY.md`
</output>
