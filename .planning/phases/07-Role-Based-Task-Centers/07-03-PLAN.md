---
phase: 07-Role-Based-Task-Centers
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/workorder/views/work_order_tasks/task_main.py
  - frontend/src/api/modules/workorder-task.js
  - frontend/src/views/task/OperatorCenter.vue
  - frontend/src/router/index.js
autonomous: true

must_haves:
  truths:
    - "Operator can view their personalized task center showing assigned and claimable tasks"
    - "Center displays two task pools: 'My Tasks' (assigned to me) and 'Claimable Tasks' (unassigned in my department)"
    - "Operators can one-click claim tasks from the claimable pool"
    - "Tasks show status, priority, progress, and work content"
    - "Center is only accessible to operator role users"
  artifacts:
    - path: "backend/workorder/views/work_order_tasks/task_main.py"
      provides: "Enhanced claimable endpoint with operator context"
      exports: ["claimable"]
    - path: "frontend/src/views/task/OperatorCenter.vue"
      provides: "Operator task center with assigned and claimable task pools"
      min_lines: 200
    - path: "frontend/src/api/modules/workorder-task.js"
      provides: "API method for operator task center data"
      exports: ["getOperatorCenterData"]
  key_links:
    - from: "frontend/src/views/task/OperatorCenter.vue"
      to: "/workorder-tasks/claimable/"
      via: "workOrderTaskAPI.getClaimableTasks()"
      pattern: "getClaimableTasks"
    - from: "frontend/src/views/task/OperatorCenter.vue"
      to: "/workorder-tasks/"
      via: "workOrderTaskAPI.getList({ assigned_operator: userId })"
      pattern: "getList.*assigned_operator"
---

<objective>
Create operator task center with assigned and claimable task pools

Purpose: Provide operators with a personalized view showing their assigned tasks and tasks they can claim from their department. This gives operators autonomy to manage their workload by claiming available tasks.

Output: A new OperatorCenter page displaying two distinct task pools with quick claim functionality.
</objective>

<execution_context>
@/home/chenjiaxing/.claude/get-shit-done/workflows/execute-plan.md
@/home/chenjiaxing/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Reference existing task claim infrastructure
@backend/workorder/views/work_order_tasks/task_main.py
@frontend/src/views/task/TaskList.vue
@frontend/src/api/modules/workorder-task.js
@frontend/src/views/Dashboard.vue
</context>

<tasks>

<task type="auto">
  <name>Create getOperatorCenterData API method</name>
  <files>frontend/src/api/modules/workorder-task.js</files>
  <action>
    Add `getOperatorCenterData(params)` method to WorkOrderTaskAPI class:

    ```javascript
    // 获取操作员任务中心数据（我的任务 + 可认领任务）
    getOperatorCenterData(params) {
      return this.request({
        url: `${this.baseUrl}operator_center/`,
        method: 'get',
        params  // Optional: { status, priority }
      })
    }
    ```

    Place after `getClaimableTasks` method (around line 83).
    This will call a new backend endpoint that returns both assigned and claimable tasks in one response.
  </action>
  <verify>
    Method exists in workOrderTaskAPI export
    Method signature accepts optional filters
  </verify>
  <done>
    Frontend has method to fetch operator center data
  </done>
</task>

<task type="auto">
  <name>Add operator_center API endpoint to backend</name>
  <files>backend/workorder/views/work_order_tasks/task_main.py</files>
  <action>
    Add new action `operator_center` to BaseWorkOrderTaskViewSet:

    ```python
    @action(detail=False, methods=['get'], url_path='operator_center')
    def operator_center(self, request):
        '''Operator task center data: assigned tasks + claimable tasks

        GET /workorder-tasks/operator_center/

        Returns combined data for operator task center:
        - my_tasks: Tasks assigned to current user
        - claimable_tasks: Unassigned tasks in user's department
        - summary: Task counts by status

        Permission: Must be an operator (non-superuser)
        '''
        from workorder.services.task_assignment import TaskAssignmentService

        user = request.user

        # Get user's departments
        user_departments = user.profile.departments.all() if hasattr(user, 'profile') else []
        if not user_departments:
            return Response({
                'detail': '您未分配到任何部门',
                'my_tasks': [],
                'claimable_tasks': [],
                'summary': {}
            }, status=status.HTTP_200_OK)

        # Get my assigned tasks
        my_tasks_qs = self.get_queryset().filter(assigned_operator=user)
        my_tasks_qs = self.filter_queryset(my_tasks_qs)
        my_tasks_qs = my_tasks_qs.select_related(
            'assigned_department', 'work_order_process',
            'work_order_process__work_order', 'work_order_process__process'
        )[:100]  # Limit to 100 most recent

        # Get claimable tasks (unassigned in user's departments)
        claimable_ids = TaskAssignmentService.get_claimable_tasks_for_user(user)
        claimable_tasks_qs = self.get_queryset().filter(
            id__in=claimable_ids,
            assigned_operator__isnull=True
        )
        claimable_tasks_qs = claimable_tasks_qs.select_related(
            'assigned_department', 'work_order_process',
            'work_order_process__work_order', 'work_order_process__process'
        )[:50]  # Limit to 50 claimable tasks

        # Serialize
        my_serializer = self.get_serializer(my_tasks_qs, many=True)
        claimable_serializer = self.get_serializer(claimable_tasks_qs, many=True)

        # Calculate summary
        my_tasks = list(my_tasks_qs)
        summary = {
            'my_total': len(my_tasks),
            'my_pending': sum(1 for t in my_tasks if t.status == 'pending'),
            'my_in_progress': sum(1 for t in my_tasks if t.status == 'in_progress'),
            'my_completed': sum(1 for t in my_tasks if t.status == 'completed'),
            'claimable_count': len(claimable_ids)
        }

        return Response({
            'my_tasks': my_serializer.data,
            'claimable_tasks': claimable_serializer.data,
            'summary': summary
        })
    ```

    Add after `claimable` action (around line 323).
    Use existing get_queryset for permission filtering.
  </action>
  <verify>
    Endpoint returns my_tasks, claimable_tasks, summary
    my_tasks contains only user's assigned tasks
    claimable_tasks contains unassigned tasks in user's department
    Summary counts are accurate
  </verify>
  <done>
    Backend provides operator center data endpoint
  </done>
</task>

<task type="auto">
  <name>Create OperatorCenter Vue component</name>
  <files>frontend/src/views/task/OperatorCenter.vue</files>
  <action>
    Create new OperatorCenter.vue component with:

    Template structure:
    ```vue
    <template>
      <div class="operator-center">
        <!-- Summary cards row -->
        <el-row :gutter="20" class="summary-row">
          <el-col :span="6">
            <el-card class="summary-card">
              <div class="stat-value">{{ summary.my_total || 0 }}</div>
              <div class="stat-label">我的任务</div>
            </el-card>
          </el-col>
          <el-col :span="6">
            <el-card class="summary-card pending">
              <div class="stat-value">{{ summary.my_pending || 0 }}</div>
              <div class="stat-label">待开始</div>
            </el-card>
          </el-col>
          <el-col :span="6">
            <el-card class="summary-card progress">
              <div class="stat-value">{{ summary.my_in_progress || 0 }}</div>
              <div class="stat-label">进行中</div>
            </el-card>
          </el-col>
          <el-col :span="6">
            <el-card class="summary-card claimable">
              <div class="stat-value">{{ summary.claimable_count || 0 }}</div>
              <div class="stat-label">可认领</div>
            </el-card>
          </el-col>
        </el-row>

        <!-- Two-column layout: My Tasks | Claimable Tasks -->
        <el-row :gutter="20" class="task-pools">
          <!-- My Tasks -->
          <el-col :span="12">
            <el-card class="task-pool-card">
              <div slot="header" class="card-header">
                <span>我的任务</span>
                <el-tag :type="getPoolType('my')">{{ summary.my_total || 0 }}</el-tag>
              </div>
              <el-tabs v-model="myTasksActiveTab">
                <el-tab-pane label="全部" name="all">
                  <TaskList :tasks="myTasks" @task-click="handleTaskClick" />
                </el-tab-pane>
                <el-tab-pane label="待开始" name="pending">
                  <TaskList :tasks="myTasksByStatus('pending')" @task-click="handleTaskClick" />
                </el-tab-pane>
                <el-tab-pane label="进行中" name="in_progress">
                  <TaskList :tasks="myTasksByStatus('in_progress')" @task-click="handleTaskClick" />
                </el-tab-pane>
              </el-tabs>
            </el-card>
          </el-col>

          <!-- Claimable Tasks -->
          <el-col :span="12">
            <el-card class="task-pool-card">
              <div slot="header" class="card-header">
                <span>可认领任务</span>
                <el-tag type="warning">{{ summary.claimable_count || 0 }}</el-tag>
              </div>
              <TaskList
                :tasks="claimableTasks"
                show-claim-button
                @claim="handleClaim"
                @task-click="handleTaskClick"
              />
              <el-empty v-if="claimableTasks.length === 0" description="暂无可认领任务" />
            </el-card>
          </el-col>
        </el-row>
      </div>
    </template>
    ```

    Component structure:
    ```javascript
    import { workOrderTaskAPI } from '@/api/modules'
    import ErrorHandler from '@/utils/errorHandler'

    export default {
      name: 'OperatorCenter',
      data() {
        return {
          loading: false,
          myTasks: [],
          claimableTasks: [],
          summary: {},
          myTasksActiveTab: 'all',
          claimingTaskId: null
        }
      },
      computed: {
        isOperator() {
          return !this.$store.getters['user/hasPermission']('workorder.change_workorder')
        },
        myTasksByStatus() {
          return (status) => this.myTasks.filter(t => t.status === status)
        }
      },
      created() {
        if (!this.isOperator) {
          this.$message.warning('此页面仅供操作员使用')
          this.$router.push('/tasks')
          return
        }
        this.loadData()
      },
      methods: {
        async loadData() {
          this.loading = true
          try {
            const response = await workOrderTaskAPI.getOperatorCenterData()
            this.myTasks = response.my_tasks || []
            this.claimableTasks = response.claimable_tasks || []
            this.summary = response.summary || {}
          } catch (error) {
            ErrorHandler.showMessage(error, '加载任务中心')
          } finally {
            this.loading = false
          }
        },
        async handleClaim(task) {
          try {
            this.claimingTaskId = task.id
            await workOrderTaskAPI.claimTask(task.id)
            ErrorHandler.showSuccess('任务认领成功')
            await this.loadData()
          } catch (error) {
            ErrorHandler.handleTaskError(error)
          } finally {
            this.claimingTaskId = null
          }
        },
        handleTaskClick(task) {
          this.$router.push(`/tasks?task=${task.id}`)
        },
        getPoolType(pool) {
          return pool === 'claimable' ? 'warning' : 'primary'
        }
      }
    }
    ```

    Use Element UI components: el-card, el-row, el-col, el-tabs, el-tag, el-empty
    Create TaskList sub-component for displaying task cards with claim button support
    Styling: flex layout, colored stat cards, task list with hover effects
  </action>
  <verify>
    Component renders without console errors
    Summary cards display correct counts
    My tasks tab shows user's assigned tasks
    Claimable tasks show department's unassigned tasks
    Claim button calls API and refreshes data
    Non-operators are redirected to /tasks
  </verify>
  <done>
    OperatorCenter page displays personalized task pools with quick claim functionality
  </done>
</task>

<task type="auto">
  <name>Add operator center route to router</name>
  <files>frontend/src/router/index.js</files>
  <action>
    Add new route after SupervisorDashboard route:

    ```javascript
    {
      path: 'tasks/operator',
      name: 'OperatorCenter',
      component: () => import(/* webpackChunkName: "task-operator" */ '@/views/task/OperatorCenter.vue'),
      meta: { title: '操作员任务中心', requiresAuth: true }
    },
    ```

    Place within Layout children array.
    Use webpackChunkName: "task-operator" for code splitting.
  </action>
  <verify>
    Route is accessible at /tasks/operator
    Page title shows correctly
  </verify>
  <done>
    Operator center accessible via /tasks/operator route
  </done>
</task>

<task type="auto">
  <name>Create TaskList sub-component for operator center</name>
  <files>frontend/src/views/task/components/OperatorTaskList.vue</files>
  <action>
    Create OperatorTaskList.vue component for displaying tasks in operator center:

    Template:
    ```vue
    <template>
      <div class="operator-task-list">
        <el-scrollbar wrap-class="scrollbar-wrapper">
          <div
            v-for="task in tasks"
            :key="task.id"
            class="task-card"
            :class="`priority-${task.priority}`"
            @click="$emit('task-click', task)"
          >
            <div class="task-header">
              <el-tag :type="getStatusType(task.status)" size="small">
                {{ task.status_display }}
              </el-tag>
              <el-tag v-if="task.priority === 'urgent'" type="danger" size="small">紧急</el-tag>
            </div>
            <div class="task-content">{{ task.work_content }}</div>
            <div class="task-meta">
              <span>{{ task.work_order_process_info?.work_order?.order_number || '-' }}</span>
              <span>{{ task.work_order_process_info?.process?.name || '-' }}</span>
            </div>
            <div class="task-progress" v-if="task.production_quantity">
              <el-progress
                :percentage="getProgress(task)"
                :stroke-width="6"
                :show-text="false"
              />
              <span class="progress-text">{{ task.quantity_completed }}/{{ task.production_quantity }}</span>
            </div>
            <div class="task-actions" v-if="showClaimButton && !task.assigned_operator">
              <el-button
                type="primary"
                size="small"
                :loading="claimingTaskId === task.id"
                @click.stop="$emit('claim', task)"
              >
                认领
              </el-button>
            </div>
          </div>
        </el-scrollbar>
        <el-empty v-if="tasks.length === 0" :description="emptyText" />
      </div>
    </template>
    ```

    Component accepts props: tasks, showClaimButton, claimingTaskId, emptyText
    Emits: task-click, claim
    Styles: card layout, priority colored borders, hover effects
  </action>
  <verify>
    Component renders task cards correctly
    Click on card emits task-click event
    Claim button emits claim event
    Progress bar displays correctly
    Empty state shows when no tasks
  </verify>
  <done>
    Task list component displays tasks with claim functionality
  </done>
</task>

</tasks>

<verification>
1. Access /tasks/operator as an operator user
2. Verify summary cards show correct task counts
3. Verify "My Tasks" shows only user's assigned tasks
4. Verify "Claimable Tasks" shows unassigned department tasks
5. Click claim button on a claimable task
6. Verify task moves to "My Tasks" after claim
7. Verify summary counts update
8. Test tab filtering in My Tasks (all, pending, in_progress)
</verification>

<success_criteria>
- Operators see personalized task center with two task pools
- My Tasks shows assigned tasks grouped by status tabs
- Claimable Tasks shows unassigned department tasks
- One-click claim works and moves task to My Tasks
- Non-operators are redirected to task list
</success_criteria>

<output>
After completion, create `.planning/phases/07-Role-Based-Task-Centers/07-03-SUMMARY.md`
</output>
