---
phase: 07-Role-Based-Task-Centers
plan: 04
type: execute
wave: 2
depends_on: ["07-03"]
files_modified:
  - frontend/src/views/task/OperatorCenter.vue
  - frontend/src/views/task/components/OperatorTaskUpdateDialog.vue
  - backend/workorder/views/work_order_tasks/task_actions.py
  - frontend/src/api/modules/workorder-task.js
autonomous: false

must_haves:
  truths:
    - "Operator can update task progress and completion quantities directly from their task center"
    - "Update dialog shows current quantity, completion quantity, and allows increment input"
    - "Operator can mark tasks as complete with optional notes and completion reason"
    - "Progress updates are reflected immediately in the task list"
    - "Operators can only update their own assigned tasks"
  artifacts:
    - path: "frontend/src/views/task/components/OperatorTaskUpdateDialog.vue"
      provides: "Dialog for updating task progress and marking complete"
      min_lines: 150
    - path: "frontend/src/views/task/OperatorCenter.vue"
      provides: "Updated operator center with task update functionality"
      exports: ["showUpdateDialog", "showCompleteDialog", "handleTaskUpdate"]
  key_links:
    - from: "frontend/src/views/task/components/OperatorTaskUpdateDialog.vue"
      to: "frontend/src/api/modules/workorder-task.js"
      via: "workOrderTaskAPI.updateQuantity()"
      pattern: "updateQuantity"
    - from: "frontend/src/views/task/components/OperatorTaskUpdateDialog.vue"
      to: "/workorder-tasks/{id}/complete/"
      via: "workOrderTaskAPI.complete()"
      pattern: "complete"
---

<objective>
Add operator task progress update and completion tracking

Purpose: Enable operators to update their task progress directly from the operator center, providing a streamlined workflow for tracking work completion without navigating to the full task list.

Output: Update dialogs integrated into OperatorCenter for progress updates and task completion.
</objective>

<execution_context>
@/home/chenjiaxing/.claude/get-shit-done/workflows/execute-plan.md
@/home/chenjiaxing/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Reference existing task update patterns
@backend/workorder/views/work_order_tasks/task_actions.py
@frontend/src/views/task/components/UpdateTaskDialog.vue
@frontend/src/views/task/components/CompleteTaskDialog.vue
@frontend/src/views/task/TaskList.vue
</context>

<tasks>

<task type="auto">
  <name>Create OperatorTaskUpdateDialog component</name>
  <files>frontend/src/views/task/components/OperatorTaskUpdateDialog.vue</files>
  <action>
    Create new OperatorTaskUpdateDialog.vue component combining progress update and completion:

    Template structure:
    ```vue
    <template>
      <el-dialog
        :visible.sync="dialogVisible"
        :title="dialogTitle"
        width="500px"
        @close="handleClose"
      >
        <el-form ref="form" :model="form" :rules="rules" label-width="100px">
          <!-- Task info display -->
          <el-form-item label="任务内容">
            <div class="task-info">{{ task.work_content }}</div>
          </el-form-item>

          <!-- Current progress -->
          <el-form-item label="当前进度">
            <el-progress
              :percentage="currentProgress"
              :color="progressColor"
            />
            <div class="progress-text">
              {{ task.quantity_completed || 0 }} / {{ task.production_quantity || 0 }}
            </div>
          </el-form-item>

          <!-- Update mode toggle -->
          <el-radio-group v-model="updateMode" style="margin-bottom: 20px;">
            <el-radio-button label="increment">增量更新</el-radio-button>
            <el-radio-button label="complete">直接完成</el-radio-button>
          </el-radio-group>

          <!-- Increment mode -->
          <template v-if="updateMode === 'increment'">
            <el-form-item label="本次完成数量" prop="quantity_increment">
              <el-input-number
                v-model="form.quantity_increment"
                :min="0"
                :max="maxIncrement"
                :step="1"
                controls-position="right"
                style="width: 100%;"
              />
              <div class="hint">更新后进度: {{ projectedCompleted }} / {{ task.production_quantity }}</div>
            </el-form-item>

            <el-form-item label="不良品数量" prop="quantity_defective">
              <el-input-number
                v-model="form.quantity_defective"
                :min="0"
                :step="1"
                controls-position="right"
                style="width: 100%;"
              />
            </el-form-item>
          </template>

          <!-- Complete mode -->
          <template v-if="updateMode === 'complete'">
            <el-form-item label="完成理由">
              <el-input
                v-model="form.completion_reason"
                type="textarea"
                :rows="2"
                placeholder="请输入完成理由（可选）"
              />
            </el-form-item>

            <el-form-item label="不良品数量">
              <el-input-number
                v-model="form.quantity_defective"
                :min="0"
                :max="task.production_quantity"
                :step="1"
                controls-position="right"
                style="width: 100%;"
              />
            </el-form-item>
          </template>

          <!-- Notes (both modes) -->
          <el-form-item label="备注">
            <el-input
              v-model="form.notes"
              type="textarea"
              :rows="2"
              placeholder="请输入备注（可选）"
            />
          </el-form-item>
        </el-form>

        <span slot="footer" class="dialog-footer">
          <el-button @click="handleClose">取消</el-button>
          <el-button type="primary" :loading="submitting" @click="handleSubmit">
            {{ updateMode === 'complete' ? '确认完成' : '确认更新' }}
          </el-button>
        </span>
      </el-dialog>
    </template>
    ```

    Component script:
    ```javascript
    import { workOrderTaskAPI } from '@/api/modules'
    import ErrorHandler from '@/utils/errorHandler'

    export default {
      name: 'OperatorTaskUpdateDialog',
      props: {
        visible: Boolean,
        task: {
          type: Object,
          default: () => ({})
        }
      },
      data() {
        return {
          updateMode: 'increment',  // 'increment' or 'complete'
          submitting: false,
          form: {
            quantity_increment: 0,
            quantity_defective: 0,
            completion_reason: '',
            notes: ''
          },
          rules: {
            quantity_increment: [
              { required: true, message: '请输入完成数量', trigger: 'blur' },
              { type: 'number', min: 1, message: '数量必须大于0', trigger: 'blur' }
            ]
          }
        }
      },
      computed: {
        dialogVisible: {
          get() { return this.visible },
          set(val) { this.$emit('update:visible', val) }
        },
        dialogTitle() {
          return this.updateMode === 'complete' ? '完成任务' : '更新进度'
        },
        currentProgress() {
          if (!this.task.production_quantity) return 0
          return Math.round((this.task.quantity_completed / this.task.production_quantity) * 100)
        },
        progressColor() {
          const p = this.currentProgress
          if (p >= 100) return '#67C23A'
          if (p >= 50) return '#409EFF'
          return '#E6A23C'
        },
        maxIncrement() {
          return (this.task.production_quantity || 0) - (this.task.quantity_completed || 0)
        },
        projectedCompleted() {
          return (this.task.quantity_completed || 0) + (this.form.quantity_increment || 0)
        }
      },
      watch: {
        visible(val) {
          if (val) {
            this.resetForm()
          }
        }
      },
      methods: {
        resetForm() {
          this.updateMode = 'increment'
          this.form = {
            quantity_increment: 1,
            quantity_defective: 0,
            completion_reason: '',
            notes: ''
          }
          this.$nextTick(() => {
            this.$refs.form?.clearValidate()
          })
        },
        async handleSubmit() {
          const valid = await this.$refs.form.validate().catch(() => false)
          if (!valid) return

          this.submitting = true
          try {
            if (this.updateMode === 'complete') {
              await workOrderTaskAPI.complete(this.task.id, this.form)
              ErrorHandler.showSuccess('任务已完成')
            } else {
              await workOrderTaskAPI.updateQuantity(this.task.id, {
                ...this.form,
                version: this.task.version
              })
              ErrorHandler.showSuccess('进度已更新')
            }
            this.$emit('success')
            this.handleClose()
          } catch (error) {
            if (error.response?.status === 409) {
              ErrorHandler.showError('任务已被其他操作员更新，请刷新后重试')
            } else {
              ErrorHandler.showMessage(error, this.updateMode === 'complete' ? '完成任务' : '更新进度')
            }
          } finally {
            this.submitting = false
          }
        },
        handleClose() {
          this.dialogVisible = false
        }
      }
    }
    ```

    Styles:
    - Progress bar with color coding
    - Hint text for projected progress
    - Form spacing and alignment
    - Task info section with gray background
  </action>
  <verify>
    Component renders without errors
    Increment mode shows quantity input with max validation
    Complete mode shows completion reason textarea
    Progress bar displays current status accurately
    Form validation works (required fields)
  </verify>
  <done>
    OperatorTaskUpdateDialog provides combined progress update and completion interface
  </done>
</task>

<task type="auto">
  <name>Integrate update dialog into OperatorCenter</name>
  <files>frontend/src/views/task/OperatorCenter.vue</files>
  <action>
    Update OperatorCenter.vue to integrate task update functionality:

    1. Import dialog component:
    ```javascript
    import OperatorTaskUpdateDialog from './components/OperatorTaskUpdateDialog.vue'

    components: {
      OperatorTaskUpdateDialog,
      // ... existing components
    }
    ```

    2. Add data properties:
    ```javascript
    data() {
      return {
        // ... existing data
        updateDialogVisible: false,
        currentTask: null
      }
    }
    ```

    3. Add dialog to template (after task-pools section):
    ```vue
    <OperatorTaskUpdateDialog
      :visible.sync="updateDialogVisible"
      :task="currentTask"
      @success="handleUpdateSuccess"
    />
    ```

    4. Add update button to task cards (in OperatorTaskList or inline):
    ```vue
    <!-- Add to each task card -->
    <div class="task-actions" v-if="isMyTask(task)">
      <el-button-group>
        <el-button size="mini" icon="el-icon-edit" @click.stop="showUpdateDialog(task)">
          更新
        </el-button>
        <el-button
          v-if="canComplete(task)"
          size="mini"
          type="success"
          icon="el-icon-check"
          @click.stop="showCompleteDialog(task)"
        >
          完成
        </el-button>
      </el-button-group>
    </div>
    ```

    5. Add handler methods:
    ```javascript
    methods: {
      // ... existing methods

      showUpdateDialog(task) {
        this.currentTask = { ...task }
        this.updateDialogVisible = true
      },

      showCompleteDialog(task) {
        this.currentTask = { ...task }
        this.updateDialogVisible = true
        // Set complete mode after dialog opens
        this.$nextTick(() => {
          const dialog = this.$children.find(c => c.$options.name === 'OperatorTaskUpdateDialog')
          if (dialog) dialog.updateMode = 'complete'
        })
      },

      async handleUpdateSuccess() {
        await this.loadData()
      },

      isMyTask(task) {
        const currentUser = this.$store.getters['user/currentUser']
        return task.assigned_operator === currentUser?.id
      },

      canComplete(task) {
        return this.isMyTask(task) && ['pending', 'in_progress'].includes(task.status)
      }
    }
    ```

    6. Update OperatorTaskList component to emit update/complete events:
    - Add update-button and complete-button slots
    - Emit events when buttons are clicked
  </action>
  <verify>
    Update button appears on user's own tasks
    Clicking update opens dialog with current task data
    Increment mode allows quantity input
    Complete mode shows completion reason field
    Submitting updates task and refreshes list
    Progress displays updated values
  </verify>
  <done>
    OperatorCenter integrates task update dialog with progress tracking
  </done>
</task>

<task type="auto">
  <name>Verify backend API handles operator updates correctly</name>
  <files>backend/workorder/views/work_order_tasks/task_actions.py</files>
  <action>
    Verify existing update_quantity and complete actions handle operator scenarios:

    Check that task_actions.py update_quantity action:
    - Validates operator owns the task (assigned_operator == request.user)
    - Allows department supervisors to update department tasks
    - Returns 403 for unauthorized updates
    - Uses version checking for concurrent updates
    - Records task log with operator information

    Check that task_actions.py complete action:
    - Has same permission checks as update_quantity
    - Sets status to completed
    - Updates quantity_completed to production_quantity
    - Creates completion log entry

    Both actions should already exist from Phase 6. Verify they handle operator use case:
    - Permission check: `task.assigned_operator == user` for operators
    - Supervisor bypass: `user.has_perm('workorder.change_workorder')`
    - Version conflict: returns 409 with current_version

    If any validation is missing, add it following the pattern in update_quantity.
  </action>
  <verify>
    Operators can update their own tasks
    Operators cannot update other operators' tasks
    Supervisors can update any department task
    Version checking prevents concurrent update conflicts
    Task logs record operator who performed update
  </verify>
  <done>
    Backend correctly handles operator task updates with proper permissions
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Operator task progress update and completion tracking:
    - OperatorTaskUpdateDialog with increment and complete modes
    - Integration into OperatorCenter with update buttons
    - Progress tracking with real-time updates
    - Permission checks for operator-only updates
  </what-built>
  <how-to-verify>
    1. Navigate to /tasks/operator as an operator user
    2. Find a task assigned to you
    3. Click "更新" button to open update dialog
    4. Enter increment quantity and verify projected progress display
    5. Submit and verify task progress updates in the list
    6. Click "完成" button on another task
    7. Enter completion reason and submit
    8. Verify task status changes to completed
    9. Try updating a task not assigned to you (should fail)
    10. Verify summary counts update after changes
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Open OperatorCenter as an operator user
2. Click update button on an assigned task
3. Enter increment quantity and submit
4. Verify progress updates in the task list
5. Click complete button on another task
6. Enter completion reason and submit
7. Verify task moves to completed status
8. Verify unauthorized update attempts fail with 403
9. Verify concurrent update conflicts are detected (409)
</verification>

<success_criteria>
- Operators can update task progress with increment input
- Operators can complete tasks with optional reason
- Progress updates reflect immediately in the UI
- Permission checks prevent unauthorized updates
- Version conflicts are detected and handled
</success_criteria>

<output>
After completion, create `.planning/phases/07-Role-Based-Task-Centers/07-04-SUMMARY.md`
</output>
