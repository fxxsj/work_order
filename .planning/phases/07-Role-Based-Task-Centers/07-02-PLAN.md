---
phase: 07-Role-Based-Task-Centers
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - frontend/src/views/task/SupervisorDashboard.vue
  - frontend/src/views/task/components/TaskDragDropList.vue
  - backend/workorder/views/work_order_tasks/task_bulk.py
  - frontend/src/api/modules/workorder-task.js
autonomous: false

must_haves:
  truths:
    - "Supervisor can drag unassigned tasks to operator columns for assignment"
    - "Supervisor can drag tasks between operator columns to reassign"
    - "Drop operation calls batchAssign API with operator_id"
    - "Visual feedback shows valid drop zones during drag"
    - "Assignment is confirmed before being applied (confirm dialog)"
  artifacts:
    - path: "frontend/src/views/task/components/TaskDragDropList.vue"
      provides: "Drag-and-drop task list component with operator columns"
      min_lines: 200
    - path: "frontend/src/views/task/SupervisorDashboard.vue"
      provides: "Updated supervisor dashboard with drag-drop mode toggle"
      exports: ["toggleDragMode", "handleTaskDrop"]
  key_links:
    - from: "frontend/src/views/task/components/TaskDragDropList.vue"
      to: "frontend/src/api/modules/workorder-task.js"
      via: "workOrderTaskAPI.assign()"
      pattern: "batchAssign|assignToOperator"
    - from: "frontend/src/views/task/components/TaskDragDropList.vue"
      to: "/workorder-tasks/{id}/assign/"
      via: "assign method on drop"
      pattern: "on-drop.*assign"
---

<objective>
Implement drag-and-drop task assignment interface for supervisors

Purpose: Enable intuitive task assignment through drag-and-drop interaction. Supervisors can visually distribute workload by dragging tasks to operator columns, making rebalancing easier than using batch dialogs.

Output: A toggle-able drag-drop view in SupervisorDashboard that displays tasks as draggable cards in operator columns.
</objective>

<execution_context>
@/home/chenjiaxing/.claude/get-shit-done/workflows/execute-plan.md
@/home/chenjiaxing/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Reference existing drag-drop patterns
@frontend/src/views/task/Board.vue
@frontend/src/components/TaskKanban.vue
@frontend/src/api/modules/workorder-task.js
@backend/workorder/views/work_order_tasks/task_bulk.py
</context>

<tasks>

<task type="auto">
  <name>Create TaskDragDropList component with sortable operator columns</name>
  <files>frontend/src/views/task/components/TaskDragDropList.vue</files>
  <action>
    Create new TaskDragDropList.vue component for drag-and-drop assignment:

    Template structure:
    ```vue
    <template>
      <div class="task-drag-drop">
        <!-- Unassigned tasks column (left) -->
        <div class="column unassigned-column" @drop="handleDropUnassigned" @dragover.prevent>
          <div class="column-header">待分派任务</div>
          <draggable
            v-model="unassignedTasks"
            :group="{ name: 'tasks', pull: true, put: false }"
            @end="onDragEnd"
            item-key="id"
          >
            <template #item="{ element: task }">
              <div class="task-card" draggable="true" @dragstart="onDragStart(task, $event)">
                <!-- Task content display -->
              </div>
            </template>
          </draggable>
        </div>

        <!-- Operator columns (middle) -->
        <div v-for="operator in operators" :key="operator.id"
             class="column operator-column"
             @drop="handleDropOperator(operator, $event)"
             @dragover.prevent
             @dragenter="handleDragEnter(operator)"
             :class="{ 'drag-over': dragOverOperator === operator.id }">
          <div class="column-header">
            {{ operator.name }} ({{ operator.taskCount }})
          </div>
          <draggable
            v-model="operatorTasks[operator.id]"
            :group="{ name: 'tasks', pull: true, put: true }"
            @end="onDragEnd"
            item-key="id"
          >
            <template #item="{ element: task }">
              <div class="task-card">
                <!-- Task content -->
              </div>
            </template>
          </draggable>
        </div>
      </div>
    </template>
    ```

    Use vuedraggable library (already in project if Board.vue uses it):
    ```javascript
    import draggable from 'vuedraggable'
    ```

    Component data:
    ```javascript
    data() {
      return {
        unassignedTasks: [],
        operatorTasks: {},  // { operatorId: [tasks] }
        dragOverOperator: null,
        draggedTask: null
      }
    }
    ```

    Methods:
    - `onDragStart(task, event)` - Store dragged task reference
    - `handleDropOperator(operator, event)` - Handle drop on operator column
    - `handleDragEnter(operator)` - Highlight drop zone
    - `onDragEnd(event)` - Clear drag state
    - `confirmAssignment(task, operator)` - Show confirmation dialog

    Props:
    - `tasks: Array` - All department tasks
    - `operators: Array` - Department operators

    Events:
    - `task-assigned` - Emitted when task is assigned to operator
    - `task-reassigned` - Emitted when task is moved between operators

    Styling:
    - Flexbox layout for columns
    - Fixed width columns with horizontal scroll if needed
    - Task cards: white background, shadow, border-left colored by priority
    - Drag-over class: dashed border, light blue background
    - Column headers: sticky, show operator name and task count
  </action>
  <verify>
    Component renders without errors
    vuedraggable is available (check Board.vue for import pattern)
    Tasks render as draggable cards
    Columns display operator names
    Drop zones highlight on drag enter
  </verify>
  <done>
    TaskDragDropList component displays tasks in draggable operator columns
  </done>
</task>

<task type="auto">
  <name>Integrate drag-drop mode into SupervisorDashboard</name>
  <files>frontend/src/views/task/SupervisorDashboard.vue</files>
  <action>
    Update SupervisorDashboard.vue to add drag-drop mode:

    1. Add view mode toggle:
    ```javascript
    data() {
      return {
        viewMode: 'dashboard',  // or 'dragdrop'
        // ... existing data
      }
    }
    ```

    2. Add toggle button in template:
    ```vue
    <el-button-group style="margin-bottom: 20px;">
      <el-button :type="viewMode === 'dashboard' ? 'primary' : ''" @click="viewMode = 'dashboard'">
        统计视图
      </el-button>
      <el-button :type="viewMode === 'dragdrop' ? 'primary' : ''" @click="viewMode = 'dragdrop'">
        拖拽分派
      </el-button>
    </el-button-group>
    ```

    3. Import and use TaskDragDropList:
    ```javascript
    import TaskDragDropList from './components/TaskDragDropList.vue'

    components: {
      TaskDragDropList,
      // ... existing components
    }
    ```

    4. Add conditional rendering:
    ```vue
    <TaskDragDropList
      v-if="viewMode === 'dragdrop'"
      :tasks="departmentTasks"
      :operators="operators"
      @task-assigned="handleTaskAssigned"
      @task-reassigned="handleTaskReassigned"
    />
    ```

    5. Add handler methods:
    ```javascript
    async handleTaskAssigned({ task, operator }) {
      try {
        await this.$confirm(`将任务 "${task.work_content}" 分派给 ${operator.name}?`, '确认分派')
        await workOrderTaskAPI.assign(task.id, { operator_id: operator.id })
        this.$message.success('分派成功')
        await this.loadWorkloadData()
      } catch (error) {
        if (error !== 'cancel') {
          ErrorHandler.showMessage(error, '任务分派')
        }
      }
    }

    async handleTaskReassigned({ task, fromOperator, toOperator }) {
      try {
        await this.$confirm(`将任务从 ${fromOperator.name} 转派给 ${toOperator.name}?`, '确认转派')
        await workOrderTaskAPI.assign(task.id, { operator_id: toOperator.id })
        this.$message.success('转派成功')
        await this.loadWorkloadData()
      } catch (error) {
        if (error !== 'cancel') {
          ErrorHandler.showMessage(error, '任务转派')
        }
      }
    }
    ```

    6. Add departmentTasks data:
    ```javascript
    data() {
      return {
        departmentTasks: [],  // All tasks in selected department
        // ... existing
      }
    },

    methods: {
      async loadWorkloadData() {
        // Load workload stats
        const response = await workOrderTaskAPI.getDepartmentWorkload({
          department_id: this.selectedDepartment
        })
        this.workloadData = response

        // Also load full task list for drag-drop
        const tasksResponse = await workOrderTaskAPI.getList({
          assigned_department: this.selectedDepartment,
          page_size: 1000
        })
        this.departmentTasks = tasksResponse.results || []
      }
    }
    ```
  </action>
  <verify>
    View mode toggle switches between dashboard and drag-drop views
    Drag-drop view displays tasks in operator columns
    Dragging task to operator column triggers confirmation dialog
    Confirming assignment calls API and refreshes data
    Reassignment between operators works correctly
  </verify>
  <done>
    SupervisorDashboard has functional drag-drop assignment mode
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete drag-and-drop task assignment interface:
    - TaskDragDropList component with draggable operator columns
    - Integration into SupervisorDashboard with view mode toggle
    - Confirmation dialogs for assignment and reassignment
    - Visual feedback during drag operations
  </what-built>
  <how-to-verify>
    1. Navigate to /tasks/supervisor as a supervisor user
    2. Click "拖拽分派" button to switch to drag-drop mode
    3. Verify unassigned tasks display in left column
    4. Verify operator columns show their assigned tasks
    5. Drag a task from unassigned to an operator column
    6. Verify confirmation dialog appears
    7. Confirm the assignment
    8. Verify task moves to operator column and workload stats update
    9. Drag a task from one operator to another
    10. Verify reassignment confirmation and success message
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Switch to drag-drop mode in SupervisorDashboard
2. Drag an unassigned task to an operator column
3. Confirm the assignment dialog
4. Verify task appears in operator's column
5. Verify workload stats update
6. Drag task between operators
7. Confirm reassignment
8. Verify task moves and counts update
</verification>

<success_criteria>
- Supervisors can assign tasks by dragging to operator columns
- Drag-and-drop reassignment between operators works
- Confirmation dialog prevents accidental assignments
- Visual feedback highlights valid drop zones
- Assignment succeeds and updates the view
</success_criteria>

<output>
After completion, create `.planning/phases/07-Role-Based-Task-Centers/07-02-SUMMARY.md`
</output>
