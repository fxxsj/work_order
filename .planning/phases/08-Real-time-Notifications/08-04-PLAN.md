---
phase: 08-Real-time-Notifications
plan: 04
type: execute
wave: 3
depends_on: ["08-02A"]
files_modified:
  - backend/workorder/admin.py
autonomous: true

must_haves:
  truths:
    - "Notifications older than 30 days are automatically filtered from queries"
    - "Admin interface has action to bulk delete old notifications"
    - "30-day cutoff is enforced at database query level"
  artifacts:
    - path: "backend/workorder/admin.py"
      provides: "Admin action for notification cleanup"
      contains: "delete_old_notifications", "30.*days"
  key_links:
    - from: "Notification model manager"
      to: "30-day filtered queryset"
      via: "created_at filter"
      pattern: "created_at__lt.*days"
---

<objective>
Implement 30-day notification retention with query filtering and admin cleanup action.

Purpose: Ensure notifications are automatically filtered to show only items from the last 30 days per phase context, and provide admin action to manually clean up old notifications. This prevents indefinite database growth while maintaining recent notification history.

Output: Notification queryset filtered to 30 days, admin action for bulk deletion of old notifications.
</objective>

<execution_context>
@/home/chenjiaxing/.claude/get-shit-done/workflows/execute-plan.md
@/home/chenjiaxing/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-Real-time-Notifications/08-CONTEXT.md
@.planning/phases/08-Real-time-Notifications/08-02A-PLAN.md
@backend/workorder/models/system.py
@backend/workorder/admin.py
</context>

<tasks>

<task type="auto">
  <name>Add 30-day retention filter and admin cleanup action</name>
  <files>backend/workorder/admin.py</files>
  <action>
    Update backend/workorder/admin.py to add:

    1. **30-day default filter**: Override get_queryset to filter notifications older than 30 days
    2. **Admin cleanup action**: Add action to bulk delete notifications older than 30 days

    Implementation:
    ```python
    from django.contrib import admin
    from django.utils import timezone
    from datetime import timedelta
    from .models.system import Notification

    @admin.register(Notification)
    class NotificationAdmin(admin.ModelAdmin):
        list_display = ['recipient', 'notification_type', 'title', 'is_read', 'created_at']
        list_filter = ['notification_type', 'is_read', 'created_at', 'priority']
        search_fields = ['title', 'content', 'recipient__username']
        readonly_fields = ['created_at', 'read_at']
        date_hierarchy = 'created_at'

        # Filter to show only last 30 days by default
        def get_queryset(self, request):
            qs = super().get_queryset(request)
            # Don't filter for superusers who might need to see all
            if not request.user.is_superuser:
                thirty_days_ago = timezone.now() - timedelta(days=30)
                return qs.filter(created_at__gte=thirty_days_ago)
            return qs

        # Admin action to delete old notifications
        def delete_old_notifications(self, request, queryset):
            """删除30天前的通知"""
            thirty_days_ago = timezone.now() - timedelta(days=30)
            old_notifications = queryset.filter(created_at__lt=thirty_days_ago)
            count = old_notifications.count()
            old_notifications.delete()
            self.message_user(request, f'{count} 条30天前的通知已删除。')
        delete_old_notifications.short_description = '删除30天前的通知'

        actions = ['delete_old_notifications']
    ```

    Key points:
    - Default queryset filter applies 30-day cutoff for non-superusers
    - Admin action allows selective bulk deletion of old notifications
    - Superusers can see all notifications (useful for auditing)
    - The 30-day retention is enforced at query level, not hard deletion
    - Users can manually delete individual notifications via frontend
  </action>
  <verify>grep -E "get_queryset|delete_old_notifications|timedelta.*days=30" backend/workorder/admin.py</verify>
  <done>Admin has 30-day queryset filter and delete_old_notifications action</done>
</task>

</tasks>

<verification>
After completing all tasks, verify:

1. Check that get_queryset filters notifications older than 30 days
2. Verify delete_old_notifications action exists
3. Confirm action filters by created_at__lt with 30 days
4. Test admin action manually to confirm it works

The retention is enforced at query level - notifications older than 30 days
simply won't appear in API responses. Manual deletion is available via admin.
</verification>

<success_criteria>
1. Notification queryset filters out items older than 30 days
2. Admin has "delete_old_notifications" action
3. Action correctly identifies and deletes old notifications
4. Superusers can see all notifications (no filter applied)
5. Frontend API respects the 30-day filter
</success_criteria>

<output>
After completion, create `.planning/phases/08-Real-time-Notifications/08-04-SUMMARY.md` with:
- Retention filter implementation details
- Admin action usage instructions
- 30-day cutoff enforcement approach
</output>
