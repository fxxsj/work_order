# Phase 8: Real-time Notifications - Context

**Gathered:** 2026-02-01
**Status:** Ready for planning

<domain>
## Phase Boundary

通过 WebSocket 实现实时任务事件通知系统。当任务分配给操作员、操作员认领任务或完成任务时，相关人员能立即收到通知，无需刷新页面。支持通知历史查看和基础偏好设置。

</domain>

<decisions>
## Implementation Decisions

### 通知类型和触发时机
- **核心事件通知**：仅通知任务分配（assigned）和任务完成（completed）
- **部门成员可见**：通知发送给直接相关人员 + 同部门其他成员
- **两段式显示**：通知列表显示简洁信息（任务编号 + 操作描述），点击后展开详细内容（工序名称、操作人、操作时间、快速跳转链接）
- **中期保留**：通知历史保留 30 天，支持用户手动删除

### 通知展示方式
- **仅应用内通知**：使用右上角铃铛图标 + 弹出卡片，不使用浏览器原生通知
- **仅更新计数**：收到通知时仅更新铃铛图标上的未读计数，不自动弹出 toast
- **先查看详情**：点击通知后先展开详细信息，用户再决定是否跳转到任务

### WebSocket 连接管理
- **登录即连接**：用户登录后立即建立 WebSocket 连接
- **智能同步**：使用 BroadcastChannel API 在多标签页间同步状态，避免重复通知
- **指数退避重连**：连接断开后立即尝试重连，失败后使用指数退避策略（1s, 2s, 4s, 8s...）

### 通知偏好设置
- **仅全局开关**：用户只能启用/禁用所有通知，不支持按事件类型过滤
- **不支持免打扰**：不提供免打扰时间段功能，所有通知立即送达
- **声音提醒用户可选**：用户可以选择是否开启通知声音（默认关闭）

### Claude's Discretion
- WebSocket 心跳检测机制（keep-alive interval）
- 通知队列和批量推送策略
- 未读计数的实时同步机制
- 连接状态指示器的设计（可选）
- 通知中心 UI 的具体布局和交互

</decisions>

<specifics>
## Specific Ideas

- 采用 BroadcastChannel API 实现多标签页状态同步，避免重复通知
- 通知历史支持标记已读/未读状态，支持批量操作
- 铃铛图标显示未读计数徽章，超过 99 显示 "99+"
- 两段式显示：列表视图紧凑，详情视图完整
- WebSocket 连接失败时在界面上显示连接状态提示

</specifics>

<deferred>
## Deferred Ideas

- 浏览器原生通知支持（需要用户授权，可在未来版本添加）
- 按事件类型过滤通知（需要更复杂的偏好设置 UI）
- 免打扰时间段（已有用户需求，可在后续版本实现）
- 邮件/短信通知（属于外部通知渠道，独立功能）
- 通知分组和聚合（当短时间内收到多个通知时）

</deferred>

---

*Phase: 08-Real-time-Notifications*
*Context gathered: 2026-02-01*
