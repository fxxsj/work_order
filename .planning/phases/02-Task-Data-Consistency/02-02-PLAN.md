---
phase: 02-Task-Data-Consistency
plan: 02
type: execute
wave: 1
depends_on: ["01"]
files_modified:
  - backend/workorder/serializers/core.py
  - backend/workorder/api/views/work_order_tasks.py
  - frontend/src/api/modules/workOrderTask.js
  - frontend/src/views/work-orders/WorkOrderDetail.vue
autonomous: true

must_haves:
  truths:
    - "User can select multiple draft tasks and edit them in a single operation"
    - "User can select multiple draft tasks and delete them in a single operation"
    - "Bulk edit only affects draft tasks - formal tasks are protected"
    - "Bulk operations are limited to 1000 tasks to prevent memory exhaustion"
    - "Frontend table uses Element UI selection with confirmation dialogs"
  artifacts:
    - path: "backend/workorder/serializers/core.py"
      provides: "DraftTaskBulkUpdateSerializer for batch operations"
      contains: "class DraftTaskBulkUpdateSerializer"
    - path: "backend/workorder/api/views/work_order_tasks.py"
      provides: "Bulk update and delete API endpoints"
      contains: "@action(detail=False, methods=['post']) def bulk_update"
    - path: "frontend/src/api/modules/workOrderTask.js"
      provides: "Bulk operation API methods"
      exports: ["bulkUpdate", "bulkDelete"]
    - path: "frontend/src/views/work-orders/WorkOrderDetail.vue"
      provides: "Bulk operation UI with table selection"
      contains: "@selection-change=\"handleSelectionChange\""
  key_links:
    - from: "frontend/src/views/work-orders/WorkOrderDetail.vue"
      to: "frontend/src/api/modules/workOrderTask.js"
      via: "import workOrderTaskAPI for bulk operations"
      pattern: "workOrderTaskAPI\\.bulkUpdate"
    - from: "frontend/src/api/modules/workOrderTask.js"
      to: "backend/workorder/api/views/work_order_tasks.py"
      via: "POST request to bulk_update/bulk_delete endpoints"
      pattern: "/work-order-tasks/bulk_update|/work-order-tasks/bulk_delete"
    - from: "backend/workorder/api/views/work_order_tasks.py:bulk_update"
      to: "backend/workorder/serializers/core.py:DraftTaskBulkUpdateSerializer"
      via: "serializer validation for bulk updates"
      pattern: "DraftTaskBulkUpdateSerializer"
---

<objective>
Implement bulk edit and bulk delete operations for draft tasks

Purpose: Users need to efficiently manage draft tasks before work order approval by editing or deleting multiple tasks in single operations. Bulk operations improve productivity when managing large numbers of draft tasks.

Output: Backend bulk API endpoints and frontend bulk operation UI with Element UI table selection
</objective>

<execution_context>
@/home/chenjiaxing/.claude/get-shit-done/workflows/execute-plan.md
@/home/chenjiaxing/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-Task-Data-Consistency/02-RESEARCH.md
@.planning/phases/01-draft-task-foundation/01-02-SUMMARY.md
@backend/workorder/serializers/core.py
@backend/workorder/api/views/work_order_tasks.py
@frontend/src/api/modules/workOrderTask.js
@frontend/src/views/work-orders/WorkOrderDetail.vue
</context>

<tasks>

<task type="auto">
  <name>Create DraftTaskBulkUpdateSerializer</name>
  <files>backend/workorder/serializers/core.py</files>
  <action>
    Add DraftTaskBulkUpdateSerializer to backend/workorder/serializers/core.py:

    1. Create ListSerializer child class for bulk operations:
       ```python
       class DraftTaskBulkUpdateSerializer(serializers.ListSerializer):
           child = None  # Set to DraftTaskSerializer instance

           def update(self, instance, validated_data):
               # validated_data is a list of dicts with task updates
               task_mapping = {task.id: task for task in instance}

               updates = []
               task_ids = []
               for data in validated_data:
                   task_id = data.get('id')
                   if task_id in task_mapping:
                       task = task_mapping[task_id]
                       # Update only allowed fields
                       if 'production_quantity' in data:
                           task.production_quantity = data['production_quantity']
                       if 'priority' in data:
                           task.priority = data['priority']
                       if 'production_requirements' in data:
                           task.production_requirements = data['production_requirements']
                       updates.append(task)
                       task_ids.append(task_id)

               # Validate all tasks are draft status
               non_draft = WorkOrderTask.objects.filter(
                   id__in=task_ids
               ).exclude(status='draft').count()

               if non_draft > 0:
                   raise ValidationError("只能修改草稿状态的任务")

               # Bulk update in single query
               if updates:
                   WorkOrderTask.objects.bulk_update(
                       updates,
                       ['production_quantity', 'priority', 'production_requirements'],
                       batch_size=100
                   )

               return updates
       ```

    2. Create DraftTaskBulkSerializer for the API request:
       ```python
       class DraftTaskBulkSerializer(serializers.Serializer):
           task_ids = serializers.ListField(child=serializers.IntegerField())
           production_quantity = serializers.IntegerField(required=False, allow_null=True)
           priority = serializers.CharField(required=False, allow_null=True)
           production_requirements = serializers.CharField(required=False, allow_null=True)

           def validate_task_ids(self, value):
               if len(value) > 1000:
                   raise ValidationError("批量操作最多支持1000个任务")
               return value

           def validate(self, attrs):
               # Validate all tasks exist and are draft status
               task_ids = attrs.get('task_ids', [])
               tasks = WorkOrderTask.objects.filter(id__in=task_ids, status='draft')

               if tasks.count() != len(task_ids):
                   raise ValidationError("部分任务不存在或不是草稿状态")

               # Validate priority value if provided
               if attrs.get('priority'):
                   valid_priorities = ['low', 'normal', 'high', 'urgent']
                   if attrs['priority'] not in valid_priorities:
                   raise ValidationError("无效的优先级值")

               return attrs
       ```

    Place these serializers after WorkOrderTaskSerializer in the file.
  </action>
  <verify>grep -n "DraftTaskBulkSerializer\|DraftTaskBulkUpdateSerializer" backend/workorder/serializers/core.py</verify>
  <done>Serializers created for bulk operations with validation (draft status check, max 1000 tasks)</done>
</task>

<task type="auto">
  <name>Add bulk update and delete API endpoints</name>
  <files>backend/workorder/api/views/work_order_tasks.py</files>
  <action>
    Add bulk operation endpoints to WorkOrderTaskViewSet.

    1. WorkOrderTaskViewSet exists in backend/workorder/api/views/work_order_tasks.py (confirmed from Phase 1, ~1693 lines)

    2. Add bulk_update action:
       ```python
       @action(detail=False, methods=['post'])
       def bulk_update(self, request):
           '''Bulk update draft tasks'''
           serializer = DraftTaskBulkSerializer(data=request.data)

           if not serializer.is_valid():
               return Response({'errors': serializer.errors}, status=400)

           validated_data = serializer.validated_data
           task_ids = validated_data['task_ids']

           # Get tasks to update
           tasks = WorkOrderTask.objects.filter(id__in=task_ids, status='draft')

           # Prepare update fields
           update_fields = []
           for task in tasks:
               if 'production_quantity' in validated_data and validated_data['production_quantity'] is not None:
                   task.production_quantity = validated_data['production_quantity']
                   update_fields.append('production_quantity')
               if 'priority' in validated_data and validated_data['priority'] is not None:
                   task.priority = validated_data['priority']
                   update_fields.append('priority')
               if 'production_requirements' in validated_data and validated_data['production_requirements'] is not None:
                   task.production_requirements = validated_data['production_requirements']
                   update_fields.append('production_requirements')

           # Bulk update
           if update_fields and tasks:
               updated_count = WorkOrderTask.objects.bulk_update(
                   tasks,
                   list(set(update_fields)),
                   batch_size=100
               )

               return Response({
                   'updated_count': len(updated_count) if hasattr(updated_count, '__iter__') else updated_count or len(tasks),
                   'message': f'成功更新 {len(tasks)} 个任务'
               })

           return Response({'updated_count': 0, 'message': '没有更新任何字段'})
       ```

    3. Add bulk_delete action:
       ```python
       @action(detail=False, methods=['post', 'delete'])
       def bulk_delete(self, request):
           '''Bulk delete draft tasks'''
           task_ids = request.data.get('task_ids', [])

           # Validate
           if not task_ids:
               return Response({'error': '请提供要删除的任务ID'}, status=400)

           if len(task_ids) > 1000:
               return Response(
                   {'error': '批量删除最多支持1000个任务'},
                   status=400
               )

           # Only allow deleting draft tasks
           tasks = WorkOrderTask.objects.filter(id__in=task_ids, status='draft')

           if tasks.count() != len(task_ids):
               return Response(
                   {'error': '只能删除草稿状态的任务'},
                   status=400
               )

           # Delete
           deleted_count = tasks.delete()[0]

           return Response({
               'deleted_count': deleted_count,
               'message': f'成功删除 {deleted_count} 个任务'
           })
       ```

    Ensure the ViewSet is registered in urls.py with the appropriate router.
  </action>
  <verify>grep -n "def bulk_update\|def bulk_delete" backend/workorder/api/views/work_order_tasks.py</verify>
  <done>API endpoints exist at POST /api/work-order-tasks/bulk_update/ and POST /api/work-order-tasks/bulk_delete/</done>
</task>

<task type="auto">
  <name>Add bulk operation methods to workOrderTask API module</name>
  <files>frontend/src/api/modules/workOrderTask.js</files>
  <action>
    Add bulk operation methods to frontend/src/api/modules/workOrderTask.js:

    The workOrderTask module already exists (per Phase 1). Add these methods:

    1. bulkUpdate method:
       ```javascript
       bulkUpdate(data) {
         return this.request({
           url: `${this.baseURL}bulk_update/`,
           method: 'post',
           data: {
             task_ids: data.task_ids,
             production_quantity: data.production_quantity,
             priority: data.priority,
             production_requirements: data.production_requirements
           }
         })
       }
       ```

    2. bulkDelete method:
       ```javascript
       bulkDelete(taskIds) {
         return this.request({
           url: `${this.baseURL}bulk_delete/`,
           method: 'post',
           data: { task_ids: taskIds }
         })
       }
       ```

    These should be added as methods of the WorkOrderTaskAPI class (which extends BaseAPI).

    Location: Add after existing CRUD methods, before the export statement.
  </action>
  <verify>grep -n "bulkUpdate\|bulkDelete" frontend/src/api/modules/workOrderTask.js</verify>
  <done>workOrderTaskAPI has bulkUpdate and bulkDelete methods that call backend endpoints</done>
</task>

<task type="auto">
  <name>Add bulk operation UI to WorkOrderDetail component</name>
  <files>frontend/src/views/work-orders/WorkOrderDetail.vue</files>
  <action>
    Add bulk operation UI to the draft tasks table in WorkOrderDetail.vue:

    1. Update the draft tasks table template to include selection:
       ```vue
       <el-table
         ref="draftTaskTable"
         :data="draftTasks"
         @selection-change="handleSelectionChange"
       >
         <el-table-column type="selection" width="55" />
         <!-- existing columns -->
       </el-table>

       <div class="bulk-actions" style="margin-top: 10px;">
         <el-button
           type="primary"
           size="small"
           :disabled="selectedDraftTasks.length === 0"
           @click="showBulkEditDialog"
         >
           批量编辑 ({{ selectedDraftTasks.length }})
         </el-button>
         <el-button
           type="danger"
           size="small"
           :disabled="selectedDraftTasks.length === 0"
           @click="handleBulkDelete"
         >
           批量删除
         </el-button>
       </div>
       ```

    2. Add data properties to component:
       ```javascript
       data() {
         return {
           // existing data
           selectedDraftTasks: [],
           bulkEditDialogVisible: false,
           bulkEditForm: {
             task_ids: [],
             production_quantity: null,
             priority: null,
             production_requirements: null
           }
         }
       }
       ```

    3. Add methods for handling bulk operations:
       ```javascript
       methods: {
         handleSelectionChange(selection) {
           this.selectedDraftTasks = selection
         },

         showBulkEditDialog() {
           if (this.selectedDraftTasks.length === 0) {
             this.$message.warning('请先选择要编辑的任务')
             return
           }

           // Validate all selected are draft
           const hasNonDraft = this.selectedDraftTasks.some(t => t.status !== 'draft')
           if (hasNonDraft) {
             this.$message.error('只能编辑草稿状态的任务')
             return
           }

           this.bulkEditForm = {
             task_ids: this.selectedDraftTasks.map(t => t.id),
             production_quantity: null,
             priority: null,
             production_requirements: null
           }
           this.bulkEditDialogVisible = true
         },

         async confirmBulkEdit() {
           try {
             const { workOrderTaskAPI } = await import('@/api/modules')
             const response = await workOrderTaskAPI.bulkUpdate(this.bulkEditForm)

             this.$message.success(response.data.message || '批量更新成功')
             this.bulkEditDialogVisible = false
             this.fetchDraftTasks() // Refresh table
           } catch (error) {
             this.$message.error('批量更新失败：' + (error.response?.data?.error || error.message))
           }
         },

         async handleBulkDelete() {
           if (this.selectedDraftTasks.length === 0) {
             this.$message.warning('请先选择要删除的任务')
             return
           }

           // Validate all selected are draft
           const hasNonDraft = this.selectedDraftTasks.some(t => t.status !== 'draft')
           if (hasNonDraft) {
             this.$message.error('只能删除草稿状态的任务')
             return
           }

           try {
             await this.$confirm(
               `确定要删除选中的 ${this.selectedDraftTasks.length} 个草稿任务吗？`,
               '确认删除',
               { type: 'warning' }
             )

             const taskIds = this.selectedDraftTasks.map(t => t.id)
             const { workOrderTaskAPI } = await import('@/api/modules')
             const response = await workOrderTaskAPI.bulkDelete(taskIds)

             this.$message.success(response.data.message || '批量删除成功')
             this.fetchDraftTasks() // Refresh table
           } catch (error) {
             if (error !== 'cancel') {
               this.$message.error('批量删除失败：' + (error.response?.data?.error || error.message))
             }
           }
         }
       }
       ```

    4. Add bulk edit dialog to template:
       ```vue
       <el-dialog
         title="批量编辑任务"
         :visible.sync="bulkEditDialogVisible"
         width="500px"
       >
         <el-form :model="bulkEditForm" label-width="100px">
           <el-form-item label="生产数量">
             <el-input-number
               v-model="bulkEditForm.production_quantity"
               :min="0"
               placeholder="留空则不修改"
             />
           </el-form-item>
           <el-form-item label="优先级">
             <el-select
               v-model="bulkEditForm.priority"
               placeholder="留空则不修改"
               clearable
             >
               <el-option label="低" value="low" />
               <el-option label="普通" value="normal" />
               <el-option label="高" value="high" />
               <el-option label="紧急" value="urgent" />
             </el-select>
           </el-form-item>
           <el-form-item label="备注">
             <el-input
               v-model="bulkEditForm.production_requirements"
               type="textarea"
               placeholder="留空则不修改"
             />
           </el-form-item>
         </el-form>
         <span slot="footer">
           <el-button @click="bulkEditDialogVisible = false">取消</el-button>
           <el-button type="primary" @click="confirmBulkEdit">确定</el-button>
         </span>
       </el-dialog>
       ```

    Import workOrderTaskAPI at the top of the script section if not already imported.
  </action>
  <verify>grep -n "handleSelectionChange\|bulkEditDialog\|confirmBulkEdit\|handleBulkDelete" frontend/src/views/work-orders/WorkOrderDetail.vue</verify>
  <done>WorkOrderDetail component has bulk edit and delete functionality with Element UI table selection</done>
</task>

</tasks>

<verification>
After completion, verify:
1. Backend: grep shows bulk_update and bulk_delete action methods in backend/workorder/api/views/work_order_tasks.py
2. Frontend: workOrderTask.js exports bulkUpdate and bulkDelete methods
3. Frontend: WorkOrderDetail.vue has @selection-change handler and bulk action buttons
4. API test: POST /api/work-order-tasks/bulk_update/ with valid data returns updated_count
5. API test: POST /api/work-order-tasks/bulk_delete/ with valid task_ids returns deleted_count
6. UI test: Select draft tasks -> bulk edit button becomes enabled
7. UI test: Click bulk edit -> dialog opens -> fill fields -> confirm -> tasks update
8. UI test: Select draft tasks -> bulk delete -> confirm dialog -> tasks deleted
9. Edge case: Try to bulk update 1001 tasks -> returns 400 error "最多支持1000个任务"
10. Edge case: Try to bulk update non-draft task -> returns 400 error "只能修改草稿状态的任务"
</verification>

<success_criteria>
- Bulk edit API endpoint accepts task_ids and field updates
- Bulk delete API endpoint accepts task_ids and deletes tasks
- Frontend table has selection column and bulk action buttons
- Bulk operations are limited to 1000 tasks maximum
- Only draft tasks can be bulk edited/deleted (non-draft protected)
- Confirmation dialogs prevent accidental bulk deletion
- Success/error messages provide user feedback
</success_criteria>

<output>
After completion, create `.planning/phases/02-Task-Data-Consistency/02-02-SUMMARY.md`
</output>
