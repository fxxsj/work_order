---
phase: 02-Task-Data-Consistency
plan: 03
type: execute
wave: 2
depends_on: [02-01, 02-02]
files_modified:
  - frontend/src/api/modules/workorder.js
  - frontend/src/views/workorder/components/ProcessManagement.vue
  - frontend/src/views/workorder/WorkOrderDetail.vue
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "User modifies work order processes and receives prompt to update existing tasks"
    - "System adds new tasks for added processes and removes tasks for deleted processes"
    - "Process changes never leave orphaned or duplicate tasks"
  artifacts:
    - path: "frontend/src/api/modules/workorder.js"
      provides: "Sync API methods for task synchronization"
      contains: "checkSyncNeeded, syncTasksPreview, syncTasksExecute"
    - path: "frontend/src/views/workorder/components/SyncTaskPrompt.vue"
      provides: "Sync confirmation dialog component"
      min_lines: 80
    - path: "frontend/src/views/workorder/WorkOrderDetail.vue"
      provides: "Sync workflow integration after process changes"
      contains: "checkSyncNeeded call, sync prompt display"
  key_links:
    - from: "ProcessManagement.vue"
      to: "workOrderAPI.checkSyncNeeded"
      via: "@add-process event handler"
      pattern: "checkSyncNeeded.*process"
    - from: "SyncTaskPrompt.vue"
      to: "sync_tasks_preview endpoint"
      via: "workOrderAPI.syncTasksPreview"
      pattern: "syncTasksPreview.*process_ids"
    - from: "SyncTaskPrompt.vue"
      to: "sync_tasks_execute endpoint"
      via: "workOrderAPI.syncTasksExecute"
      pattern: "syncTasksExecute.*confirmed.*true"
---

# Plan 02-03: Frontend Sync Integration

<objective>
Add frontend API methods and UI integration for task synchronization, exposing the complete backend sync infrastructure to users.

Purpose: Backend sync endpoints (sync_tasks_preview, sync_tasks_execute, check_sync_needed) and TaskSyncService are complete and production-ready, but frontend has no way to call them. Users modifying processes receive NO indication that tasks need syncing, leading to orphaned tasks in practice.

Output:
- workOrderAPI methods: checkSyncNeeded(), syncTasksPreview(), syncTasksExecute()
- SyncTaskPrompt.vue component for preview-confirm dialog
- ProcessManagement integration to check sync after process changes
- WorkOrderDetail integration to handle sync workflow
</objective>

<execution_context>
@/home/chenjiaxing/.claude/get-shit-done/workflows/execute-plan.md
@/home/chenjiaxing/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-Task-Data-Consistency/02-01-SUMMARY.md
@.planning/phases/02-Task-Data-Consistency/02-02-SUMMARY.md
@.planning/phases/02-Task-Data-Consistency/02-VERIFICATION.md

@frontend/src/api/modules/workorder.js
@frontend/src/api/base/BaseAPI.js
@frontend/src/views/workorder/components/ProcessManagement.vue
@frontend/src/views/workorder/WorkOrderDetail.vue
@frontend/src/utils/errorHandler.js
@backend/workorder/views/work_orders.py
@backend/workorder/services/task_sync_service.py
</context>

<tasks>

<task type="auto">
  <name>Add sync API methods to workOrderAPI</name>
  <files>frontend/src/api/modules/workorder.js</files>
  <action>
    Add three new methods to WorkOrderAPI class in frontend/src/api/modules/workorder.js:

    1. checkSyncNeeded(id, processIds):
       - Calls GET /api/workorders/{id}/check_sync_needed/?process_ids=1,2,3
       - Converts processIds array to comma-separated query param
       - Returns { sync_needed: boolean, current_process_ids: [], can_sync: boolean }

    2. syncTasksPreview(id, processIds):
       - Calls POST /api/workorders/{id}/sync_tasks_preview/
       - Sends { process_ids: [1, 2, 3] } in request body
       - Returns { preview: { tasks_to_remove: N, tasks_to_add: M, affected: true } }

    3. syncTasksExecute(id, processIds):
       - Calls POST /api/workorders/{id}/sync_tasks_execute/
       - Sends { process_ids: [1, 2, 3], confirmed: true }
       - Returns { result: { deleted_count: N, added_count: M, message: "..." } }

    Follow the existing pattern in workorder.js - use this.customAction() for these methods.

    Do NOT modify any existing methods - only add these three new ones.
  </action>
  <verify>
    Check that workorder.js exports three new methods: checkSyncNeeded, syncTasksPreview, syncTasksExecute
  </verify>
  <done>
    workOrderAPI.checkSyncNeeded(id, processIds) returns sync check result
    workOrderAPI.syncTasksPreview(id, processIds) returns preview with counts
    workOrderAPI.syncTasksExecute(id, processIds) executes sync with confirmed flag
  </done>
</task>

<task type="auto">
  <name>Create SyncTaskPrompt component</name>
  <files>frontend/src/views/workorder/components/SyncTaskPrompt.vue</files>
  <action>
    Create new component frontend/src/views/workorder/components/SyncTaskPrompt.vue:

    Props:
    - visible: boolean (controls dialog visibility)
    - workOrderId: number/string
    - processIds: array of process IDs to sync

    Data:
    - loading: boolean (false)
    - preview: object (null) - stores sync preview result
    - syncing: boolean (false)

    Template structure:
    - el-dialog with title "任务同步确认"
    - Show el-alert warning if preview.tasks_to_remove > 0
    - Show preview summary: "将删除 X 个草稿任务，新增 Y 个任务"
    - Two buttons: "取消" and "确认同步"

    Methods:
    - loadPreview(): Calls workOrderAPI.syncTasksPreview(workOrderId, processIds), stores result in preview
    - handleConfirm(): Calls workOrderAPI.syncTasksExecute(workOrderId, processIds), shows success message, emits @synced event
    - handleClose(): Emits @close event

    Watch visible prop:
    - When visible becomes true, call loadPreview()

    Emit events:
    - @synced: when sync completes successfully
    - @close: when dialog closes (cancel or after sync)

    Use ErrorHandler for messages and ErrorHandler.confirm for extra confirmation if tasks will be removed.

    Follow Element UI dialog patterns from ProcessManagement.vue.
  </action>
  <verify>
    Component exists at frontend/src/views/workorder/components/SyncTaskPrompt.vue with:
    - el-dialog with sync preview display
    - loadPreview() method calling syncTasksPreview
    - handleConfirm() method calling syncTasksExecute
    - @synced and @close events emitted
  </verify>
  <done>
    SyncTaskPrompt.vue displays preview of tasks to add/remove
    User can confirm or cancel sync operation
    Component emits @synced after successful sync
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete sync workflow integration in WorkOrderDetail and ProcessManagement components

    Changes:
    1. WorkOrderDetail.vue:
       - Import SyncTaskPrompt component
       - Add syncPromptDialog data property (visible: false)
       - Add pendingProcessIds data property (null)
       - Add checkAndPromptSync method that calls checkSyncNeeded after process changes
       - Add handleSyncPrompt method to open sync dialog
       - Add handleSyncComplete method to refresh data after sync
       - Modify handleAddProcess to call checkAndPromptSync after successful add
       - Add SyncTaskPrompt component in template

    2. ProcessManagement.vue:
       - Modify handleConfirmAddProcess to NOT just emit event
       - Instead, emit 'process-added' event with process data for parent to handle sync check
       - OR: Add sync check directly in ProcessManagement after emit (if workOrderId available as prop)
  </what-built>
  <how-to-verify>
    1. Start both frontend (npm run serve) and backend (python manage.py runserver)
    2. Open browser to http://localhost:8080 (or your frontend dev server)
    3. Navigate to an existing work order with draft tasks
    4. Add a new process via "添加工序" button
    5. EXPECTED: System prompts "检测到工序变化，需要同步任务。查看变更？"
    6. Click "查看变更" to open sync dialog
    7. EXPECTED: Dialog shows "将新增 X 个草稿任务"
    8. Click "确认同步"
    9. EXPECTED: Success message "任务同步完成", page refreshes, new tasks appear in DraftTaskManagement
    10. Remove a process that has draft tasks
    11. EXPECTED: System prompts "将删除 X 个草稿任务，确认同步？"
    12. Confirm sync
    13. EXPECTED: Tasks are deleted, no orphaned tasks remain
  </how-to-verify>
  <resume-signal>
    Type "approved" if sync prompt appears and workflow works correctly
    Type "issues" + describe problem (e.g., "no prompt appears", "sync fails", "orphaned tasks remain")
  </resume-signal>
</task>

</tasks>

<verification>
After checkpoint approval:

1. Verify truth #1: User modifies work order processes and receives prompt to update existing tasks
   - Add process -> sync prompt appears
   - Remove process -> sync prompt appears
   - Prompt shows what will change

2. Verify truth #2: System adds new tasks for added processes and removes tasks for deleted processes
   - After sync, new processes have corresponding tasks
   - After sync, deleted processes have no orphaned tasks
   - DraftTaskManagement shows updated task list

3. Verify truth #5: Process changes never leave orphaned or duplicate tasks
   - Check database: no tasks exist for deleted processes
   - Check database: each process has correct number of tasks
   - No duplicate task-process combinations
</verification>

<success_criteria>
1. workOrderAPI has three sync methods (checkSyncNeeded, syncTasksPreview, syncTasksExecute)
2. SyncTaskPrompt.vue component displays sync preview and handles confirmation
3. WorkOrderDetail.vue integrates sync check after process changes
4. User sees prompt when modifying processes
5. Sync execution completes without orphaned tasks
6. All 5 must-have truths from VERIFICATION.md are now satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/02-Task-Data-Consistency/02-03-SUMMARY.md`
</output>
