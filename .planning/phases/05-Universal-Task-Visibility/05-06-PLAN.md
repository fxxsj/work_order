---
wave: 3
depends_on:
  - 05-02
files_modified:
  - "frontend/src/views/task/TaskList.vue"
autonomous: true
---
<objective>
Address the major gap from plan `05-02` by implementing virtual scrolling in `TaskList.vue`. The `VirtualTable` component is already imported but not used. This plan will replace the standard `el-table` with `VirtualTable` when the number of tasks exceeds a threshold, improving frontend performance for large datasets.
</objective>

<tasks>
<task>
<file_path>frontend/src/views/task/TaskList.vue</file_path>
<action>replace</action>
<instructions>Replace the static `el-table` with a conditionally rendered `VirtualTable` or `el-table` based on the `shouldUseVirtualScroll` computed property. This requires duplicating the table columns for both components but is the most direct way to implement the conditional logic.</instructions>
<source>
      <!-- 任务列表 -->
      <el-table
        v-if="viewMode === 'table'"
        ref="taskTable"
        v-loading="loading && tableData.length > 0"
        :data="tableData"
        border
        style="width: 100%; margin-top: 20px;"
        :row-key="getRowKey"
        @sort-change="handleSortChange"
        @selection-change="handleSelectionChange"
      >
        <el-table-column
          type="selection"
          width="55"
          :selectable="checkRowSelectable"
        />
        <el-table-column type="expand" width="50">
          <template slot-scope="scope">
            <TaskLogs :task="scope.row" />
          </template>
        </el-table-column>
        <el-table-column
          prop="id"
          label="ID"
          width="80"
          sortable="custom"
        />
        <el-table-column label="施工单号" width="150">
          <template slot-scope="scope">
            <el-link
              v-if="scope.row.work_order_process_info?.work_order?.id"
              type="primary"
              @click="goToWorkOrderDetail(scope.row.work_order_process_info.work_order)"
            >
              {{ scope.row.work_order_process_info.work_order.order_number || '-' }}
            </el-link>
            <span v-else>-</span>
          </template>
        </el-table-column>
        <el-table-column label="工序" width="120">
          <template slot-scope="scope">
            {{ scope.row.work_order_process_info?.process?.name || '-' }}
          </template>
        </el-table-column>
        <el-table-column
          prop="work_content"
          label="任务内容"
          min-width="200"
          show-overflow-tooltip
        />
        <el-table-column label="分派部门" width="120">
          <template slot-scope="scope">
            {{ scope.row.assigned_department_name || '-' }}
          </template>
        </el-table-column>
        <el-table-column label="分派操作员" width="120">
          <template slot-scope="scope">
            {{ scope.row.assigned_operator_name || '-' }}
          </template>
        </el-table-column>
        <el-table-column label="关联对象" width="150">
          <template slot-scope="scope">
            <TaskRelatedInfo :task="scope.row" />
          </template>
        </el-table-column>
        <el-table-column
          prop="production_quantity"
          label="生产数量"
          width="100"
          align="right"
        />
        <el-table-column
          prop="quantity_completed"
          label="完成数量"
          width="100"
          align="right"
        />
        <el-table-column label="进度" width="80" align="right">
          <template slot-scope="scope">
            {{ taskService.calculateProgress(scope.row) }}%
          </template>
        </el-table-column>
        <el-table-column prop="status_display" label="状态" width="100">
          <template slot-scope="scope">
            <el-tag
              :type="taskService.getStatusType(scope.row.status)"
              size="small"
            >
              {{ scope.row.status_display }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column label="操作" width="280" fixed="right">
          <template slot-scope="scope">
            <TaskActions
              :task="scope.row"
              @complete="handleCompleteTask"
              @update="showUpdateDialog"
              @assign="showAssignDialog"
              @split="showSplitDialog"
            />
          </template>
        </el-table-column>
      </el-table>
</source>
<replacement>
      <!-- 任务列表 -->
      <template v-if="viewMode === 'table'">
        <!-- 标准表格 -->
        <el-table
          v-if="!shouldUseVirtualScroll"
          ref="taskTable"
          v-loading="loading && tableData.length > 0"
          :data="tableData"
          border
          style="width: 100%; margin-top: 20px;"
          :row-key="getRowKey"
          @sort-change="handleSortChange"
          @selection-change="handleSelectionChange"
        >
          <el-table-column type="selection" width="55" :selectable="checkRowSelectable" />
          <el-table-column type="expand" width="50">
            <template slot-scope="scope"><TaskLogs :task="scope.row" /></template>
          </el-table-column>
          <el-table-column prop="id" label="ID" width="80" sortable="custom" />
          <el-table-column label="施工单号" width="150">
            <template slot-scope="scope">
              <el-link v-if="scope.row.work_order_process_info?.work_order?.id" type="primary" @click="goToWorkOrderDetail(scope.row.work_order_process_info.work_order)">
                {{ scope.row.work_order_process_info.work_order.order_number || '-' }}
              </el-link>
              <span v-else>-</span>
            </template>
          </el-table-column>
          <el-table-column label="工序" width="120">
            <template slot-scope="scope">{{ scope.row.work_order_process_info?.process?.name || '-' }}</template>
          </el-table-column>
          <el-table-column prop="work_content" label="任务内容" min-width="200" show-overflow-tooltip />
          <el-table-column label="分派部门" width="120">
            <template slot-scope="scope">{{ scope.row.assigned_department_name || '-' }}</template>
          </el-table-column>
          <el-table-column label="分派操作员" width="120">
            <template slot-scope="scope">{{ scope.row.assigned_operator_name || '-' }}</template>
          </el-table-column>
          <el-table-column label="关联对象" width="150">
            <template slot-scope="scope"><TaskRelatedInfo :task="scope.row" /></template>
          </el-table-column>
          <el-table-column prop="production_quantity" label="生产数量" width="100" align="right" />
          <el-table-column prop="quantity_completed" label="完成数量" width="100" align="right" />
          <el-table-column label="进度" width="80" align="right">
            <template slot-scope="scope">{{ taskService.calculateProgress(scope.row) }}%</template>
          </el-table-column>
          <el-table-column prop="status_display" label="状态" width="100">
            <template slot-scope="scope">
              <el-tag :type="taskService.getStatusType(scope.row.status)" size="small">{{ scope.row.status_display }}</el-tag>
            </template>
          </el-table-column>
          <el-table-column label="操作" width="280" fixed="right">
            <template slot-scope="scope">
              <TaskActions :task="scope.row" @complete="handleCompleteTask" @update="showUpdateDialog" @assign="showAssignDialog" @split="showSplitDialog" />
            </template>
          </el-table-column>
        </el-table>

        <!-- 虚拟滚动表格 -->
        <VirtualTable
          v-if="shouldUseVirtualScroll"
          ref="virtualTaskTable"
          v-loading="loading && tableData.length > 0"
          :data="tableData"
          :item-height="60"
          style="width: 100%; margin-top: 20px;"
          :row-key="getRowKey"
          @sort-change="handleSortChange"
        >
          <el-table-column type="selection" width="55" :selectable="checkRowSelectable" />
          <el-table-column type="expand" width="50">
            <template slot-scope="scope"><TaskLogs :task="scope.row" /></template>
          </el-table-column>
          <el-table-column prop="id" label="ID" width="80" sortable="custom" />
          <el-table-column label="施工单号" width="150">
            <template slot-scope="scope">
              <el-link v-if="scope.row.work_order_process_info?.work_order?.id" type="primary" @click="goToWorkOrderDetail(scope.row.work_order_process_info.work_order)">
                {{ scope.row.work_order_process_info.work_order.order_number || '-' }}
              </el-link>
              <span v-else>-</span>
            </template>
          </el-table-column>
          <el-table-column label="工序" width="120">
            <template slot-scope="scope">{{ scope.row.work_order_process_info?.process?.name || '-' }}</template>
          </el-table-column>
          <el-table-column prop="work_content" label="任务内容" min-width="200" show-overflow-tooltip />
          <el-table-column label="分派部门" width="120">
            <template slot-scope="scope">{{ scope.row.assigned_department_name || '-' }}</template>
          </el-table-column>
          <el-table-column label="分派操作员" width="120">
            <template slot-scope="scope">{{ scope.row.assigned_operator_name || '-' }}</template>
          </el-table-column>
          <el-table-column label="关联对象" width="150">
            <template slot-scope="scope"><TaskRelatedInfo :task="scope.row" /></template>
          </el-table-column>
          <el-table-column prop="production_quantity" label="生产数量" width="100" align="right" />
          <el-table-column prop="quantity_completed" label="完成数量" width="100" align="right" />
          <el-table-column label="进度" width="80" align="right">
            <template slot-scope="scope">{{ taskService.calculateProgress(scope.row) }}%</template>
          </el-table-column>
          <el-table-column prop="status_display" label="状态" width="100">
            <template slot-scope="scope">
              <el-tag :type="taskService.getStatusType(scope.row.status)" size="small">{{ scope.row.status_display }}</el-tag>
            </template>
          </el-tool>
          <el-table-column label="操作" width="280" fixed="right">
            <template slot-scope="scope">
              <TaskActions :task="scope.row" @complete="handleCompleteTask" @update="showUpdateDialog" @assign="showAssignDialog" @split="showSplitDialog" />
            </template>
          </el-table-column>
        </VirtualTable>
      </template>
</replacement>
</task>
</tasks>

<verification>
1.  Load the Task List page with fewer than 100 tasks.
2.  Using browser dev tools, inspect the table element. It should be a standard `<el-table>`.
3.  Modify the backend or mock the API response to return more than 100 tasks (`total > 100`).
4.  Reload the Task List page.
5.  Inspect the table element again. It should now be the `<VirtualTable>` component, and the list should scroll smoothly.
6.  Verify that sorting, selection, and actions on the virtual table still work as expected.
</verification>

<success_criteria>
- The `VirtualTable` component must be used for rendering the task list when the total number of tasks is greater than 100.
- The standard `el-table` must be used otherwise.
- All table functionalities (sorting, selection, expanding, actions) must work correctly in both modes.
</success_criteria>
