---
phase: 05-Universal-Task-Visibility
plan: 02
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - frontend/src/views/task/TaskList.vue
  - frontend/src/views/task/components/BatchActionBar.vue
autonomous: true

must_haves:
  truths:
    - "User can select multiple tasks using checkboxes in the table"
    - "User can perform batch operations on selected tasks (assign, complete, delete)"
    - "Task list renders smoothly with 100+ tasks using optimized rendering"
    - "Selected tasks count displays in batch action bar"
    - "Batch operations show loading state and success/error messages"
  artifacts:
    - path: "frontend/src/views/task/TaskList.vue"
      provides: "Enhanced task list with batch selection and virtual scrolling support"
      contains: "el-table type=\"selection\""
    - path: "frontend/src/views/task/components/BatchActionBar.vue"
      provides: "Batch action toolbar with assign, complete, delete buttons"
      contains: "BatchActionBar component"
  key_links:
    - from: "frontend/src/views/task/TaskList.vue"
      to: "frontend/src/api/modules/workorder-task.js"
      via: "batch operation API calls"
      pattern: "batchAssign|batchComplete|batchDelete"
    - from: "frontend/src/views/task/components/BatchActionBar.vue"
      to: "frontend/src/views/task/TaskList.vue"
      via: "event emission for batch actions"
      pattern: "@batch-assign|@batch-complete|@batch-delete"
---

<objective>
Enhance TaskList.vue with multi-row selection using Element UI table selection column and create BatchActionBar component for bulk operations. Enable virtual scrolling mode for large datasets (100+ tasks).

Purpose: Implement PAGE-02 and PAGE-03 requirements - pagination/virtual scrolling and batch operations for task management.

Output: Enhanced TaskList.vue with selection column and new BatchActionBar.vue component.
</objective>

<execution_context>
@/home/chenjiaxing/.claude/get-shit-done/workflows/execute-plan.md
@/home/chenjiaxing/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-Task-Assignment-Core/04-01-SUMMARY.md
@.planning/phases/05-Universal-Task-Visibility/05-RESEARCH.md
@.planning/phases/05-Universal-Task-Visibility/05-01-SUMMARY.md

# Key existing files
@frontend/src/views/task/TaskList.vue
@frontend/src/api/modules/workorder-task.js
@backend/workorder/views/work_order_tasks/task_bulk.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BatchActionBar component for bulk operations</name>
  <files>frontend/src/views/task/components/BatchActionBar.vue</files>
  <action>
Create new file `frontend/src/views/task/components/BatchActionBar.vue`:

```vue
<template>
  <div class="batch-action-bar">
    <div class="batch-info">
      <el-icon class="el-icon-check" />
      <span>已选择 <strong>{{ selectedCount }}</strong> 项</span>
    </div>
    <div class="batch-actions">
      <!-- 批量分派 -->
      <el-button
        v-if="canBatchAssign"
        type="primary"
        size="small"
        :loading="loading"
        :disabled="loading"
        @click="$emit('batch-assign')"
      >
        <i class="el-icon-user" /> 批量分派
      </el-button>

      <!-- 批量完成 -->
      <el-button
        v-if="canBatchComplete"
        type="success"
        size="small"
        :loading="loading"
        :disabled="loading"
        @click="$emit('batch-complete')"
      >
        <i class="el-icon-circle-check" /> 批量完成
      </el-button>

      <!-- 批量删除 (仅草稿任务) -->
      <el-button
        v-if="canBatchDelete"
        type="danger"
        size="small"
        :loading="loading"
        :disabled="loading"
        @click="handleBatchDelete"
      >
        <i class="el-icon-delete" /> 批量删除
      </el-button>

      <!-- 批量取消 -->
      <el-button
        v-if="canBatchCancel"
        type="warning"
        size="small"
        :loading="loading"
        :disabled="loading"
        @click="$emit('batch-cancel')"
      >
        <i class="el-icon-circle-close" /> 批量取消
      </el-button>

      <!-- 清空选择 -->
      <el-button
        size="small"
        :loading="loading"
        :disabled="loading"
        @click="$emit('clear-selection')"
      >
        取消选择
      </el-button>
    </div>
  </div>
</template>

<script>
export default {
  name: 'BatchActionBar',

  props: {
    selectedCount: {
      type: Number,
      default: 0
    },
    loading: {
      type: Boolean,
      default: false
    },
    // 权限控制
    canBatchAssign: {
      type: Boolean,
      default: true
    },
    canBatchComplete: {
      type: Boolean,
      default: true
    },
    canBatchDelete: {
      type: Boolean,
      default: false  // 默认关闭，仅当选中全部为草稿任务时启用
    },
    canBatchCancel: {
      type: Boolean,
      default: true
    }
  },

  methods: {
    handleBatchDelete() {
      this.$confirm('确定要删除选中的任务吗？删除后无法恢复。', '批量删除确认', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      }).then(() => {
        this.$emit('batch-delete')
      }).catch(() => {
        // 用户取消
      })
    }
  }
}
</script>

<style scoped>
.batch-action-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 1000;
  background: #fff;
  border-top: 1px solid #ebeef5;
  box-shadow: 0 -2px 12px 0 rgba(0, 0, 0, 0.1);
  padding: 12px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.batch-info {
  display: flex;
  align-items: center;
  font-size: 14px;
  color: #606266;
}

.batch-info .el-icon-check {
  margin-right: 8px;
  color: #409eff;
  font-size: 18px;
}

.batch-info strong {
  color: #409eff;
  margin: 0 4px;
}

.batch-actions {
  display: flex;
  gap: 8px;
}

.batch-actions .el-button {
  display: flex;
  align-items: center;
}

.batch-actions .el-button i {
  margin-right: 4px;
}
</style>
```

This component provides:
- Visual feedback for selected count
- Action buttons for batch operations
- Confirmation dialog for destructive operations
- Loading state handling
- Permission-based button visibility
  </action>
  <verify>
- BatchActionBar.vue exists at frontend/src/views/task/components/
- Component has props: selectedCount, loading, canBatchAssign, canBatchComplete, canBatchDelete, canBatchCancel
- Component emits: batch-assign, batch-complete, batch-delete, batch-cancel, clear-selection
- Handle batch delete confirmation dialog
  </verify>
  <done>
BatchActionBar component created with all batch operation buttons and confirmation dialog.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add batch selection to TaskList.vue</name>
  <files>frontend/src/views/task/TaskList.vue</files>
  <action>
Modify `frontend/src/views/task/TaskList.vue` to add batch selection:

1. Import BatchActionBar component (around line 308):
```javascript
import BatchActionBar from './components/BatchActionBar.vue'
```

2. Add to components (around line 313):
```javascript
components: {
  Pagination,
  SkeletonLoader,
  TaskKanban,
  TaskLogs,
  TaskRelatedInfo,
  TaskActions,
  CompleteTaskDialog,
  UpdateTaskDialog,
  AssignTaskDialog,
  SplitTaskDialog,
  BatchActionBar  // NEW
},
```

3. Add selection column to el-table (around line 129, after expand column):
```vue
<el-table
  v-if="viewMode === 'table'"
  v-loading="loading && tableData.length > 0"
  :data="tableData"
  border
  style="width: 100%; margin-top: 20px;"
  :row-key="getRowKey"
  @sort-change="handleSortChange"
  @selection-change="handleSelectionChange"
>
  <el-table-column
    type="selection"
    width="55"
    :selectable="checkRowSelectable"
  />
```

4. Add BatchActionBar after the empty-state el-empty, before closing el-card (around line 247):
```vue
<!-- 批量操作栏 -->
<BatchActionBar
  v-if="selectedTasks.length > 0"
  :selected-count="selectedTasks.length"
  :loading="batchOperationLoading"
  :can-batch-assign="canBatchAssign()"
  :can-batch-complete="canBatchComplete()"
  :can-batch-delete="canBatchDelete()"
  :can-batch-cancel="canBatchCancel()"
  @batch-assign="handleBatchAssign"
  @batch-complete="handleBatchComplete"
  @batch-delete="handleBatchDelete"
  @batch-cancel="handleBatchCancel"
  @clear-selection="clearSelection"
/>
```

5. Add selection data properties (around line 336):
```javascript
data() {
  return {
    // ... existing properties ...
    selectedTasks: [],
    batchOperationLoading: false
  }
}
```

6. Add selection methods (around line 640):
```javascript
/**
 * 表格选择变化
 */
handleSelectionChange(selection) {
  this.selectedTasks = selection
},

/**
 * 检查行是否可选择
 */
checkRowSelectable(row) {
  // 草稿任务和已取消任务不允许批量操作
  if (row.status === 'cancelled') {
    return false
  }
  // 操作员只能选择自己的任务
  if (!this.$store.getters['auth/hasPermission']('workorder.change_workorder')) {
    return row.assigned_operator === this.$store.getters['auth/currentUser'].id
  }
  return true
},

/**
 * 清空选择
 */
clearSelection() {
  this.$refs.taskTable.clearSelection()
  this.selectedTasks = []
},

/**
 * 批量分派
 */
async handleBatchAssign() {
  // 复用现有的分派对话框逻辑，需要传递多个任务ID
  this.$message.info('批量分派功能将在下一步实现')
},

/**
 * 批量完成
 */
async handleBatchComplete() {
  try {
    await this.$confirm('确定要完成选中的任务吗？', '批量完成确认', {
      confirmButtonText: '确定',
      cancelButtonText: '取消',
      type: 'warning'
    })

    this.batchOperationLoading = true
    const taskIds = this.selectedTasks.map(t => t.id)
    await this.apiService.batchComplete({
      task_ids: taskIds,
      completion_reason: '批量完成'
    })
    ErrorHandler.showSuccess(`成功完成 ${taskIds.length} 个任务`)
    this.clearSelection()
    await this.loadData()
  } catch (error) {
    if (error !== 'cancel') {
      ErrorHandler.showMessage(error, '批量完成')
    }
  } finally {
    this.batchOperationLoading = false
  }
},

/**
 * 批量删除
 */
async handleBatchDelete() {
  try {
    this.batchOperationLoading = true
    const taskIds = this.selectedTasks.map(t => t.id)
    await this.apiService.batchDelete({
      task_ids: taskIds
    })
    ErrorHandler.showSuccess(`成功删除 ${taskIds.length} 个任务`)
    this.clearSelection()
    await this.loadData()
  } catch (error) {
    ErrorHandler.showMessage(error, '批量删除')
  } finally {
    this.batchOperationLoading = false
  }
},

/**
 * 批量取消
 */
async handleBatchCancel() {
  try {
    const { value } = await this.$prompt('请输入取消原因', '批量取消', {
      confirmButtonText: '确定',
      cancelButtonText: '取消',
      inputPattern: /\S+/,
      inputErrorMessage: '取消原因不能为空'
    })

    this.batchOperationLoading = true
    const taskIds = this.selectedTasks.map(t => t.id)
    await this.apiService.batchCancel({
      task_ids: taskIds,
      cancellation_reason: value
    })
    ErrorHandler.showSuccess(`成功取消 ${taskIds.length} 个任务`)
    this.clearSelection()
    await this.loadData()
  } catch (error) {
    if (error !== 'cancel') {
      ErrorHandler.showMessage(error, '批量取消')
    }
  } finally {
    this.batchOperationLoading = false
  }
},

/**
 * 检查是否可以批量分派
 */
canBatchAssign() {
  return this.selectedTasks.length > 0 && this.$store.getters['auth/hasPermission']('workorder.change_workorder')
},

/**
 * 检查是否可以批量完成
 */
canBatchComplete() {
  return this.selectedTasks.length > 0
},

/**
 * 检查是否可以批量删除（仅草稿任务）
 */
canBatchDelete() {
  return this.selectedTasks.length > 0 && this.selectedTasks.every(t => t.status === 'draft')
},

/**
 * 检查是否可以批量取消
 */
canBatchCancel() {
  return this.selectedTasks.length > 0 && this.selectedTasks.every(t => !['completed', 'cancelled'].includes(t.status))
},
```

7. Add ref to el-table (around line 128):
```vue
<el-table
  ref="taskTable"
  ...
>
```
  </action>
  <verify>
- BatchActionBar imported and registered as component
- Selection column added to el-table with type="selection"
- @selection-change handler connected
- BatchActionBar rendered with v-if="selectedTasks.length > 0"
- All handler methods present (handleBatchAssign, handleBatchComplete, handleBatchDelete, handleBatchCancel)
- Permission checks in canBatchAssign, canBatchDelete, etc.
- ref="taskTable" added to el-table
  </verify>
  <done>
TaskList.vue now supports multi-row selection with batch operations via BatchActionBar component.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Open TaskList page at /tasks
2. Select multiple tasks using checkboxes
3. Verify BatchActionBar appears at bottom showing selected count
4. Test batch complete:
   - Select multiple pending tasks
   - Click "批量完成"
   - Confirm dialog appears
   - Tasks complete successfully
5. Test batch cancel:
   - Select multiple in-progress tasks
   - Click "批量取消"
   - Enter reason
   - Tasks cancel successfully
6. Test row selectability:
   - As operator, verify only own tasks are selectable
   - As supervisor, all department tasks are selectable
7. Test clear selection:
   - Click "取消选择" button
   - All checkboxes cleared
8. Verify loading states during batch operations
</verification>

<success_criteria>
1. BatchActionBar component created with all required buttons and events
2. TaskList.vue has selection column and @selection-change handler
3. Batch operations work: batch complete and batch cancel functional
4. Permission-based row selectability (operators can only select own tasks)
5. Loading state displayed during batch operations
6. Success/error messages shown after operations
7. Selection clears after operation completes
</success_criteria>

<output>
After completion, create `.planning/phases/05-Universal-Task-Visibility/05-02-SUMMARY.md` with:
- BatchActionBar component implementation details
- Selection handler implementation
- Batch operation testing results
</output>
