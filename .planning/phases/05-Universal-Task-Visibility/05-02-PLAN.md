---
phase: 05-Universal-Task-Visibility
plan: 02
type: execute
wave: 2
depends_on: [05-01, 05-03]
files_modified:
  - frontend/src/views/task/TaskList.vue
  - frontend/src/views/task/components/BatchActionBar.vue
autonomous: true

must_haves:
  truths:
    - "User can select multiple tasks using checkboxes in the table"
    - "User can perform batch operations on selected tasks (assign, complete, delete)"
    - "Task list renders smoothly with 100+ tasks using virtual scrolling when enabled"
    - "Selected tasks count displays in batch action bar"
    - "Batch operations show loading state and success/error messages"
  artifacts:
    - path: "frontend/src/views/task/TaskList.vue"
      provides: "Enhanced task list with batch selection and conditional virtual scrolling"
      contains: "el-table type=\"selection\""
    - path: "frontend/src/views/task/components/BatchActionBar.vue"
      provides: "Batch action toolbar with assign, complete, delete buttons"
      contains: "BatchActionBar component"
  key_links:
    - from: "frontend/src/views/task/TaskList.vue"
      to: "frontend/src/api/modules/workorder-task.js"
      via: "batch operation API calls"
      pattern: "batchAssign|batchComplete|batchDelete"
    - from: "frontend/src/views/task/components/BatchActionBar.vue"
      to: "frontend/src/views/task/TaskList.vue"
      via: "event emission for batch actions"
      pattern: "@batch-assign|@batch-complete|@batch-delete"
---

<objective>
Enhance TaskList.vue with multi-row selection using Element UI table selection column, create BatchActionBar component for bulk operations, and add conditional virtual scrolling for large datasets (100+ tasks using existing VirtualTable.vue).

Purpose: Implement PAGE-02 (virtual scrolling for 100+ tasks) and PAGE-03 (batch operations) requirements.

Output: Enhanced TaskList.vue with selection column, conditional virtual scrolling support, and new BatchActionBar.vue component.

Note: depends_on includes 05-03 because batch operations use API methods added in that plan (batchAssign, batchComplete, batchCancel, batchDelete).
</objective>

<execution_context>
@/home/chenjiaxing/.claude/get-shit-done/workflows/execute-plan.md
@/home/chenjiaxing/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-Task-Assignment-Core/04-01-SUMMARY.md
@.planning/phases/05-Universal-Task-Visibility/05-RESEARCH.md
@.planning/phases/05-Universal-Task-Visibility/05-01-SUMMARY.md
@.planning/phases/05-Universal-Task-Visibility/05-03-SUMMARY.md

# Key existing files
@frontend/src/views/task/TaskList.vue
@frontend/src/api/modules/workorder-task.js
@frontend/src/components/VirtualTable.vue
@backend/workorder/views/work_order_tasks/task_bulk.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BatchActionBar component for bulk operations</name>
  <files>frontend/src/views/task/components/BatchActionBar.vue</files>
  <action>
Create new file `frontend/src/views/task/components/BatchActionBar.vue`:

```vue
<template>
  <div class="batch-action-bar">
    <div class="batch-info">
      <el-icon class="el-icon-check" />
      <span>已选择 <strong>{{ selectedCount }}</strong> 项</span>
    </div>
    <div class="batch-actions">
      <!-- 批量分派 -->
      <el-button
        v-if="canBatchAssign"
        type="primary"
        size="small"
        :loading="loading"
        :disabled="loading"
        @click="$emit('batch-assign')"
      >
        <i class="el-icon-user" /> 批量分派
      </el-button>

      <!-- 批量完成 -->
      <el-button
        v-if="canBatchComplete"
        type="success"
        size="small"
        :loading="loading"
        :disabled="loading"
        @click="$emit('batch-complete')"
      >
        <i class="el-icon-circle-check" /> 批量完成
      </el-button>

      <!-- 批量删除 (仅草稿任务) -->
      <el-button
        v-if="canBatchDelete"
        type="danger"
        size="small"
        :loading="loading"
        :disabled="loading"
        @click="handleBatchDelete"
      >
        <i class="el-icon-delete" /> 批量删除
      </el-button>

      <!-- 批量取消 -->
      <el-button
        v-if="canBatchCancel"
        type="warning"
        size="small"
        :loading="loading"
        :disabled="loading"
        @click="$emit('batch-cancel')"
      >
        <i class="el-icon-circle-close" /> 批量取消
      </el-button>

      <!-- 清空选择 -->
      <el-button
        size="small"
        :loading="loading"
        :disabled="loading"
        @click="$emit('clear-selection')"
      >
        取消选择
      </el-button>
    </div>
  </div>
</template>

<script>
export default {
  name: 'BatchActionBar',

  props: {
    selectedCount: {
      type: Number,
      default: 0
    },
    loading: {
      type: Boolean,
      default: false
    },
    // 权限控制
    canBatchAssign: {
      type: Boolean,
      default: true
    },
    canBatchComplete: {
      type: Boolean,
      default: true
    },
    canBatchDelete: {
      type: Boolean,
      default: false  // 默认关闭，仅当选中全部为草稿任务时启用
    },
    canBatchCancel: {
      type: Boolean,
      default: true
    }
  },

  methods: {
    handleBatchDelete() {
      this.$confirm('确定要删除选中的任务吗？删除后无法恢复。', '批量删除确认', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      }).then(() => {
        this.$emit('batch-delete')
      }).catch(() => {
        // 用户取消
      })
    }
  }
}
</script>

<style scoped>
.batch-action-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 1000;
  background: #fff;
  border-top: 1px solid #ebeef5;
  box-shadow: 0 -2px 12px 0 rgba(0, 0, 0, 0.1);
  padding: 12px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.batch-info {
  display: flex;
  align-items: center;
  font-size: 14px;
  color: #606266;
}

.batch-info .el-icon-check {
  margin-right: 8px;
  color: #409eff;
  font-size: 18px;
}

.batch-info strong {
  color: #409eff;
  margin: 0 4px;
}

.batch-actions {
  display: flex;
  gap: 8px;
}

.batch-actions .el-button {
  display: flex;
  align-items: center;
}

.batch-actions .el-button i {
  margin-right: 4px;
}
</style>
```

This component provides:
- Visual feedback for selected count
- Action buttons for batch operations
- Confirmation dialog for destructive operations
- Loading state handling
- Permission-based button visibility
  </action>
  <verify>
- BatchActionBar.vue exists at frontend/src/views/task/components/
- Component has props: selectedCount, loading, canBatchAssign, canBatchComplete, canBatchDelete, canBatchCancel
- Component emits: batch-assign, batch-complete, batch-delete, batch-cancel, clear-selection
- Handle batch delete confirmation dialog
  </verify>
  <done>
BatchActionBar component created with all batch operation buttons and confirmation dialog.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add selection column and data properties to TaskList.vue</name>
  <files>frontend/src/views/task/TaskList.vue</files>
  <action>
Modify `frontend/src/views/task/TaskList.vue` to add batch selection infrastructure:

1. Import BatchActionBar component (around line 308):
```javascript
import BatchActionBar from './components/BatchActionBar.vue'
```

2. Add to components (around line 313):
```javascript
components: {
  Pagination,
  SkeletonLoader,
  TaskKanban,
  TaskLogs,
  TaskRelatedInfo,
  TaskActions,
  CompleteTaskDialog,
  UpdateTaskDialog,
  AssignTaskDialog,
  SplitTaskDialog,
  BatchActionBar  // NEW
},
```

3. Add selection column to el-table (around line 129, after expand column):
```vue
<el-table
  ref="taskTable"
  v-if="viewMode === 'table'"
  v-loading="loading && tableData.length > 0"
  :data="tableData"
  border
  style="width: 100%; margin-top: 20px;"
  :row-key="getRowKey"
  @sort-change="handleSortChange"
  @selection-change="handleSelectionChange"
>
  <el-table-column
    type="selection"
    width="55"
    :selectable="checkRowSelectable"
  />
```

4. Add selection data properties (around line 336):
```javascript
data() {
  return {
    // ... existing properties ...
    selectedTasks: [],
    batchOperationLoading: false,
    batchAssignDialogVisible: false,
    departmentList: []
  }
}
```

5. Add basic selection methods (around line 640):
```javascript
/**
 * 表格选择变化
 */
handleSelectionChange(selection) {
  this.selectedTasks = selection
},

/**
 * 检查行是否可选择
 */
checkRowSelectable(row) {
  // 草稿任务和已取消任务不允许批量操作
  if (row.status === 'cancelled') {
    return false
  }
  // 操作员只能选择自己的任务
  if (!this.$store.getters['auth/hasPermission']('workorder.change_workorder')) {
    return row.assigned_operator === this.$store.getters['auth/currentUser'].id
  }
  return true
},

/**
 * 清空选择
 */
clearSelection() {
  this.$refs.taskTable.clearSelection()
  this.selectedTasks = []
},
```

6. Load department list in mounted hook (for BatchAssignDialog):
```javascript
async mounted() {
  // ... existing code ...

  // Load department list for batch assignment
  try {
    const response = await departmentAPI.getList({ page_size: 100 })
    this.departmentList = response.results || []
  } catch (error) {
    console.error('Failed to load department list:', error)
  }
}
```
  </action>
  <verify>
- BatchActionBar imported and registered as component
- Selection column added to el-table with type="selection"
- ref="taskTable" added to el-table
- @selection-change handler connected
- selectedTasks, batchOperationLoading, batchAssignDialogVisible, departmentList data properties added
- handleSelectionChange, checkRowSelectable, clearSelection methods present
- departmentList loaded in mounted hook
  </verify>
  <done>
TaskList.vue has selection infrastructure with data properties and basic selection methods.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add batch operation handlers to TaskList.vue</name>
  <files>frontend/src/views/task/TaskList.vue</files>
  <action>
Add batch operation handler methods to TaskList.vue (around line 660, after selection methods):

```javascript
/**
 * 批量分派
 */
async handleBatchAssign() {
  this.batchAssignDialogVisible = true
},

/**
 * 批量完成
 */
async handleBatchComplete() {
  try {
    await this.$confirm('确定要完成选中的任务吗？', '批量完成确认', {
      confirmButtonText: '确定',
      cancelButtonText: '取消',
      type: 'warning'
    })

    this.batchOperationLoading = true
    const taskIds = this.selectedTasks.map(t => t.id)
    await this.apiService.batchComplete({
      task_ids: taskIds,
      completion_reason: '批量完成'
    })
    ErrorHandler.showSuccess(`成功完成 ${taskIds.length} 个任务`)
    this.clearSelection()
    await this.loadData()
  } catch (error) {
    if (error !== 'cancel') {
      ErrorHandler.showMessage(error, '批量完成')
    }
  } finally {
    this.batchOperationLoading = false
  }
},

/**
 * 批量删除
 */
async handleBatchDelete() {
  try {
    this.batchOperationLoading = true
    const taskIds = this.selectedTasks.map(t => t.id)
    await this.apiService.batchDelete({
      task_ids: taskIds
    })
    ErrorHandler.showSuccess(`成功删除 ${taskIds.length} 个任务`)
    this.clearSelection()
    await this.loadData()
  } catch (error) {
    ErrorHandler.showMessage(error, '批量删除')
  } finally {
    this.batchOperationLoading = false
  }
},

/**
 * 批量取消
 */
async handleBatchCancel() {
  try {
    const { value } = await this.$prompt('请输入取消原因', '批量取消', {
      confirmButtonText: '确定',
      cancelButtonText: '取消',
      inputPattern: /\S+/,
      inputErrorMessage: '取消原因不能为空'
    })

    this.batchOperationLoading = true
    const taskIds = this.selectedTasks.map(t => t.id)
    await this.apiService.batchCancel({
      task_ids: taskIds,
      cancellation_reason: value
    })
    ErrorHandler.showSuccess(`成功取消 ${taskIds.length} 个任务`)
    this.clearSelection()
    await this.loadData()
  } catch (error) {
    if (error !== 'cancel') {
      ErrorHandler.showMessage(error, '批量取消')
    }
  } finally {
    this.batchOperationLoading = false
  }
},

/**
 * 检查是否可以批量分派
 */
canBatchAssign() {
  return this.selectedTasks.length > 0 && this.$store.getters['auth/hasPermission']('workorder.change_workorder')
},

/**
 * 检查是否可以批量完成
 */
canBatchComplete() {
  return this.selectedTasks.length > 0
},

/**
 * 检查是否可以批量删除（仅草稿任务）
 */
canBatchDelete() {
  return this.selectedTasks.length > 0 && this.selectedTasks.every(t => t.status === 'draft')
},

/**
 * 检查是否可以批量取消
 */
canBatchCancel() {
  return this.selectedTasks.length > 0 && this.selectedTasks.every(t => !['completed', 'cancelled'].includes(t.status))
},

/**
 * 确认批量分派（从 BatchAssignDialog 调用）
 */
async handleConfirmBatchAssign(data) {
  try {
    this.batchOperationLoading = true
    const taskIds = this.selectedTasks.map(t => t.id)
    await this.apiService.batchAssign({
      task_ids: taskIds,
      assigned_department: data.assigned_department,
      assigned_operator: data.assigned_operator || null,
      reason: data.reason,
      notes: data.notes
    })
    ErrorHandler.showSuccess(`成功分派 ${taskIds.length} 个任务`)
    this.batchAssignDialogVisible = false
    this.clearSelection()
    await this.loadData()
  } catch (error) {
    ErrorHandler.showMessage(error, '批量分派')
  } finally {
    this.batchOperationLoading = false
  }
},
```
  </action>
  <verify>
- handleBatchAssign opens batchAssignDialogVisible
- handleBatchComplete calls apiService.batchComplete with correct params
- handleBatchDelete calls apiService.batchDelete with correct params
- handleBatchCancel calls apiService.batchCancel with correct params
- handleConfirmBatchAssign calls apiService.batchAssign with correct params
- All canBatch* methods return proper boolean values
- Error handling with ErrorHandler for all methods
- clearSelection called after successful operations
  </verify>
  <done>
TaskList.vue has complete batch operation handlers using API methods from Plan 03.
  </done>
</task>

<task type="auto">
  <name>Task 4: Add BatchActionBar and BatchAssignDialog to TaskList.vue template</name>
  <files>frontend/src/views/task/TaskList.vue</files>
  <action>
Update TaskList.vue template to add BatchActionBar component and BatchAssignDialog:

1. Import BatchAssignDialog (around line 308):
```javascript
import BatchAssignDialog from './components/BatchAssignDialog.vue'
```

2. Add to components (around line 324):
```javascript
components: {
  // ... existing components
  BatchActionBar,
  BatchAssignDialog  // NEW
},
```

3. Add BatchActionBar after the empty-state el-empty, before closing el-card (around line 247):
```vue
<!-- 批量操作栏 -->
<BatchActionBar
  v-if="selectedTasks.length > 0"
  :selected-count="selectedTasks.length"
  :loading="batchOperationLoading"
  :can-batch-assign="canBatchAssign()"
  :can-batch-complete="canBatchComplete()"
  :can-batch-delete="canBatchDelete()"
  :can-batch-cancel="canBatchCancel()"
  @batch-assign="handleBatchAssign"
  @batch-complete="handleBatchComplete"
  @batch-delete="handleBatchDelete"
  @batch-cancel="handleBatchCancel"
  @clear-selection="clearSelection"
/>
```

4. Add BatchAssignDialog before closing div (around line 285):
```vue
<!-- 批量分派对话框 -->
<BatchAssignDialog
  :visible.sync="batchAssignDialogVisible"
  :task-count="selectedTasks.length"
  :department-list="departmentList"
  @confirm="handleConfirmBatchAssign"
/>
```
  </action>
  <verify>
- BatchAssignDialog imported and registered
- BatchActionBar rendered with v-if="selectedTasks.length > 0"
- BatchActionBar has all props bound: selectedCount, loading, canBatch*, events
- BatchAssignDialog rendered with correct props and @confirm handler
- batchAssignDialogVisible controls dialog visibility
- departmentList passed to BatchAssignDialog
  </verify>
  <done>
TaskList.vue template includes BatchActionBar and BatchAssignDialog with proper bindings.
  </done>
</task>

<task type="auto">
  <name>Task 5: Add conditional virtual scrolling for 100+ tasks</name>
  <files>frontend/src/views/task/TaskList.vue</files>
  <action>
Add conditional virtual scrolling support using existing VirtualTable.vue component:

1. Import VirtualTable (around line 308):
```javascript
import VirtualTable from '@/components/VirtualTable.vue'
```

2. Add to components (around line 324):
```javascript
components: {
  // ... existing components
  VirtualTable  // NEW
},
```

3. Add computed property for virtual scrolling threshold (around line 430):
```javascript
computed: {
  // ... existing computed properties ...

  /**
   * 是否启用虚拟滚动（总数超过100条时启用）
   */
  shouldUseVirtualScroll() {
    return this.total > 100
  }
},
```

4. Replace el-table with conditional rendering (around line 128):
```vue
<!-- 标准表格（数据量少时） -->
<el-table
  v-if="viewMode === 'table' && !shouldUseVirtualScroll"
  ref="taskTable"
  v-loading="loading && tableData.length > 0"
  :data="tableData"
  border
  style="width: 100%; margin-top: 20px;"
  :row-key="getRowKey"
  @sort-change="handleSortChange"
  @selection-change="handleSelectionChange"
>
  <!-- existing columns -->
</el-table>

<!-- 虚拟滚动表格（数据量大时，100+条） -->
<VirtualTable
  v-if="viewMode === 'table' && shouldUseVirtualScroll"
  ref="virtualTable"
  :data="tableData"
  :row-key="getRowKey"
  :item-size="50"
  :height="600"
  @selection-change="handleSelectionChange"
>
  <template #default="{ row, index }">
    <!-- Render same columns as el-table, using VirtualTable's slot syntax -->
    <tr :key="getRowKey(row)">
      <td><el-checkbox :value="isRowSelected(row)" @change="toggleRowSelection(row)" /></td>
      <td>{{ row.id }}</td>
      <td>{{ row.work_order_process?.work_order?.order_number || '-' }}</td>
      <!-- ... other columns matching el-table structure ... -->
    </tr>
  </template>
</VirtualTable>
```

5. Add helper methods for virtual table selection:
```javascript
/**
 * 检查虚拟表格行是否选中
 */
isRowSelected(row) {
  return this.selectedTasks.some(t => t.id === row.id)
},

/**
 * 切换虚拟表格行选择
 */
toggleRowSelection(row) {
  const index = this.selectedTasks.findIndex(t => t.id === row.id)
  if (index > -1) {
    this.selectedTasks.splice(index, 1)
  } else {
    this.selectedTasks.push(row)
  }
},
```

Note: VirtualTable.vue already exists at frontend/src/components/VirtualTable.vue. Use its props (data, rowKey, itemSize, height) and selection slot pattern.
  </action>
  <verify>
- VirtualTable imported and registered
- shouldUseVirtualScroll computed returns true when total > 100
- el-table rendered when !shouldUseVirtualScroll
- VirtualTable rendered when shouldUseVirtualScroll
- handleSelectionChange works with both table types
- isRowSelected and toggleRowSelection methods exist for VirtualTable selection
  </verify>
  <done>
TaskList.vue uses VirtualTable for 100+ tasks, standard el-table for smaller datasets.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Open TaskList page at /tasks
2. Select multiple tasks using checkboxes
3. Verify BatchActionBar appears at bottom showing selected count
4. Test batch complete:
   - Select multiple pending tasks
   - Click "批量完成"
   - Confirm dialog appears
   - Tasks complete successfully
5. Test batch cancel:
   - Select multiple in-progress tasks
   - Click "批量取消"
   - Enter reason
   - Tasks cancel successfully
6. Test batch assign:
   - Select multiple tasks
   - Click "批量分派"
   - Select department and operator
   - Tasks assigned successfully
7. Test row selectability:
   - As operator, verify only own tasks are selectable
   - As supervisor, all department tasks are selectable
8. Test clear selection:
   - Click "取消选择" button
   - All checkboxes cleared
9. Verify loading states during batch operations
10. Test virtual scrolling:
    - Load 100+ tasks (use pagination or create test data)
    - Verify VirtualTable is used instead of el-table
    - Scroll smoothly through large dataset
</verification>

<success_criteria>
1. BatchActionBar component created with all required buttons and events
2. TaskList.vue has selection column and @selection-change handler
3. Batch operations work: batch assign, batch complete, batch delete, batch cancel functional
4. Permission-based row selectability (operators can only select own tasks)
5. Loading state displayed during batch operations
6. Success/error messages shown after operations
7. Selection clears after operation completes
8. Virtual scrolling activates when total > 100 tasks
9. departmentList loaded for BatchAssignDialog
10. BatchAssignDialog integration works with handleConfirmBatchAssign
</success_criteria>

<output>
After completion, create `.planning/phases/05-Universal-Task-Visibility/05-02-SUMMARY.md` with:
- BatchActionBar component implementation details
- BatchAssignDialog integration
- Selection handler implementation
- Virtual scrolling implementation
- Batch operation testing results
</output>
