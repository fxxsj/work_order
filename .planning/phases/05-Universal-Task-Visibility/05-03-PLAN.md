---
phase: 05-Universal-Task-Visibility
plan: 03
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - backend/workorder/views/work_order_tasks/task_bulk.py
  - frontend/src/api/modules/workorder-task.js
  - frontend/src/views/task/components/BatchAssignDialog.vue
autonomous: true

must_haves:
  truths:
    - "User can batch assign multiple tasks to a department and operator"
    - "User can batch delete draft tasks with permission validation"
    - "User can batch update task status (complete, cancel)"
    - "Batch operations return partial success/failure results"
    - "Frontend shows detailed error messages for failed tasks in batch"
  artifacts:
    - path: "backend/workorder/views/work_order_tasks/task_bulk.py"
      provides: "TaskBulkMixin with batch_delete and enhanced batch_assign"
      contains: "batch_delete method"
    - path: "frontend/src/api/modules/workorder-task.js"
      provides: "API methods for batch operations"
      exports: ["batchAssign", "batchComplete", "batchCancel", "batchDelete"]
    - path: "frontend/src/views/task/components/BatchAssignDialog.vue"
      provides: "Batch assignment dialog component"
      contains: "BatchAssignDialog component"
  key_links:
    - from: "frontend/src/api/modules/workorder-task.js"
      to: "backend/workorder/views/work_order_tasks/task_bulk.py"
      via: "batch operation API endpoints"
      pattern: "batch_assign|batch_complete|batch_cancel|batch-delete"
    - from: "frontend/src/views/task/components/BatchAssignDialog.vue"
      to: "frontend/src/views/task/TaskList.vue"
      via: "dialog integration"
      pattern: "handleBatchAssign"
---

<objective>
Implement batch operation API endpoints (batch assign with dialog, batch delete for draft tasks) and integrate frontend API methods. TaskBulkMixin already has batch_update_quantity, batch_complete, batch_cancel, batch_assign - need to add batch_delete and enhance batch_assign.

Purpose: Complete PAGE-03 requirement for batch operations on task list.

Output: Enhanced TaskBulkMixin with batch_delete, BatchAssignDialog component, and frontend API integration.
</objective>

<execution_context>
@/home/chenjiaxing/.claude/get-shit-done/workflows/execute-plan.md
@/home/chenjiaxing/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-Task-Assignment-Core/04-01-SUMMARY.md
@.planning/phases/05-Universal-Task-Visibility/05-RESEARCH.md
@.planning/phases/05-Universal-Task-Visibility/05-01-PLAN.md
@.planning/phases/05-Universal-Task-Visibility/05-02-PLAN.md

# Key existing files
@backend/workorder/views/work_order_tasks/task_bulk.py
@frontend/src/api/modules/workorder-task.js
@frontend/src/views/task/components/AssignTaskDialog.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add batch_delete endpoint to TaskBulkMixin</name>
  <files>backend/workorder/views/work_order_tasks/task_bulk.py</files>
  <action>
The TaskBulkMixin already has batch_update_quantity, batch_complete, batch_cancel, and batch_assign methods.
Add the missing batch_delete method at the end of the class (after batch_assign, around line 578):

```python
@action(detail=False, methods=['post'], url_path='batch-delete')
def batch_delete(self, request):
    """批量删除任务（仅草稿状态）

    请求参数：
    - task_ids: 任务ID列表（必填）
    - reason: 删除原因（可选）

    权限：
    - 施工单创建人可以删除草稿任务
    - 超级管理员可以删除草稿任务
    """
    from workorder.models.core import TaskLog

    task_ids = request.data.get('task_ids', [])
    reason = request.data.get('reason', '批量删除')

    if not task_ids:
        return Response(
            {'error': '请提供任务ID列表'},
            status=status.HTTP_400_BAD_REQUEST
        )

    # 获取任务
    tasks = WorkOrderTask.objects.filter(id__in=task_ids)
    if tasks.count() != len(task_ids):
        return Response(
            {'error': '部分任务不存在'},
            status=status.HTTP_400_BAD_REQUEST
        )

    user = request.user
    deleted_tasks = []
    failed_tasks = []

    for task in tasks:
        try:
            # 只允许删除草稿状态的任务
            if task.status != 'draft':
                failed_tasks.append({
                    'task_id': task.id,
                    'error': '只能删除草稿状态的任务'
                })
                continue

            # 权限检查：施工单创建人或超级管理员
            can_delete = False
            if user.is_superuser:
                can_delete = True
            elif task.work_order_process.work_order.created_by == user:
                can_delete = True

            if not can_delete:
                failed_tasks.append({
                    'task_id': task.id,
                    'error': '您没有权限删除此任务'
                })
                continue

            # 记录删除前的信息
            task_id = task.id
            work_content = task.work_content

            # 删除任务
            task.delete()

            # 记录删除日志（使用 TaskLog 如果有外键关联问题则跳过）
            # 由于任务已删除，无法创建关联日志，改为在响应中记录

            deleted_tasks.append({
                'task_id': task_id,
                'work_content': work_content
            })

        except Exception as e:
            failed_tasks.append({
                'task_id': task.id,
                'error': str(e)
            })

    return Response({
        'message': f'成功删除 {len(deleted_tasks)} 个任务，失败 {len(failed_tasks)} 个',
        'deleted_count': len(deleted_tasks),
        'failed_count': len(failed_tasks),
        'deleted_tasks': deleted_tasks,
        'failed_tasks': failed_tasks
    })
```

Also add the Notification import at the top if not present (it's used in batch_cancel around line 415):
```python
from workorder.models.core import WorkOrderTask, TaskLog, Notification
```

Note: batch_delete uses status='draft' check to ensure only draft tasks can be deleted, as formal tasks should use batch_cancel instead.
  </action>
  <verify>
- batch_delete method exists in TaskBulkMixin
- Method validates only draft tasks can be deleted
- Permission check for work order creator or superuser
- Returns partial success/failure response
- Notification import added at top if needed
  </verify>
  <done>
TaskBulkMixin now has batch_delete endpoint for deleting draft tasks with permission validation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BatchAssignDialog component</name>
  <files>frontend/src/views/task/components/BatchAssignDialog.vue</files>
  <action>
Create new file `frontend/src/views/task/components/BatchAssignDialog.vue`:

```vue
<template>
  <el-dialog
    :visible.sync="dialogVisible"
    :title="`批量分派 ${taskCount} 个任务`"
    width="500px"
    @close="handleClose"
  >
    <el-form ref="form" :model="form" :rules="rules" label-width="100px">
      <!-- 分派部门 -->
      <el-form-item label="分派部门" prop="assigned_department">
        <el-select
          v-model="form.assigned_department"
          placeholder="请选择部门"
          filterable
          clearable
          :loading="loadingDepartments"
          @change="handleDepartmentChange"
        >
          <el-option
            v-for="dept in departmentList"
            :key="dept.id"
            :label="dept.name"
            :value="dept.id"
          />
        </el-select>
      </el-form-item>

      <!-- 分派操作员 -->
      <el-form-item label="分派操作员" prop="assigned_operator">
        <el-select
          v-model="form.assigned_operator"
          placeholder="请选择操作员"
          filterable
          clearable
          :loading="loadingOperators"
          :disabled="!form.assigned_department"
        >
          <el-option
            v-for="operator in operatorList"
            :key="operator.id"
            :label="operator.username || `${operator.first_name}${operator.last_name}`"
            :value="operator.id"
          />
        </el-select>
        <div class="form-tip">留空则只分派部门，不分派具体操作员</div>
      </el-form-item>

      <!-- 调整原因 -->
      <el-form-item label="调整原因" prop="reason">
        <el-input
          v-model="form.reason"
          type="textarea"
          :rows="3"
          placeholder="请输入调整原因（可选）"
        />
      </el-form-item>

      <!-- 备注 -->
      <el-form-item label="备注" prop="notes">
        <el-input
          v-model="form.notes"
          type="textarea"
          :rows="2"
          placeholder="请输入备注（可选）"
        />
      </el-form-item>
    </el-form>

    <div slot="footer" class="dialog-footer">
      <el-button @click="handleClose">取消</el-button>
      <el-button type="primary" :loading="submitting" @click="handleSubmit">
        确定分派
      </el-button>
    </div>
  </el-dialog>
</template>

<script>
import { departmentAPI } from '@/api/modules'
import { getUserList } from '@/api/user'
import ErrorHandler from '@/utils/errorHandler'

export default {
  name: 'BatchAssignDialog',

  props: {
    visible: {
      type: Boolean,
      default: false
    },
    taskCount: {
      type: Number,
      default: 0
    },
    departmentList: {
      type: Array,
      default: () => []
    }
  },

  data() {
    return {
      form: {
        assigned_department: null,
        assigned_operator: null,
        reason: '',
        notes: ''
      },
      rules: {
        assigned_department: [
          { required: true, message: '请选择分派部门', trigger: 'change' }
        ]
      },
      operatorList: [],
      loadingOperators: false,
      loadingDepartments: false,
      submitting: false
    }
  },

  computed: {
    dialogVisible: {
      get() {
        return this.visible
      },
      set(val) {
        this.$emit('update:visible', val)
      }
    }
  },

  watch: {
    visible(val) {
      if (val) {
        this.resetForm()
      }
    }
  },

  methods: {
    resetForm() {
      this.form = {
        assigned_department: null,
        assigned_operator: null,
        reason: '',
        notes: ''
      }
      this.operatorList = []
      if (this.$refs.form) {
        this.$refs.form.clearValidate()
      }
    },

    async handleDepartmentChange(departmentId) {
      this.form.assigned_operator = null
      if (!departmentId) {
        this.operatorList = []
        return
      }
      this.loadingOperators = true
      try {
        const response = await getUserList({ department: departmentId })
        this.operatorList = response.results || []
      } catch (error) {
        ErrorHandler.showMessage(error, '加载操作员列表')
      } finally {
        this.loadingOperators = false
      }
    },

    handleClose() {
      this.resetForm()
      this.dialogVisible = false
    },

    handleSubmit() {
      this.$refs.form.validate(async (valid) => {
        if (!valid) return

        this.$emit('confirm', { ...this.form })
      })
    }
  }
}
</script>

<style scoped>
.form-tip {
  font-size: 12px;
  color: #909399;
  margin-top: 4px;
}

.dialog-footer {
  text-align: right;
}
</style>
```

This component provides:
- Department and operator selection
- Optional reason and notes fields
- Loads operators when department changes
- Form validation
  </action>
  <verify>
- BatchAssignDialog.vue exists at frontend/src/views/task/components/
- Component has props: visible, taskCount, departmentList
- Component emits: update:visible, confirm
- Form fields: assigned_department, assigned_operator, reason, notes
- Department change handler loads operators
  </verify>
  <done>
BatchAssignDialog component created for batch task assignment.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add frontend API methods for batch operations</name>
  <files>frontend/src/api/modules/workorder-task.js</files>
  <action>
Read the current workorder-task.js file and add batch operation methods if not present.

Add these methods to the WorkOrderTaskAPI class:

```javascript
/**
 * 批量分派任务
 * @param {Object} data
 * @param {Array<number>} data.task_ids - 任务ID列表
 * @param {number} data.assigned_department - 分派部门ID
 * @param {number} data.assigned_operator - 分派操作员ID（可选）
 * @param {string} data.reason - 调整原因（可选）
 * @param {string} data.notes - 备注（可选）
 * @returns {Promise}
 */
batchAssign(data) {
  return this.request({
    url: `${this.baseUrl}batch_assign/`,
    method: 'post',
    data: {
      task_ids: data.task_ids,
      assigned_department: data.assigned_department,
      assigned_operator: data.assigned_operator,
      reason: data.reason,
      notes: data.notes
    }
  })
},

/**
 * 批量完成任务
 * @param {Object} data
 * @param {Array<number>} data.task_ids - 任务ID列表
 * @param {string} data.completion_reason - 完成理由（可选）
 * @param {string} data.notes - 备注（可选）
 * @returns {Promise}
 */
batchComplete(data) {
  return this.request({
    url: `${this.baseUrl}batch_complete/`,
    method: 'post',
    data: {
      task_ids: data.task_ids,
      completion_reason: data.completion_reason || '',
      notes: data.notes || ''
    }
  })
},

/**
 * 批量取消任务
 * @param {Object} data
 * @param {Array<number>} data.task_ids - 任务ID列表
 * @param {string} data.cancellation_reason - 取消原因（必填）
 * @param {string} data.notes - 备注（可选）
 * @returns {Promise}
 */
batchCancel(data) {
  return this.request({
    url: `${this.baseUrl}batch_cancel/`,
    method: 'post',
    data: {
      task_ids: data.task_ids,
      cancellation_reason: data.cancellation_reason,
      notes: data.notes || ''
    }
  })
},

/**
 * 批量删除任务（仅草稿任务）
 * @param {Object} data
 * @param {Array<number>} data.task_ids - 任务ID列表
 * @param {string} data.reason - 删除原因（可选）
 * @returns {Promise}
 */
batchDelete(data) {
  return this.request({
    url: `${this.baseUrl}batch-delete/`,
    method: 'post',
    data: {
      task_ids: data.task_ids,
      reason: data.reason || '批量删除'
    }
  })
}
```

If these methods already exist, verify they match the expected signatures and endpoints.
  </action>
  <verify>
- batchAssign method exists with correct endpoint (batch_assign/)
- batchComplete method exists with correct endpoint (batch_complete/)
- batchCancel method exists with correct endpoint (batch_cancel/)
- batchDelete method exists with correct endpoint (batch-delete/)
- All methods accept task_ids array and return Promise
  </verify>
  <done>
Frontend API module has all batch operation methods (batchAssign, batchComplete, batchCancel, batchDelete).
  </done>
</task>

<task type="auto">
  <name>Task 4: Integrate BatchAssignDialog into TaskList.vue</name>
  <files>frontend/src/views/task/TaskList.vue</files>
  <action>
Update TaskList.vue to integrate the BatchAssignDialog:

1. Import BatchAssignDialog (around line 308):
```javascript
import BatchAssignDialog from './components/BatchAssignDialog.vue'
```

2. Add to components (around line 324):
```javascript
components: {
  // ... existing components
  BatchActionBar,
  BatchAssignDialog  // NEW
},
```

3. Add data properties (around line 367):
```javascript
batchAssignDialogVisible: false,
```

4. Add BatchAssignDialog template before closing div (around line 285):
```vue
<!-- 批量分派对话框 -->
<BatchAssignDialog
  :visible.sync="batchAssignDialogVisible"
  :task-count="selectedTasks.length"
  :department-list="departmentList"
  @confirm="handleConfirmBatchAssign"
/>
```

5. Update handleBatchAssign method (around line 650):
```javascript
/**
 * 批量分派
 */
async handleBatchAssign() {
  this.batchAssignDialogVisible = true
},

/**
 * 确认批量分派
 */
async handleConfirmBatchAssign(data) {
  try {
    this.batchOperationLoading = true
    const taskIds = this.selectedTasks.map(t => t.id)
    await this.apiService.batchAssign({
      task_ids: taskIds,
      assigned_department: data.assigned_department,
      assigned_operator: data.assigned_operator || null,
      reason: data.reason,
      notes: data.notes
    })
    ErrorHandler.showSuccess(`成功分派 ${taskIds.length} 个任务`)
    this.batchAssignDialogVisible = false
    this.clearSelection()
    await this.loadData()
  } catch (error) {
    ErrorHandler.showMessage(error, '批量分派')
  } finally {
    this.batchOperationLoading = false
  }
},
```

Replace the placeholder handleBatchAssign method with the actual implementation.
  </action>
  <verify>
- BatchAssignDialog imported and registered
- Dialog rendered with correct props and @confirm handler
- batchAssignDialogVisible data property exists
- handleBatchAssign opens dialog
- handleConfirmBatchAssign calls API with correct parameters
- Dialog closes and refreshes data after success
  </verify>
  <done>
BatchAssignDialog integrated into TaskList.vue for batch task assignment.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Test batch delete:
   - Select multiple draft tasks
   - Click "批量删除"
   - Confirm deletion
   - Tasks deleted successfully
   - Non-draft tasks cannot be deleted (error shown)

2. Test batch assign:
   - Select multiple tasks
   - Click "批量分派"
   - Select department and operator
   - Confirm assignment
   - Tasks assigned successfully

3. Test batch complete:
   - Select multiple pending tasks
   - Click "批量完成"
   - Confirm
   - Tasks completed successfully

4. Test batch cancel:
   - Select multiple in-progress tasks
   - Click "批量取消"
   - Enter reason
   - Tasks cancelled successfully

5. Test partial failure:
   - Select mix of draft and non-draft tasks
   - Try batch delete
   - Only draft tasks deleted, others show in failed list
</verification>

<success_criteria>
1. batch_delete endpoint added to TaskBulkMixin
2. BatchAssignDialog component created and integrated
3. Frontend API methods for all batch operations present
4. Batch assign dialog works with department/operator selection
5. Partial success/failure handling displays correct error messages
6. Selection clears after successful batch operation
</success_criteria>

<output>
After completion, create `.planning/phases/05-Universal-Task-Visibility/05-03-SUMMARY.md` with:
- batch_delete endpoint implementation
- BatchAssignDialog component details
- API method additions
- Batch operation testing results
</output>
