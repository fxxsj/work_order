---
wave: 3
depends_on:
  - 05-01
files_modified:
  - "backend/workorder/views/work_order_tasks/task_filters.py"
  - "frontend/src/views/task/TaskList.vue"
autonomous: true
---
<objective>
Address the gap from plan `05-01` by adding a `priority` filter to the Task List API and integrating it into the frontend UI. This will allow users to filter tasks based on the priority of their parent work order.
</objective>

<tasks>
<task>
<file_path>backend/workorder/views/work_order_tasks/task_filters.py</file_path>
<action>replace</action>
<instructions>In the `WorkOrderTaskFilterSet` class, add a `priority` filter that targets the related `WorkOrder` model's `priority` field. Also add it to the `Meta.fields` list.</instructions>
<source>
    # 自定义筛选：按操作员姓名搜索
    operator_name = CharFilter(method='filter_operator_name')

    # 自定义筛选：草稿任务
    is_draft = CharFilter(method='filter_is_draft')

    class Meta:
        model = WorkOrderTask
        fields = [
            'status', 'task_type', 'assigned_department',
            'assigned_operator', 'work_order_process',
            'work_order_number', 'work_content', 'department_name'
        ]
</source>
<replacement>
    # 自定义筛选：按操作员姓名搜索
    operator_name = CharFilter(method='filter_operator_name')

    # 自定义筛选：草稿任务
    is_draft = CharFilter(method='filter_is_draft')

    # 关联筛选：按施工单优先级筛选
    priority = CharFilter(field_name='work_order_process__work_order__priority')

    class Meta:
        model = WorkOrderTask
        fields = [
            'status', 'task_type', 'assigned_department',
            'assigned_operator', 'work_order_process',
            'work_order_number', 'work_content', 'department_name',
            'priority'
        ]
</replacement>
</task>
<task>
<file_path>frontend/src/views/task/TaskList.vue</file_path>
<action>replace</action>
<instructions>Add a priority dropdown to the filter section, bind it to a new `filters.priority` model, and add new `priorityOptions` and `priority` to the `hasFilters` computed property. Also, add `priority` to the `fetchData` parameters.</instructions>
<source>
          <el-col :span="3">
            <el-select
              v-model="filters.work_order_process"
              placeholder="工序"
              clearable
              filterable
              @change="handleSearchDebounced"
            >
</source>
<replacement>
          <el-col :span="3">
            <el-select
              v-model="filters.priority"
              placeholder="优先级"
              clearable
              @change="handleSearchDebounced"
            >
              <el-option
                v-for="p in priorityOptions"
                :key="p.value"
                :label="p.label"
                :value="p.value"
              />
            </el-select>
          </el-col>
          <el-col :span="3">
            <el-select
              v-model="filters.work_order_process"
              placeholder="工序"
              clearable
              filterable
              @change="handleSearchDebounced"
            >
</replacement>
</task>
<task>
<file_path>frontend/src/views/task/TaskList.vue</file_path>
<action>replace</action>
<instructions>Add the new `priority` filter to the `filters` data object.</instructions>
<source>
      // 额外的筛选条件
      filters: {
        task_type: '',
        work_order_process: '',
        assigned_department: ''
      },
</source>
<replacement>
      // 额外的筛选条件
      filters: {
        task_type: '',
        work_order_process: '',
        assigned_department: '',
        priority: ''
      },
</replacement>
</task>
<task>
<file_path>frontend/src/views/task/TaskList.vue</file_path>
<action>replace</action>
<instructions>Add `priorityOptions` to the computed properties and `priority` to `hasFilters`.</instructions>
<source>
    taskTypeOptions() {
      return this.taskService.getTaskTypeOptions()
    },

    /**
     * 是否有筛选条件
     */
    hasFilters() {
      return this.searchText ||
             this.filters.status ||
             this.filters.task_type ||
             this.filters.assigned_department ||
             this.filters.work_order_process
    },
</source>
<replacement>
    taskTypeOptions() {
      return this.taskService.getTaskTypeOptions()
    },

    /**
     * 优先级选项
     */
    priorityOptions() {
      return [
        { value: 'low', label: '低' },
        { value: 'normal', label: '普通' },
        { value: 'high', label: '高' },
        { value: 'urgent', label: '紧急' }
      ]
    },

    /**
     * 是否有筛选条件
     */
    hasFilters() {
      return this.searchText ||
             this.filters.status ||
             this.filters.task_type ||
             this.filters.assigned_department ||
             this.filters.work_order_process ||
             this.filters.priority
    },
</replacement>
</task>
<task>
<file_path>frontend/src/views/task/TaskList.vue</file_path>
<action>replace</action>
<instructions>Pass the new `priority` filter to the `getList` API call.</instructions>
<source>
        search: this.searchText || undefined,
        status: this.filters.status || undefined,
        task_type: this.filters.task_type || undefined,
        work_order_process: this.filters.work_order_process || undefined,
        assigned_department: this.filters.assigned_department || undefined
      }
</source>
<replacement>
        search: this.searchText || undefined,
        status: this.filters.status || undefined,
        task_type: this.filters.task_type || undefined,
        work_order_process: this.filters.work_order_process || undefined,
        assigned_department: this.filters.assigned_department || undefined,
        priority: this.filters.priority || undefined
      }
</replacement>
</task>
</tasks>

<verification>
1.  Navigate to the Task List page.
2.  Verify that a new "优先级" (Priority) filter dropdown is present.
3.  Select "紧急" (Urgent) from the dropdown.
4.  The task list should update to show only tasks belonging to work orders with "Urgent" priority.
5.  Clear the filter and verify the list returns to its original state.
</verification>

<success_criteria>
- The Task List API must accept and filter by a `priority` query parameter.
- The frontend Task List page must include a working dropdown filter for priority.
</success_criteria>
