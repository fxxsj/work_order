---
phase: 05-Universal-Task-Visibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/workorder/views/work_order_tasks/task_main.py
  - backend/workorder/views/work_order_tasks/task_filters.py
  - frontend/src/api/modules/workorder-task.js
autonomous: true

must_haves:
  truths:
    - "User can access task list endpoint and receives filtered tasks based on permissions"
    - "User can filter tasks by department, status, assignee, priority, and process"
    - "User can search tasks by task number, work order number, or content description"
    - "Query uses select_related/prefetch_related to avoid N+1 queries"
    - "Operators see only their assigned tasks by default, supervisors see department tasks"
  artifacts:
    - path: "backend/workorder/views/work_order_tasks/task_filters.py"
      provides: "WorkOrderTaskFilterSet with multi-field filtering"
      contains: "class WorkOrderTaskFilterSet"
    - path: "backend/workorder/views/work_order_tasks/task_main.py"
      provides: "Enhanced BaseWorkOrderTaskViewSet with filter_backends"
      exports: ["get_queryset", "filter_backends", "filterset_class"]
    - path: "frontend/src/api/modules/workorder-task.js"
      provides: "API methods for filtered task listing"
      exports: ["getList", "getClaimable", "getDepartmentOperators"]
  key_links:
    - from: "frontend/src/api/modules/workorder-task.js"
      to: "backend/workorder/views/work_order_tasks/task_main.py"
      via: "getList() with filter parameters"
      pattern: "status|task_type|assigned_department|work_order_process|search"
    - from: "backend/workorder/views/work_order_tasks/task_main.py"
      to: "backend/workorder/views/work_order_tasks/task_filters.py"
      via: "filterset_class import"
      pattern: "from .task_filters import WorkOrderTaskFilterSet"
---

<objective>
Build enhanced task list API with DjangoFilterBackend for multi-field filtering, search across work order numbers and task content, and permission-based querysets that respect role visibility rules.

Purpose: Enable Phase 05 goal of universal task visibility with filtering and search capabilities. The API must serve data efficiently to frontend components.

Output: Enhanced BaseWorkOrderTaskViewSet with WorkOrderTaskFilterSet, search integration, and optimized querysets.
</objective>

<execution_context>
@/home/chenjiaxing/.claude/get-shit-done/workflows/execute-plan.md
@/home/chenjiaxing/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-Task-Assignment-Core/04-01-SUMMARY.md
@.planning/phases/05-Universal-Task-Visibility/05-RESEARCH.md

# Key existing files to understand patterns
@backend/workorder/views/work_order_tasks/task_main.py
@backend/workorder/views/work_order_tasks/task_bulk.py
@frontend/src/views/task/TaskList.vue
@backend/workorder/permissions.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WorkOrderTaskFilterSet with multi-field filtering</name>
  <files>backend/workorder/views/work_order_tasks/task_filters.py</files>
  <action>
Create new file `backend/workorder/views/work_order_tasks/task_filters.py`:

```python
"""
施工单任务过滤器
使用 DjangoFilterBackend 实现高级筛选功能
"""
from django_filters import FilterSet, NumberFilter, CharFilter
from django.db.models import Q

class WorkOrderTaskFilterSet(FilterSet):
    """
    施工单任务筛选器

    支持按以下维度筛选：
    - 状态 (status)
    - 任务类型 (task_type)
    - 分派部门 (assigned_department)
    - 分派操作员 (assigned_operator)
    - 工序 (work_order_process)
    - 施工单号 (work_order_number) - 自定义筛选
    - 任务内容 (work_content) - 模糊搜索
    - 部门名称 (department_name) - 模糊搜索
    """

    # 精确匹配字段
    status = CharFilter(field_name='status')
    task_type = CharFilter(field_name='task_type')
    assigned_department = NumberFilter(field_name='assigned_department')
    assigned_operator = NumberFilter(field_name='assigned_operator')
    work_order_process = NumberFilter(field_name='work_order_process')

    # 自定义筛选：按施工单号搜索
    work_order_number = CharFilter(method='filter_work_order_number')

    # 自定义筛选：按任务内容模糊搜索（与 search_fields 配合）
    work_content = CharFilter(field_name='work_content', lookup_expr='icontains')

    # 自定义筛选：按部门名称搜索
    department_name = CharFilter(field_name='assigned_department__name', lookup_expr='icontains')

    # 自定义筛选：按操作员姓名搜索
    operator_name = CharFilter(method='filter_operator_name')

    # 自定义筛选：草稿任务
    is_draft = CharFilter(method='filter_is_draft')

    class Meta:
        model = WorkOrderTask
        fields = [
            'status', 'task_type', 'assigned_department',
            'assigned_operator', 'work_order_process',
            'work_order_number', 'work_content', 'department_name'
        ]

    def filter_work_order_number(self, queryset, name, value):
        """按施工单号搜索"""
        if not value:
            return queryset
        return queryset.filter(
            work_order_process__work_order__order_number__icontains=value
        )

    def filter_operator_name(self, queryset, name, value):
        """按操作员姓名搜索"""
        if not value:
            return queryset
        return queryset.filter(
            Q(assigned_operator__first_name__icontains=value) |
            Q(assigned_operator__last_name__icontains=value) |
            Q(assigned_operator__username__icontains=value)
        )

    def filter_is_draft(self, queryset, name, value):
        """筛选草稿/正式任务"""
        if value == 'true':
            return queryset.filter(status='draft')
        elif value == 'false':
            return queryset.filter(status__in=['pending', 'in_progress', 'completed', 'cancelled'])
        return queryset
```

Import WorkOrderTask at top of file after imports block.
Use exact same filter patterns as existing TaskList.vue frontend filters.
Add work_order_number filter to support searching by order number.
  </action>
  <verify>
File exists at backend/workorder/views/work_order_tasks/task_filters.py with:
- WorkOrderTaskFilterSet class defined
- All filter methods present (filter_work_order_number, filter_operator_name, filter_is_draft)
- Meta model = WorkOrderTask
  </verify>
  <done>
WorkOrderTaskFilterSet created with all required filters for multi-field task filtering.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate FilterSet into BaseWorkOrderTaskViewSet</name>
  <files>backend/workorder/views/work_order_tasks/task_main.py</files>
  <action>
Modify `backend/workorder/views/work_order_tasks/task_main.py`:

1. Add import at top after existing imports:
```python
from .task_filters import WorkOrderTaskFilterSet
```

2. Update the filter_backends line (around line 53) to ensure DjangoFilterBackend is first:
```python
filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
```

3. Add filterset_class after filter_backends:
```python
filterset_class = WorkOrderTaskFilterSet
```

4. Expand search_fields to include work order number (around line 54):
```python
search_fields = ['work_content', 'production_requirements', 'work_order_process__work_order__order_number']
```

5. Verify get_queryset() already has proper permission filtering (lines 58-90) - NO CHANGES NEEDED here as it already implements:
   - Superuser sees all
   - Operators see only assigned_operator=user
   - Supervisors see department tasks or own created work orders

6. Update ordering_fields to include more sortable fields (around line 55):
```python
ordering_fields = [
    'created_at', 'updated_at', 'assigned_department', 'assigned_operator',
    'status', 'task_type', 'production_quantity', 'quantity_completed'
]
```

DO NOT modify the existing get_queryset() permission logic - it already correctly implements VIS-01 and VIS-05 requirements.
  </action>
  <verify>
- Import statement for WorkOrderTaskFilterSet exists
- filterset_class = WorkOrderTaskFilterSet is set
- search_fields includes work_order number
- ordering_fields includes additional fields
- get_queryset() unchanged (permission logic intact)
  </verify>
  <done>
BaseWorkOrderTaskViewSet now supports multi-field filtering via WorkOrderTaskFilterSet with search across work order numbers.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add frontend API filter parameter support</name>
  <files>frontend/src/api/modules/workorder-task.js</files>
  <action>
The workorder-task.js API module already inherits getList from BaseAPI which passes all params to the backend.
Verify the existing implementation and add a convenience method for filtered queries if needed.

Read the file and confirm:
1. WorkOrderTaskAPI extends BaseAPI
2. getList() method exists (inherited from BaseAPI)
3. getList accepts params object and passes to backend

If getList needs enhancement, add explicit support for filter parameters:

```javascript
/**
 * 获取任务列表（带高级筛选）
 * @param {Object} params - 筛选参数
 * @param {number} params.page - 页码
 * @param {number} params.page_size - 每页数量
 * @param {string} params.search - 搜索关键词
 * @param {string} params.status - 任务状态
 * @param {string} params.task_type - 任务类型
 * @param {number} params.assigned_department - 分派部门ID
 * @param {number} params.assigned_operator - 分派操作员ID
 * @param {number} params.work_order_process - 工序ID
 * @param {string} params.work_order_number - 施工单号
 * @param {string} params.is_draft - 是否草稿任务
 * @param {string} params.ordering - 排序字段
 * @returns {Promise} API响应
 */
getList(params = {}) {
  return this.request({
    url: this.baseUrl,
    method: 'get',
    params
  })
}
```

If this method already exists or is inherited properly, no changes needed.
Just verify the method is present and correctly documented.
  </action>
  <verify>
- workorder-task.js has getList method that accepts filter params
- Method documentation includes all filter parameters (status, task_type, assigned_department, etc.)
- BaseAPI inheritance is correct
  </verify>
  <done>
Frontend API module supports all filter parameters for task list queries.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Test API endpoint: GET /api/workorder-tasks/?status=pending&assigned_department=1
   - Should return only pending tasks for department 1
   - Response should include pagination metadata

2. Test search: GET /api/workorder-tasks/?search=WO2024-001
   - Should return tasks matching work order number

3. Test operator permission filtering:
   - Log in as operator (not supervisor)
   - GET /api/workorder-tasks/
   - Should only return tasks where assigned_operator = current user

4. Test supervisor permission filtering:
   - Log in as department supervisor
   - GET /api/workorder-tasks/
   - Should return department tasks + own created work order tasks

5. Test combined filters: GET /api/workorder-tasks/?status=pending&assigned_department=1&search=印刷
   - Should return filtered results matching all criteria
</verification>

<success_criteria>
1. WorkOrderTaskFilterSet created with all required filters (status, task_type, department, operator, process, work_order_number, work_content, is_draft)
2. BaseWorkOrderTaskViewSet uses filterset_class and supports multi-field filtering
3. Search functionality works across work_content and work_order number
4. Permission-based querysets correctly filter by user role (superuser, operator, supervisor)
5. Frontend API module supports passing all filter parameters
6. API returns filtered results without N+1 query issues (select_related/prefetch_related already in place)
</success_criteria>

<output>
After completion, create `.planning/phases/05-Universal-Task-Visibility/05-01-SUMMARY.md` with:
- FilterSet implementation details
- Permission filtering verification results
- API endpoint testing results
</output>
