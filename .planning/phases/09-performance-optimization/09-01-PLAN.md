---
phase: 09-performance-optimization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/workorder/models/core.py
  - backend/workorder/migrations/0XXX_add_performance_indexes.py
autonomous: true

must_haves:
  truths:
    - "Task list queries with multi-column filters complete in under 500ms"
    - "EXPLAIN query plan shows index usage instead of sequential scan"
    - "Database query count reduced by 50% for filtered task lists"
  artifacts:
    - path: "backend/workorder/models/core.py"
      provides: "WorkOrderTask model with composite indexes"
      contains: "class Meta:*indexes = [models.Index(fields="
    - path: "backend/workorder/migrations/0XXX_add_performance_indexes.py"
      provides: "Database migration creating new composite indexes"
      contains: "migrations.AddIndex"
  key_links:
    - from: "backend/workorder/views/work_order_tasks/task_main.py"
      to: "workorder.models.WorkOrderTask"
      via: "QuerySet filter operations on indexed columns"
      pattern: "WorkOrderTask.objects.filter.*assigned_department.*status"
---

<objective>
Add composite database indexes on WorkOrderTask and related models to optimize multi-column filter queries.

Purpose: Eliminate full table scans on filtered task list queries, ensuring sub-500ms response times even with 10,000+ tasks.
Output: Database migration with new composite indexes and updated model Meta.indexes configuration.
</objective>

<execution_context>
@/home/chenjiaxing/.claude/get-shit-done/workflows/execute-plan.md
@/home/chenjiaxing/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-performance-optimization/09-RESEARCH.md

# Source files to modify
@backend/workorder/models/core.py
@backend/workorder/views/work_order_tasks/task_main.py
</context>

<tasks>

<task type="auto">
  <name>Add composite database indexes to WorkOrderTask model</name>
  <files>backend/workorder/models/core.py</files>
  <action>
    In the WorkOrderTask model's Meta class (around line 1260), add the following composite indexes to the existing indexes list:

    1. For department+status+task_type filter combinations:
       ```python
       models.Index(fields=['assigned_department', 'status', 'task_type'], name='task_dept_status_type_idx'),
       ```

    2. For operator+status filter combinations:
       ```python
       models.Index(fields=['assigned_operator', 'status'], name='task_operator_status_idx'),
       ```

    3. For status+created_at time-based queries:
       ```python
       models.Index(fields=['status', 'created_at'], name='task_status_created_idx'),
       ```

    4. For work_order_process+status+task_type:
       ```python
       models.Index(fields=['work_order_process', 'status', 'task_type'], name='task_process_status_type_idx'),
       ```

    DO NOT remove any existing indexes - only add new ones.
  </action>
  <verify>grep -n "models.Index" backend/workorder/models/core.py | grep -E "task_dept_status_type_idx|task_operator_status_idx|task_status_created_idx|task_process_status_type_idx"</verify>
  <done>Composite indexes defined in WorkOrderTask.Meta.indexes</done>
</task>

<task type="auto">
  <name>Create database migration for new indexes</name>
  <files>backend/workorder/migrations/0XXX_add_performance_indexes.py</files>
  <action>
    1. Run Django makemigrations to generate the migration file:
       ```bash
       cd backend && python manage.py makemigrations workorder --name add_performance_indexes
       ```

    2. Verify the generated migration file includes AddIndex operations for all four new indexes.

    3. Apply the migration:
       ```bash
       python manage.py migrate workorder
       ```

    Note: Use the highest existing migration number + 1 as the prefix (e.g., 0XXX).
  </action>
  <verify>ls -la backend/workorder/migrations/*add_performance_indexes.py && python manage.py showmigrations workorder | tail -5</verify>
  <done>Migration file created and applied successfully</done>
</task>

<task type="auto">
  <name>Verify index usage with EXPLAIN query analysis</name>
  <files>backend/workorder/models/core.py</files>
  <action>
    Create a verification script to test that indexes are being used:

    1. Create a temporary test script backend/verify_indexes.py:
       ```python
       import os
       import django
       os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
       django.setup()

       from django.db import connection
       from workorder.models.core import WorkOrderTask

       # Test query 1: department + status + task_type
       qs1 = WorkOrderTask.objects.filter(
           assigned_department_id=1,
           status='pending',
           task_type='cutting'
       )
       sql1, params1 = qs1.query.sql_with_params()
       print("Query 1 SQL:", sql1[:200])

       # Test query 2: operator + status
       qs2 = WorkOrderTask.objects.filter(
           assigned_operator_id=1,
           status='in_progress'
       )
       sql2, params2 = qs2.query.sql_with_params()
       print("Query 2 SQL:", sql2[:200])

       # EXPLAIN query plan
       with connection.cursor() as cursor:
           cursor.execute(f"EXPLAIN {sql1}", params1)
           explain_result = cursor.fetchall()
           print("EXPLAIN result for query 1:", explain_result)

       print("Index verification complete!")
       ```

    2. Run the script: python backend/verify_indexes.py

    3. Delete the temporary script after verification.

    4. Document the results in a comment at the top of core.py.
  </action>
  <verify>grep -n "Performance indexes verified" backend/workorder/models/core.py</verify>
  <done>Index usage verified with EXPLAIN showing index scans</done>
</task>

</tasks>

<verification>
1. All four composite indexes exist in WorkOrderTask.Meta.indexes
2. Migration file created and applied (check with showmigrations)
3. EXPLAIN output shows index usage instead of sequential scans
4. No existing indexes were removed or broken
</verification>

<success_criteria>
- Composite indexes on (assigned_department, status, task_type) and (assigned_operator, status) exist
- Database migration applied successfully
- EXPLAIN query plan shows index usage for filtered queries
- Filtered task list queries complete in under 500ms
</success_criteria>

<output>
After completion, create `.planning/phases/09-performance-optimization/09-01-SUMMARY.md`
</output>
