# 施工单任务生成规则分析

## 一、任务生成规则概述

系统为每个工序定义了 `task_generation_rule`（任务生成规则），用于控制在创建施工单工序时如何自动生成任务。

### 规则类型

系统支持 **5种任务生成规则**：

| 规则值 | 规则名称 | 说明 | 默认值 |
|--------|---------|------|--------|
| `artwork` | 按图稿生成任务 | 每个图稿一个任务，数量为1 | - |
| `die` | 按刀模生成任务 | 每个刀模一个任务，数量为1 | - |
| `product` | 按产品生成任务 | 每个产品一个任务 | - |
| `material` | 按物料生成任务 | 每个物料一个任务 | - |
| `general` | 生成通用任务 | 一个工序一个任务 | ✅ 默认 |

## 二、各规则详细说明

### 1. artwork（按图稿生成任务）

**适用工序：** 制版、印刷等与图稿相关的工序

**生成逻辑：**

#### 1.1 制版/设计工序

根据施工单的 `artwork_type`（图稿类型）生成任务：

**情况A：需要图稿且已选择图稿**
- 为每个选中的图稿生成一个制版任务
- 任务内容：`制版：{图稿编码} - {图稿名称}`
- 任务类型：`artwork`
- 关联图稿：选中的图稿对象
- 生产数量：1（固定）
- 自动计算数量：否

**情况B：需要图稿但未选择图稿**
- 生成一个设计图稿任务
- 任务内容：`为{施工单号}设计图稿`
- 任务类型：`artwork`
- 关联图稿：None（设计时还没有图稿）
- 生产数量：1（固定）
- 自动计算数量：否
- **特殊处理**：完成任务时需要选择图稿

**情况C：不需要图稿**
- 不生成任何任务

#### 1.2 其他工序（如印刷）

- 为每个选中的图稿生成一个印刷任务
- 任务内容：`印刷：{图稿编码} - {图稿名称}`
- 任务类型：`artwork`
- 关联图稿：选中的图稿对象
- 生产数量：1（固定）
- 自动计算数量：否

**示例：**
```
施工单有2个图稿（面版、底版）
→ 生成2个制版任务
→ 生成2个印刷任务
```

### 2. die（按刀模生成任务）

**适用工序：** 模切等与刀模相关的工序

**生成逻辑：**

根据施工单的 `die_type`（刀模类型）生成任务：

**情况A：需要刀模且已选择刀模**
- 为每个选中的刀模生成一个模切任务
- 任务内容：`模切：{刀模编码} - {刀模名称}`
- 任务类型：`die`
- 关联刀模：选中的刀模对象
- 生产数量：1（固定）
- 自动计算数量：否

**情况B：需要刀模但未选择刀模**
- 生成一个设计刀模任务
- 任务内容：`为{施工单号}设计刀模`
- 任务类型：`die`
- 关联刀模：None（设计时还没有刀模）
- 生产数量：1（固定）
- 自动计算数量：否
- **特殊处理**：完成任务时需要选择刀模

**情况C：不需要刀模**
- 不生成任何任务

**示例：**
```
施工单有1个刀模
→ 生成1个模切任务
```

### 3. product（按产品生成任务）

**适用工序：** 包装等与产品相关的工序

**生成逻辑：**

- 为施工单中的每个产品生成一个任务
- 任务内容：`包装：{产品名称}`
- 任务类型：`product`
- 关联产品：产品对象
- 生产数量：产品数量（从 `WorkOrderProduct.quantity` 获取）
- 自动计算数量：是

**示例：**
```
施工单有3个产品（产品A: 100件, 产品B: 200件, 产品C: 50件）
→ 生成3个包装任务
  - 任务1：包装：产品A，数量=100
  - 任务2：包装：产品B，数量=200
  - 任务3：包装：产品C，数量=50
```

### 4. material（按物料生成任务）

**适用工序：** 采购、开料、裁切等与物料相关的工序

**生成逻辑：**

根据工序名称进行不同的处理：

#### 4.1 采购工序

- 为施工单中的**所有物料**生成采购任务
- 任务内容：`采购：{物料名称}`
- 任务类型：`material`
- 关联物料：物料对象
- 生产数量：从物料用量字符串解析（如"1000张" → 1000）
- 自动计算数量：是

#### 4.2 开料/裁切工序

- 只为**需要开料的物料**（`need_cutting=True`）生成任务
- 任务内容：`开料：{物料名称}`
- 任务类型：`material`
- 关联物料：物料对象
- 生产数量：从物料用量字符串解析
- 自动计算数量：是

#### 4.3 其他物料相关工序

- 为施工单中的**所有物料**生成任务
- 任务内容：`{工序名称}：{物料名称}`
- 任务类型：`material`
- 关联物料：物料对象
- 生产数量：从物料用量字符串解析
- 自动计算数量：是

**物料用量解析：**
- 从 `material_usage` 字段提取数字（支持整数和小数）
- 例如："1000张" → 1000，"50.5平方米" → 50

**示例：**
```
施工单有3个物料：
  - 物料A：1000张，need_cutting=True
  - 物料B：500张，need_cutting=False
  - 物料C：200张，need_cutting=True

采购工序（material规则）：
→ 生成3个采购任务（所有物料）

开料工序（material规则）：
→ 生成2个开料任务（只包含物料A和物料C）
```

### 5. general（生成通用任务）

**适用工序：** 裱坑、打钉、过油、覆膜等其他通用工序

**生成逻辑：**

#### 5.1 制版/设计工序（特殊处理）

即使规则是 `general`，如果工序名称包含"制版"或"设计"，也会根据 `artwork_type` 生成任务（逻辑同 `artwork` 规则）。

#### 5.2 模切工序（特殊处理）

即使规则是 `general`，如果工序名称包含"模切"，也会根据 `die_type` 生成任务（逻辑同 `die` 规则）。

#### 5.3 其他通用工序

- 生成一个通用任务
- 任务内容：`{工序名称}：{施工单号}`
- 任务类型：`general`
- 关联对象：无
- 生产数量：施工单的生产数量（`work_order.production_quantity`）
- 自动计算数量：是

**示例：**
```
施工单生产数量：1000车

过油工序（general规则）：
→ 生成1个任务：过油：WO20240101001，数量=1000

打钉工序（general规则）：
→ 生成1个任务：打钉：WO20240101001，数量=1000
```

## 三、任务生成时机

任务在以下时机自动生成：

1. **工序开始时**：调用 `WorkOrderProcess.generate_tasks()` 方法
2. **条件检查**：如果工序已有任务，不会重复生成

## 四、任务完成判断

不同规则的任务完成判断逻辑不同：

### artwork 规则

**制版工序：**
- 所有图稿任务必须完成
- 所有图稿必须已确认（`artwork.confirmed = True`）

**其他工序（如印刷）：**
- 所有图稿任务必须完成

### die 规则

- 所有刀模任务必须完成

### product 规则

- 所有产品任务必须完成

### material 规则

**采购工序：**
- 所有物料任务必须完成
- 物料采购状态必须为"已完成"（`purchase_status = 'completed'`）

**开料工序：**
- 所有开料任务必须完成
- 物料必须有开料日期（`cut_date` 不为空）

**其他物料工序：**
- 所有物料任务必须完成

### general 规则

- 通用任务必须完成

## 五、当前系统使用情况

### 预设工序的任务生成规则

所有21个预设工序都使用 `general` 规则：

| 工序编码 | 工序名称 | 任务生成规则 |
|---------|---------|------------|
| CTP | 制版 | general（但会根据artwork_type特殊处理） |
| CUT | 开料 | general |
| PRT | 印刷 | general |
| VAN | 过油 | general |
| LAM_G | 覆光膜 | general |
| LAM_M | 覆哑膜 | general |
| UV | UV | general |
| FOIL_G | 烫金 | general |
| FOIL_S | 烫银 | general |
| EMB | 压凸 | general |
| TEX | 压纹 | general |
| SCORE | 压线 | general |
| DIE | 模切 | general（但会根据die_type特殊处理） |
| TRIM | 切成品 | general |
| LAM_B | 对裱 | general |
| MOUNT | 裱坑 | general |
| GLUE | 粘胶 | general |
| BOX | 粘盒 | general |
| WINDOW | 粘窗口 | general |
| STAPLE | 打钉 | general |
| PACK | 包装 | general |

### 特殊处理逻辑

即使使用 `general` 规则，系统也会根据工序名称进行特殊处理：

1. **制版/设计工序**：自动根据 `artwork_type` 生成图稿任务
2. **模切工序**：自动根据 `die_type` 生成刀模任务

这意味着：
- 制版工序（CTP）虽然规则是 `general`，但实际会按 `artwork` 规则生成任务
- 模切工序（DIE）虽然规则是 `general`，但实际会按 `die` 规则生成任务

## 六、任务生成流程图

```
开始工序
  ↓
检查是否已有任务？
  ├─ 是 → 跳过生成
  └─ 否 → 继续
  ↓
获取工序的 task_generation_rule
  ↓
根据规则生成任务：
  ├─ artwork → 按图稿生成
  │   ├─ 制版/设计 → 根据artwork_type处理
  │   └─ 其他 → 为每个图稿生成任务
  │
  ├─ die → 按刀模生成
  │   └─ 根据die_type处理
  │
  ├─ product → 按产品生成
  │   └─ 为每个产品生成任务
  │
  ├─ material → 按物料生成
  │   ├─ 采购 → 所有物料
  │   ├─ 开料/裁切 → 只包含need_cutting=True的物料
  │   └─ 其他 → 所有物料
  │
  └─ general → 生成通用任务
      ├─ 制版/设计 → 根据artwork_type处理（特殊）
      ├─ 模切 → 根据die_type处理（特殊）
      └─ 其他 → 生成一个通用任务
```

## 七、使用建议

### 1. 如何选择合适的规则？

| 工序类型 | 推荐规则 | 说明 |
|---------|---------|------|
| 制版、印刷 | `artwork` | 需要为每个图稿单独处理 |
| 模切 | `die` | 需要为每个刀模单独处理 |
| 包装 | `product` | 需要为每个产品单独包装 |
| 采购、开料 | `material` | 需要为每个物料单独处理 |
| 其他通用工序 | `general` | 一个工序一个任务即可 |

### 2. 当前预设工序的规则设置

所有预设工序都使用 `general` 规则，但系统会根据工序名称自动识别：
- 制版工序（名称包含"制版"或"设计"）→ 自动按图稿生成
- 模切工序（名称包含"模切"）→ 自动按刀模生成

**优点：**
- 简化配置，不需要为每个工序单独设置规则
- 通过工序名称自动识别，更灵活

**缺点：**
- 依赖工序名称，如果名称不规范可能无法正确识别
- 不够明确，需要查看代码才能知道实际生成逻辑

### 3. 建议优化

可以考虑为以下工序设置明确的规则：

- **制版（CTP）**：改为 `artwork` 规则
- **模切（DIE）**：改为 `die` 规则
- **包装（PACK）**：改为 `product` 规则
- **开料（CUT）**：改为 `material` 规则

这样可以：
- 使规则更明确
- 减少对工序名称的依赖
- 提高代码可维护性

## 八、任务类型说明

生成的任务有以下类型：

| 任务类型 | 说明 | 关联对象 |
|---------|------|---------|
| `artwork` | 图稿任务 | artwork（图稿对象） |
| `die` | 刀模任务 | die（刀模对象） |
| `product` | 产品任务 | product（产品对象） |
| `material` | 物料任务 | material（物料对象） |
| `general` | 通用任务 | 无 |

## 九、自动计算数量

任务的 `auto_calculate_quantity` 字段控制数量是否自动计算：

- **False**：数量固定，不会自动更新（图稿、刀模任务）
- **True**：数量会根据关联对象自动更新（产品、物料、通用任务）

## 十、实际使用示例

### 示例1：印刷施工单（有图稿）

**施工单信息：**
- 施工单号：WO20240101001
- 图稿：2个（面版、底版）
- 产品：1个（纸卡，1000件）

**工序和任务生成：**

1. **制版工序（CTP，general规则）**
   - 检测到工序名称包含"制版"
   - 自动按 `artwork` 规则处理
   - 生成2个任务：
     - 任务1：制版：ART001-V1 - 面版，数量=1
     - 任务2：制版：ART002-V1 - 底版，数量=1

2. **印刷工序（PRT，general规则）**
   - 检测到工序名称包含"印刷"
   - 自动按 `artwork` 规则处理
   - 生成2个任务：
     - 任务1：印刷：ART001-V1 - 面版，数量=1
     - 任务2：印刷：ART002-V1 - 底版，数量=1

3. **包装工序（PACK，general规则）**
   - 生成1个通用任务：
     - 任务：包装：WO20240101001，数量=1000

### 示例2：模切施工单（有刀模）

**施工单信息：**
- 施工单号：WO20240101002
- 刀模：1个（模切刀模A）
- 产品：1个（包装盒，500个）

**工序和任务生成：**

1. **模切工序（DIE，general规则）**
   - 检测到工序名称包含"模切"
   - 自动按 `die` 规则处理
   - 生成1个任务：
     - 任务：模切：DIE001 - 模切刀模A，数量=1

2. **包装工序（PACK，general规则）**
   - 生成1个通用任务：
     - 任务：包装：WO20240101002，数量=500

### 示例3：需要设计图稿的施工单

**施工单信息：**
- 施工单号：WO20240101003
- 图稿类型：需要图稿（但未选择图稿）
- 产品：1个（宣传册，2000本）

**工序和任务生成：**

1. **制版工序（CTP，general规则）**
   - 检测到需要图稿但未选择
   - 生成1个设计任务：
     - 任务：为WO20240101003设计图稿，数量=1
   - **后续**：完成任务时选择图稿，系统会关联图稿

2. **印刷工序（PRT，general规则）**
   - 由于没有图稿，不生成任务（或等待图稿确认后生成）

### 示例4：多产品包装

**施工单信息：**
- 施工单号：WO20240101004
- 产品：3个
  - 产品A：1000件
  - 产品B：500件
  - 产品C：200件

**工序和任务生成：**

1. **包装工序（PACK，general规则）**
   - 如果改为 `product` 规则，会生成3个任务：
     - 任务1：包装：产品A，数量=1000
     - 任务2：包装：产品B，数量=500
     - 任务3：包装：产品C，数量=200
   - 当前使用 `general` 规则，只生成1个任务：
     - 任务：包装：WO20240101004，数量=1700（总数量）

### 示例5：物料采购和开料

**施工单信息：**
- 施工单号：WO20240101005
- 物料：3个
  - 物料A：1000张，need_cutting=True
  - 物料B：500张，need_cutting=False
  - 物料C：200张，need_cutting=True

**工序和任务生成：**

1. **采购工序（如果使用material规则）**
   - 生成3个采购任务：
     - 任务1：采购：物料A，数量=1000
     - 任务2：采购：物料B，数量=500
     - 任务3：采购：物料C，数量=200

2. **开料工序（如果使用material规则）**
   - 只生成2个开料任务（只包含need_cutting=True的物料）：
     - 任务1：开料：物料A，数量=1000
     - 任务2：开料：物料C，数量=200

## 十一、任务完成判断详细说明

### artwork 规则任务完成

**制版工序：**
- ✅ 所有图稿任务状态为 `completed`
- ✅ 所有图稿已确认（`artwork.confirmed = True`）
- ❌ 如果图稿未确认，工序无法完成

**印刷等其他工序：**
- ✅ 所有图稿任务状态为 `completed`
- ❌ 不需要图稿确认

### die 规则任务完成

- ✅ 所有刀模任务状态为 `completed`

### product 规则任务完成

- ✅ 所有产品任务状态为 `completed`

### material 规则任务完成

**采购工序：**
- ✅ 所有物料任务状态为 `completed`
- ✅ 所有物料采购状态为 `received`（已回料）

**开料/裁切工序：**
- ✅ 所有开料任务状态为 `completed`
- ✅ 所有物料采购状态为 `cut`（已开料）

**其他物料工序：**
- ✅ 所有物料任务状态为 `completed`

### general 规则任务完成

- ✅ 通用任务状态为 `completed`

## 十二、代码实现位置

### 任务生成逻辑

**文件：** `backend/workorder/models.py`  
**类：** `WorkOrderProcess`  
**方法：** `generate_tasks()`

**调用时机：**
- 工序状态变为 `in_progress` 时自动调用
- 如果工序已有任务，不会重复生成

### 任务完成判断

**文件：** `backend/workorder/models.py`  
**类：** `WorkOrderProcess`  
**方法：** `check_and_update_status()`

**判断逻辑：**
- 根据 `task_generation_rule` 和工序名称判断
- 不同规则有不同的完成条件

## 十三、最佳实践建议

### 1. 规则选择建议

| 工序 | 当前规则 | 建议规则 | 原因 |
|------|---------|---------|------|
| 制版（CTP） | general | `artwork` | 需要为每个图稿单独制版 |
| 印刷（PRT） | general | `artwork` | 需要为每个图稿单独印刷 |
| 模切（DIE） | general | `die` | 需要为每个刀模单独模切 |
| 包装（PACK） | general | `product` | 需要为每个产品单独包装 |
| 开料（CUT） | general | `material` | 需要为每个物料单独开料 |
| 其他工序 | general | `general` | 一个工序一个任务即可 |

### 2. 工序命名规范

如果使用 `general` 规则，建议遵循以下命名规范：

- **制版相关**：名称包含"制版"或"设计"
- **模切相关**：名称包含"模切"
- **采购相关**：名称包含"采购"
- **开料相关**：名称包含"开料"或"裁切"

这样可以确保系统能正确识别并应用特殊处理逻辑。

### 3. 任务数量设置

- **图稿/刀模任务**：数量固定为1，`auto_calculate_quantity=False`
- **产品/物料任务**：数量从关联对象获取，`auto_calculate_quantity=True`
- **通用任务**：数量为施工单生产数量，`auto_calculate_quantity=True`

## 十四、总结

### 规则特点

1. **灵活性**：支持5种不同的生成规则，适应不同业务场景
2. **智能识别**：即使使用 `general` 规则，也会根据工序名称自动识别特殊处理
3. **自动生成**：在工序开始时自动生成，无需手动创建
4. **防重复**：如果已有任务，不会重复生成

### 当前实现

- 所有预设工序使用 `general` 规则
- 通过工序名称自动识别制版和模切工序
- 其他工序生成通用任务

### 适用场景

- **artwork**：需要为每个图稿单独处理的工序（制版、印刷）
- **die**：需要为每个刀模单独处理的工序（模切）
- **product**：需要为每个产品单独处理的工序（包装）
- **material**：需要为每个物料单独处理的工序（采购、开料）
- **general**：一个工序一个任务即可的通用工序

