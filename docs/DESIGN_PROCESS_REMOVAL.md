# 设计工序移除说明

**生成时间**：2025-01-28  
**业务调整**：设计和采购都不属于施工单工序

## 业务调整

根据业务需求，**设计不属于施工单中的工序**，设计任务通过其他系统管理，不应归于施工单系统。

## 调整内容

### 1. 前端调整

#### 1.1 图稿选择提示信息

**文件**: `frontend/src/views/workorder/Form.vue:173-177`

**调整前**:
```
可选/必选：如果已有图稿，请选择；如果未选择，将生成设计图稿任务。可多选（如纸卡双面印刷的面版和底版）
```

**调整后**:
```
必选：请选择图稿（必选）。可多选（如纸卡双面印刷的面版和底版）
可选：如果已有图稿，请选择；如果未选择，需要手动创建设计任务（设计不属于施工单工序）。可多选（如纸卡双面印刷的面版和底版）
```

#### 1.2 刀模选择提示信息

**文件**: `frontend/src/views/workorder/Form.vue:347-351`

**调整前**:
```
可选/必选：如果已有刀模，请选择；如果未选择，将生成设计刀模任务。可多选
```

**调整后**:
```
必选：请选择刀模（必选）。可多选
可选：如果已有刀模，请选择；如果未选择，需要手动创建设计任务（设计不属于施工单工序）。可多选
```

#### 1.3 烫金版选择提示信息

**文件**: `frontend/src/views/workorder/Form.vue:378-382`

**调整前**:
```
可选/必选：如果已有烫金版，请选择；如果未选择，将生成设计任务。可多选
```

**调整后**:
```
必选：请选择烫金版（必选）。可多选
可选：如果已有烫金版，请选择；如果未选择，需要手动创建设计任务（设计不属于施工单工序）。可多选
```

#### 1.4 压凸版选择提示信息

**文件**: `frontend/src/views/workorder/Form.vue:409-413`

**调整前**:
```
可选/必选：如果已有压凸版，请选择；如果未选择，将生成设计任务。可多选
```

**调整后**:
```
必选：请选择压凸版（必选）。可多选
可选：如果已有压凸版，请选择；如果未选择，需要手动创建设计任务（设计不属于施工单工序）。可多选
```

#### 1.5 选择框占位符文本

**文件**: `frontend/src/views/workorder/Form.vue`

**调整内容**:
- 刀模选择框：`'请选择刀模（可选，如未选择将生成设计任务）'` → `'请选择刀模（可选，如未选择需手动创建设计任务）'`
- 烫金版选择框：`'请选择烫金版（可选，如未选择将生成设计任务）'` → `'请选择烫金版（可选，如未选择需手动创建设计任务）'`
- 压凸版选择框：`'请选择压凸版（可选，如未选择将生成设计任务）'` → `'请选择压凸版（可选，如未选择需手动创建设计任务）'`

### 2. 后端调整

#### 2.1 模型字段说明更新

**文件**: `backend/workorder/models.py:82-90`

**调整前**:
```python
# 版是否必选（如果为False，则版可选，未选择时生成设计任务）
artwork_required = models.BooleanField('图稿必选', default=True,
                                      help_text='如果为True，选择该工序时必须选择图稿；如果为False，图稿可选（未选择时生成设计任务）')
die_required = models.BooleanField('刀模必选', default=True,
                                  help_text='如果为True，选择该工序时必须选择刀模；如果为False，刀模可选（未选择时生成设计任务）')
foiling_plate_required = models.BooleanField('烫金版必选', default=True,
                                           help_text='如果为True，选择该工序时必须选择烫金版；如果为False，烫金版可选（未选择时生成设计任务）')
embossing_plate_required = models.BooleanField('压凸版必选', default=True,
                                              help_text='如果为True，选择该工序时必须选择压凸版；如果为False，压凸版可选（未选择时生成设计任务）')
```

**调整后**:
```python
# 版是否必选（如果为False，则版可选，但需要手动创建设计任务，因为设计不属于施工单工序）
artwork_required = models.BooleanField('图稿必选', default=True,
                                      help_text='如果为True，选择该工序时必须选择图稿；如果为False，图稿可选（但需要手动创建设计任务，设计不属于施工单工序）')
die_required = models.BooleanField('刀模必选', default=True,
                                    help_text='如果为True，选择该工序时必须选择刀模；如果为False，刀模可选（但需要手动创建设计任务，设计不属于施工单工序）')
foiling_plate_required = models.BooleanField('烫金版必选', default=True,
                                           help_text='如果为True，选择该工序时必须选择烫金版；如果为False，烫金版可选（但需要手动创建设计任务，设计不属于施工单工序）')
embossing_plate_required = models.BooleanField('压凸版必选', default=True,
                                              help_text='如果为True，选择该工序时必须选择压凸版；如果为False，压凸版可选（但需要手动创建设计任务，设计不属于施工单工序）')
```

#### 2.2 设计任务处理逻辑注释更新

**文件**: `backend/workorder/views.py:576-578, 691-693`

**调整内容**:
- 在 `update_quantity` 和 `complete` 方法中，为设计任务处理逻辑添加注释
- 说明设计不属于施工单工序，设计任务通过其他系统管理
- 说明现有逻辑用于兼容可能已存在的设计任务（手动创建或历史数据）

**调整后**:
```python
# 处理设计图稿/设计刀模任务
# 注意：设计不属于施工单工序，设计任务通过其他系统管理
# 以下逻辑用于兼容可能已存在的设计任务（手动创建或历史数据）
is_design_task = '设计图稿' in task.work_content or '更新图稿' in task.work_content
is_die_design_task = '设计刀模' in task.work_content or '更新刀模' in task.work_content
```

## 业务逻辑说明

### 设计和采购的管理方式

- **设计任务通过其他系统管理**：设计任务不属于施工单工序，应由独立的设计系统或模块管理
- **采购任务通过其他系统管理**：采购任务不属于施工单工序，应由独立的采购系统或模块管理
- **施工单系统**：只管理施工单相关的工序和任务（制版、印刷、模切、开料、包装等）

### 版选择逻辑

1. **如果版是必选的**（`artwork_required=True` 等）：
   - 用户必须选择版
   - 提示信息："请选择图稿（必选）"

2. **如果版是可选的**（`artwork_required=False` 等）：
   - 用户可以选择已有版，或手动创建设计任务
   - 提示信息："如果已有图稿，请选择；如果未选择，需要手动创建设计任务（设计不属于施工单工序）"
   - **系统不会自动生成设计任务**，因为设计不属于施工单工序

### 任务生成逻辑

当前 `WorkOrderProcess.generate_tasks()` 方法：
- 只为**已选择的版**生成任务
- **不会**为未选择的版生成设计任务
- 这与业务逻辑一致：设计不属于施工单工序

## 影响范围

### 不受影响的功能

1. ✅ 版选择功能（图稿、刀模、烫金版、压凸版）
2. ✅ 版必选/可选配置（`artwork_required` 等字段）
3. ✅ 制版工序和制版任务（为已选择的版生成任务）
4. ✅ 印刷、模切、烫金、压凸等工序和任务
5. ✅ 设计任务更新逻辑（兼容已存在的设计任务）

### 已调整的内容

1. ✅ 前端提示信息：明确说明需要手动创建设计任务
2. ✅ 模型字段说明：与实际逻辑保持一致
3. ✅ 后端注释：说明设计不属于施工单工序

## 与采购工序移除的对比

| 项目 | 采购工序 | 设计工序 |
|------|---------|---------|
| **是否属于施工单工序** | ❌ 不属于 | ❌ 不属于 |
| **任务管理方式** | 通过其他系统管理 | 通过其他系统管理 |
| **前端提示信息** | 已移除相关提示 | ✅ 已更新，说明需要手动创建 |
| **后端逻辑** | 已移除相关判断 | ✅ 保留兼容逻辑（用于历史数据） |
| **模型字段说明** | 无相关字段 | ✅ 已更新 help_text |

## 后续开发建议

如果将来需要实现设计任务系统，建议：

1. **独立的设计模块**：创建独立的设计管理模块，不依赖于施工单工序系统
2. **设计任务模型**：创建独立的设计任务模型，与施工单任务（`WorkOrderTask`）分离
3. **关联关系**：设计任务可以关联到施工单（通过 `work_order` 外键），但不作为施工单的工序
4. **版记录创建**：设计任务完成后，可以创建对应的版记录（`Artwork`、`Die` 等），并关联到施工单

## 测试建议

1. **测试版选择功能**：确保图稿、刀模、烫金版、压凸版的选择功能正常
2. **测试提示信息**：确保提示信息正确显示（必选/可选）
3. **测试任务生成**：确保只为已选择的版生成任务
4. **测试设计任务更新**：确保已存在的设计任务可以正常更新（兼容历史数据）

## 相关文档

- `docs/PLATE_SELECTION_DESIGN_TASK_ANALYSIS.md`：版选择与设计任务生成逻辑分析
- `docs/PURCHASE_PROCESS_REMOVAL.md`：采购工序移除说明
